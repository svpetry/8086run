(()=>{"use strict";class e{constructor(e){Object.defineProperty(this,"extRamStart",{enumerable:!0,configurable:!0,writable:!0,value:65536}),Object.defineProperty(this,"memoryMappings",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"readMappings",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"writeMappings",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"ram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extRam",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extRamLimit",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"supportRead",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"supportWrite",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e>1024?e-1024:0;this.ram=new Uint8Array(1024*Math.min(e,640)),this.extRam=new Uint8Array(1024*t),this.extRamLimit=this.extRamStart+t}peek(e){if(e<this.ram.length)return this.ram[e];if(e>=this.extRamStart&&e<this.extRamLimit)return this.extRam[e-this.extRamStart];for(let t=0;t<this.readMappings.length;t++){const r=this.readMappings[t];if(r.addrLo<=e&&r.addrHi>=e)return r.provider.peek(e)}return 0}poke(e,t){if(e<this.ram.length)this.ram[e]=255&t;else if(e>=this.extRamStart&&e<this.extRamLimit)this.extRam[e-this.extRamStart]=255&t;else for(let r=0;r<this.readMappings.length;r++){const i=this.readMappings[r];if(i.addrLo<=e&&i.addrHi>=e)return void i.provider.poke(e,255&t)}}peekW(e){if(e<this.ram.length-1)return this.ram[e]+(this.ram[e+1]<<8);if(e>=this.extRamStart&&e<this.extRamLimit){const t=e-this.extRamStart;return this.extRam[t]+(this.extRam[t+1]<<8)}for(let t=0;t<this.readMappings.length;t++){const r=this.readMappings[t];if(r.addrLo<=e&&r.addrHi>=e)return r.provider.peek(e)+(r.provider.peek(e+1)<<8)}return 0}pokeW(e,t){if(e<this.ram.length-1)return this.ram[e]=255&t,void(this.ram[e+1]=t>>8&255);if(e>=this.extRamStart&&e<this.extRamLimit){const r=e-this.extRamStart;this.extRam[r]=255&t,this.extRam[r+1]=t>>8&255}for(let r=0;r<this.readMappings.length;r++){const i=this.readMappings[r];if(i.addrLo<=e&&i.addrHi>=e)return i.provider.poke(e,255&t),void i.provider.poke(e+1,t>>8&255)}}peekD(e){if(e<this.ram.length-1)return this.ram[e]+(this.ram[e+1]<<8)+(this.ram[e+2]<<16)+(this.ram[e+3]<<24);if(e>=this.extRamStart&&e<this.extRamLimit){const t=e-this.extRamStart;return this.extRam[t]+(this.extRam[t+1]<<8)+(this.extRam[t+2]<<16)+(this.extRam[t+3]<<24)}for(let t=0;t<this.readMappings.length;t++){const r=this.readMappings[t];if(r.addrLo<=e&&r.addrHi>=e)return r.provider.peek(e)+(r.provider.peek(e+1)<<8)+(r.provider.peek(e+2)<<16)+(r.provider.peek(e+3)<<24)}return 0}pokeD(e,t){if(e<this.ram.length-1)return this.ram[e]=255&t,this.ram[e+1]=t>>8&255,this.ram[e+2]=t>>16&255,void(this.ram[e+3]=t>>24&255);if(e>=this.extRamStart&&e<this.extRamLimit){const r=e-this.extRamStart;this.extRam[r]=255&t,this.extRam[r+1]=t>>8&255,this.extRam[r+2]=t>>16&255,this.extRam[r+3]=t>>24&255}for(let r=0;r<this.readMappings.length;r++){const i=this.readMappings[r];if(i.addrLo<=e&&i.addrHi>=e)return i.provider.poke(e,255&t),i.provider.poke(e+1,t>>8&255),i.provider.poke(e+2,t>>16&255),void i.provider.poke(e+3,t>>24&255)}}register(e,t,r){this.memoryMappings.push({addrLo:e,addrHi:t,provider:r,supportRead:r.supportRead,supportWrite:r.supportWrite})}FinishRegistration(){for(const e of this.memoryMappings)e.supportRead&&this.readMappings.push(e),e.supportWrite&&this.writeMappings.push(e)}}class t{constructor(){Object.defineProperty(this,"portMappings",{enumerable:!0,configurable:!0,writable:!0,value:new Array})}in(e){for(let t=0;t<this.portMappings.length;t++){const r=this.portMappings[t];if(r.portLo<=e&&r.portHi>=e)return 65535&r.provider.in(e)}return 65535}out(e,t,r){for(let i=0;i<this.portMappings.length;i++){const s=this.portMappings[i];if(s.portLo<=e&&s.portHi>=e)return void s.provider.out(e,t,r)}}register(e,t,r){this.portMappings.push({provider:r,portLo:e,portHi:t})}}var r,i,s,a,n,o,h,c,l,d,u,b,m,g;!function(e){e.Cpu186="Cpu186",e.Cpu386="Cpu386"}(r||(r={})),function(e){e[e.RegToRm=0]="RegToRm",e[e.RmToReg=1]="RmToReg"}(i||(i={})),function(e){e[e.None=0]="None",e[e.RepZ=1]="RepZ",e[e.RepNz=2]="RepNz"}(s||(s={})),function(e){e[e.Real=0]="Real",e[e.Protected=1]="Protected",e[e.Virtual8086=2]="Virtual8086"}(a||(a={})),function(e){e[e.Read=0]="Read",e[e.Write=1]="Write"}(n||(n={})),function(e){e[e.DE=0]="DE",e[e.DB=1]="DB",e[e.BP=3]="BP",e[e.OF=4]="OF",e[e.BR=5]="BR",e[e.UD=6]="UD",e[e.NM=7]="NM",e[e.DF=8]="DF",e[e.TS=10]="TS",e[e.NP=11]="NP",e[e.SS=12]="SS",e[e.GP=13]="GP",e[e.PF=14]="PF",e[e.MF=16]="MF",e[e.AC=17]="AC",e[e.MC=18]="MC",e[e.XF=19]="XF",e[e.VE=20]="VE",e[e.SX=30]="SX"}(o||(o={}));class f{constructor(e,t=null){Object.defineProperty(this,"exCode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"errorCode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exCode=e,this.errorCode=t}}class p{constructor(){Object.defineProperty(this,"eventTimer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"doCpuInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}reset(){}}!function(e){e[e.Demand=0]="Demand",e[e.Single=1]="Single",e[e.Block=2]="Block",e[e.Cascade=3]="Cascade"}(h||(h={})),function(e){e[e.Inc=0]="Inc",e[e.Dec=1]="Dec"}(c||(c={})),function(e){e[e.Verify=0]="Verify",e[e.WriteMem=1]="WriteMem",e[e.ReadMem=2]="ReadMem",e[e.Undefined=3]="Undefined"}(l||(l={}));class y extends p{constructor(e,t){super(),Object.defineProperty(this,"channelCount",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"memRefreshChannel",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"memoryProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkMemRefreshActiveFunc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockSize",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"blockSizeByteNo",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"page",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"offsetByteNo",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"inc",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"autoInit",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"transferType",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"channelEnabled",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),Object.defineProperty(this,"terminalCount",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.channelCount)}),this.memoryProvider=e,this.checkMemRefreshActiveFunc=t;for(let e=0;e<this.channelCount;e++)this.channelEnabled[e]=!0}readByte(e,t,r){let i;return i=0==t[r]?255&e[r]:(65280&e[r])>>8&255,t[r]=1-t[r],i}writeByte(e,t,r,i){0==t[r]?e[r]=65535&(65280&e[r]|i):e[r]=65535&(255&e[r]|i<<8),t[r]=1-t[r]}memRefreshActive(){return this.autoInit[this.memRefreshChannel]&&this.checkMemRefreshActiveFunc()}in(e){if(e>=0&&e<=7){const t=Math.trunc(e/2);return e%2==0?(t==this.memRefreshChannel&&this.memRefreshActive()&&(this.offset[t]+=17),this.readByte(this.offset,this.offsetByteNo,t)):this.readByte(this.blockSize,this.blockSizeByteNo,t)}if(e>=192&&e<=207){const t=4+Math.trunc((e-192)/4);if(e%4==0)return this.readByte(this.offset,this.offsetByteNo,t);if(e%4==2)return this.readByte(this.blockSize,this.blockSizeByteNo,t)}return 8==e?(this.memRefreshActive()&&(this.terminalCount[this.memRefreshChannel]=!0),255&((this.terminalCount[0]?1:0)|(this.terminalCount[1]?2:0)|(this.terminalCount[2]?4:0)|(this.terminalCount[3]?8:0))):0}out(e,t,r){if(e>=0&&e<=7){const r=Math.trunc(e/2);return e%2==0?this.writeByte(this.offset,this.offsetByteNo,r,t):this.writeByte(this.blockSize,this.blockSizeByteNo,r,t),void(this.terminalCount[r]=!1)}if(e>=192&&e<=207){const r=4+Math.trunc((e-192)/4);return e%4==0?this.writeByte(this.offset,this.offsetByteNo,r,t):e%4==2&&this.writeByte(this.blockSize,this.blockSizeByteNo,r,t),void(this.terminalCount[r]=!1)}switch(e){case 135:this.page[0]=255&t;break;case 131:this.page[1]=255&t;break;case 129:this.page[2]=255&t;break;case 130:this.page[3]=255&t;break;case 143:this.page[4]=255&t;break;case 139:this.page[5]=255&t;break;case 137:this.page[6]=255&t;break;case 138:this.page[7]=255&t;break;case 8:case 9:case 14:case 15:break;case 10:{const e=3&t;this.channelEnabled[e]=0==(4&t)}break;case 11:{const e=3&t;switch(t>>2&3){case 0:this.transferType[e]=l.Verify;break;case 1:this.transferType[e]=l.WriteMem;break;case 2:this.transferType[e]=l.ReadMem;break;case 3:this.transferType[e]=l.Undefined}switch(this.autoInit[e]=(16&t)>0,this.inc[e]=(32&t)>0?c.Dec:c.Inc,t>>6&3){case 0:this.mode[e]=h.Demand;break;case 1:this.mode[e]=h.Single;break;case 2:this.mode[e]=h.Block;break;case 3:this.mode[e]=h.Cascade}this.terminalCount[e]=!1}break;case 12:for(let e=0;e<this.channelCount;e++)this.blockSizeByteNo[e]=0,this.offsetByteNo[e]=0;break;case 13:for(let e=0;e<this.channelCount;e++)this.blockSize[e]=0,this.blockSizeByteNo[e]=0,this.page[e]=0,this.offset[e]=0,this.offsetByteNo[e]=0,this.mode[e]=0,this.inc[e]=c.Inc,this.autoInit[e]=!1,this.channelEnabled[e]=!0,this.terminalCount[e]=!1}}triggerDmaDeviceToMem(e,t,r){if(this.mode[e]==h.Single||this.mode[e]==h.Block){let i=(this.page[e]<<16)+this.offset[e],s=this.blockSize[e]+1;const a=this.inc[e]==c.Inc?1:-1,n={endOfData:!1};for(;s>0&&!n.endOfData;)this.memoryProvider.poke(i,t.getNextByte(n)),i+=a,s--;this.terminalCount[e]=!0,r&&r()}}triggerDmaMemToDevice(e,t,r){if(this.mode[e]==h.Single||this.mode[e]==h.Block){let i=(this.page[e]<<16)+this.offset[e],s=this.blockSize[e]+1;const a=this.inc[e]==c.Inc?1:-1,n={endOfData:!1};for(;s>0&&!n.endOfData;)t.setNextByte(this.memoryProvider.peek(i),n),i+=a,s--;this.terminalCount[e]=!0,r&&r()}}}!function(e){e[e.Timer=0]="Timer",e[e.Keyboard=1]="Keyboard",e[e.Reserved=2]="Reserved",e[e.Serial3=3]="Serial3",e[e.Serial4=4]="Serial4",e[e.Harddisk=5]="Harddisk",e[e.Diskette=6]="Diskette",e[e.Printer=7]="Printer"}(d||(d={}));class v extends p{constructor(){super(),Object.defineProperty(this,"defaultOffset",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"currentInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pendingInterrupts",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"intMaskReg",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"inServiceReg",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"intRequestReg",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"initCommandWords",{enumerable:!0,configurable:!0,writable:!0,value:new Array(4)}),Object.defineProperty(this,"opControlWord2",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"opControlWord3",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"initializationMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writeByteNo",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.reset()}reset(){super.reset(),this.currentInterrupt=null,this.pendingInterrupts.length=0,this.writeByteNo=1,this.intMaskReg=0,this.inServiceReg=0,this.intRequestReg=0,this.initCommandWords[1]=this.defaultOffset}in(e){switch(e){case 32:{const e=3&this.opControlWord3;if(2==e)return this.intRequestReg;if(3==e)return this.inServiceReg}break;case 33:if(!this.initializationMode)return this.intMaskReg}return 0}out(e,t,r){switch(e){case 32:if((16&t)>0)this.initializationMode=!0,this.initCommandWords[0]=255&t,this.reset();else{this.initializationMode=!1;const e=t>>3&3;if(0==e)switch(this.opControlWord2=255&t,this.opControlWord2>>5){case 1:case 3:this.endOfInterrupt()}else 1==e&&0==(128&t)&&(this.opControlWord3=255&t)}break;case 33:this.initializationMode?(this.initCommandWords[this.writeByteNo++]=255&t,(4==this.writeByteNo||3==this.writeByteNo&&0==(1&this.initCommandWords[0]))&&(3==this.writeByteNo&&(this.initCommandWords[3]=0),this.initializationMode=!1)):this.intMaskReg=255&t}}endOfInterrupt(){null!=this.currentInterrupt&&(this.inServiceReg&=255&~(1<<this.currentInterrupt),this.pendingInterrupts.length>0?this.internalDoInterrupt(this.pendingInterrupts.shift()):this.currentInterrupt=null)}internalDoInterrupt(e){const t=1<<e&255;0==(this.intMaskReg&t)&&(this.doCpuInterrupt(e+(248&this.initCommandWords[1])),this.inServiceReg|=t,this.currentInterrupt=e)}doInterrupt(e){const t=e;null==this.currentInterrupt?this.internalDoInterrupt(t):(e!=d.Timer||this.currentInterrupt!=t&&!this.pendingInterrupts.includes(t))&&this.pendingInterrupts.push(t)}}!function(e){e.MDA="MDA",e.Hercules="Hercules",e.CGA="CGA",e.EGA="EGA",e.VGA="VGA"}(u||(u={})),function(e){e.None="None",e.NotConnected="NotConnected",e.EmulatedMouse="EmulatedMouse"}(b||(b={}));class k{static get monochromeGraphics(){return this.graphicsAdapterType==u.MDA||this.graphicsAdapterType==u.Hercules}}Object.defineProperty(k,"cpuType",{enumerable:!0,configurable:!0,writable:!0,value:r.Cpu186}),Object.defineProperty(k,"cpuFrequency",{enumerable:!0,configurable:!0,writable:!0,value:4770}),Object.defineProperty(k,"ramAmount",{enumerable:!0,configurable:!0,writable:!0,value:640}),Object.defineProperty(k,"floppyCount",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(k,"graphicsAdapterType",{enumerable:!0,configurable:!0,writable:!0,value:u.CGA}),Object.defineProperty(k,"enableHdController",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(k,"enableUma",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(k,"enableRtc",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(k,"com1Device",{enumerable:!0,configurable:!0,writable:!0,value:b.EmulatedMouse}),Object.defineProperty(k,"com1PortName",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(k,"com2Device",{enumerable:!0,configurable:!0,writable:!0,value:b.None}),Object.defineProperty(k,"com2PortName",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(k,"hdImageDir",{enumerable:!0,configurable:!0,writable:!0,value:"HdImages/"}),Object.defineProperty(k,"baseDir",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(k,"noScreenUpdateWhileRetrace",{enumerable:!0,configurable:!0,writable:!0,value:!0});class w extends p{constructor(e,t){super(),Object.defineProperty(this,"emptyKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"keyDelay",{enumerable:!0,configurable:!0,writable:!0,value:500}),Object.defineProperty(this,"pic",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"currentKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_speakerEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"speakerGate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"speakerData",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kbClockLow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kbClockLowClockCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"keyEventActive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"readHighSwitches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kbRefreshToggle",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onSpeaker",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pic=e,this.onSpeaker=t}get speakerEnabled(){return this._speakerEnabled}addScanCode(e){this.kbClockLow||(this.keyEventActive?this.keyQueue.push(e):(this.keyEventActive=!0,this.keyQueue.push(e),this.eventTimer.setEvent(this.keyDelay,(()=>this.doKeyEvent()))))}in(e){switch(e){case 96:return this.currentKey;case 97:{this.kbRefreshToggle=!this.kbRefreshToggle;let e=0;return this.kbClockLow||(e|=64),this.kbRefreshToggle&&(e|=16),this.readHighSwitches&&(e|=8),this.speakerData&&(e|=2),this.speakerGate&&(e|=1),e}case 98:return this.readHighSwitches?(k.graphicsAdapterType==u.EGA||k.graphicsAdapterType==u.VGA?0:k.monochromeGraphics?3:2)+(k.floppyCount-1<<2)&65535:13;case 99:return 0}return 0}out(e,t,r){switch(e){case 96:case 98:break;case 97:{(128&t)>0&&(this.currentKey=this.emptyKey);const e=0==(64&t);e!=this.kbClockLow&&(e?this.kbClockLowClockCount=this.eventTimer.clockCount:this.eventTimer.clockCount-this.kbClockLowClockCount>=12*k.cpuFrequency&&this.eventTimer.setEvent(100,(()=>{this.keyQueue.length=0,this.addScanCode(170)})),this.kbClockLow=e),this.speakerGate=(1&t)>0,this.speakerData=(2&t)>0;const r=this.speakerGate&&this.speakerData,i=this.speakerEnabled!=r;this._speakerEnabled=r,i&&this.onSpeaker(),this.readHighSwitches=(8&t)>0}}}doKeyEvent(){this.keyQueue.length>0?(this.internalAddScanCode(this.keyQueue.shift()),this.eventTimer.setEvent(this.keyDelay,(()=>this.doKeyEvent()))):this.keyEventActive=!1}internalAddScanCode(e){this.kbClockLow||(this.currentKey=e,this.pic.doInterrupt(d.Keyboard))}}!function(e){e[e.LowNibble=0]="LowNibble",e[e.HighNibble=1]="HighNibble",e[e.LowAndHigh=2]="LowAndHigh"}(m||(m={})),function(e){e[e.M16Bit=0]="M16Bit",e[e.Bcd=1]="Bcd"}(g||(g={}));class S{constructor(e,t,r){Object.defineProperty(this,"countsPerSec",{enumerable:!0,configurable:!0,writable:!0,value:1193180}),Object.defineProperty(this,"countsPerMs",{enumerable:!0,configurable:!0,writable:!0,value:Math.trunc(this.countsPerSec/1e3)}),Object.defineProperty(this,"timer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pic",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"counterNo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"byteNo",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_accessMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isLatched",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"latchValue",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_mode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"isRunning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startValue",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"startClockCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"eventId",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"onChangeFrequency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"countMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generateTimerInt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.timer=e,this.pic=t,this.counterNo=r}get accessMode(){return this._accessMode}set accessMode(e){this._accessMode=e,this.byteNo=0}get frequency(){return Math.trunc(this.countsPerSec/this.startValue)}get mode(){return this._mode}set mode(e){switch(this._mode=e,this.eventId>0&&this.timer.eventTimer.deleteEvent(this.eventId),this.mode){case 0:case 2:case 3:break;case 1:case 4:case 5:throw new Error("Method not implemented.")}}calcValue(){if(this.isRunning){const e=Math.trunc(1e3*(this.timer.eventTimer.clockCount-this.startClockCount)/k.cpuFrequency);return this.startValue-Math.trunc(e*this.countsPerMs/1e3)&65535}return 0}writeFinished(){this.isRunning=!0,0==this.startValue&&(this.startValue=65536),3!=this.mode&&2!=this.mode&&0!=this.mode||(this.eventId>0&&this.timer.eventTimer.deleteEvent(this.eventId),this.startClockCount=this.timer.eventTimer.clockCount,this.eventId=this.timer.eventTimer.setEvent(Math.trunc(1e3*this.startValue/this.countsPerMs),(()=>this.onCountZero())),this.onChangeFrequency&&this.onChangeFrequency())}onCountZero(){switch(this.generateTimerInt&&this.pic.doInterrupt(d.Timer),this.mode){case 0:this.isRunning=!1;break;case 2:case 3:this.startClockCount=this.timer.eventTimer.clockCount,this.eventId=this.timer.eventTimer.setEvent(Math.trunc(1e3*this.startValue/this.countsPerMs),(()=>this.onCountZero()))}}reset(){this.mode=0,this.eventId=0,this.isRunning=!1,this.byteNo=0}write(e){switch(this.accessMode){case m.LowNibble:this.startValue=65535&(65280&this.startValue|e),this.writeFinished();break;case m.HighNibble:this.startValue=65535&(255&this.startValue|e<<8),this.writeFinished();break;case m.LowAndHigh:0==this.byteNo?this.startValue=65535&(65280&this.startValue|e):(this.startValue=65535&(255&this.startValue|e<<8),this.writeFinished()),this.byteNo=1-this.byteNo}}read(){let e=0;const t=this.isLatched?this.latchValue:this.calcValue();switch(this.accessMode){case m.LowNibble:e=255&t,this.isLatched=!1;break;case m.HighNibble:e=t>>8&255,this.isLatched=!1;break;case m.LowAndHigh:0==this.byteNo?e=255&t:(e=t>>8&255,this.isLatched=!1),this.byteNo=1-this.byteNo}return e}doLatch(){this.latchValue=this.calcValue(),this.isLatched=!0}}class R extends p{constructor(e,t){super(),Object.defineProperty(this,"counters",{enumerable:!0,configurable:!0,writable:!0,value:new Array(3)}),Object.defineProperty(this,"memRefreshActive",{enumerable:!0,configurable:!0,writable:!0,value:!0});for(let t=0;t<this.counters.length;t++)this.counters[t]=new S(this,e,t);this.counters[0].generateTimerInt=!0,null!=t&&(this.counters[2].onChangeFrequency=t)}get speakerFrequency(){return 3==this.counters[2].mode?this.counters[2].frequency:0}reset(){super.reset();for(const e of this.counters)e.reset()}in(e){return e>=64&&e<=66?this.counters[e-64].read():0}out(e,t,r){if(e>=64&&e<=66&&this.counters[e-64].write(255&t),67==e){const e=t>>6&3;if(e>2)return;const r=this.counters[e],i=t>>4&3,s=t>>1&7;switch(i){case 0:r.doLatch();break;case 1:r.accessMode=m.LowNibble;break;case 2:r.accessMode=m.HighNibble;break;case 3:r.accessMode=m.LowAndHigh}0!=i&&(r.countMode=(1&t)>0?g.Bcd:g.M16Bit,r.mode=s)}}}function O(e){let t=e.length;for(;--t>=0;)e[t]=0}const C=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),P=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),A=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),B=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),I=new Array(576);O(I);const D=new Array(60);O(D);const j=new Array(512);O(j);const M=new Array(256);O(M);const x=new Array(29);O(x);const _=new Array(30);function F(e,t,r,i,s){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=i,this.max_length=s,this.has_stree=e&&e.length}let N,W,$;function E(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}O(_);const L=e=>e<256?j[e]:j[256+(e>>>7)],T=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},X=(e,t,r)=>{e.bi_valid>16-r?(e.bi_buf|=t<<e.bi_valid&65535,T(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=r-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)},H=(e,t,r)=>{X(e,r[2*t],r[2*t+1])},z=(e,t)=>{let r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1},U=(e,t,r)=>{const i=new Array(16);let s,a,n=0;for(s=1;s<=15;s++)n=n+r[s-1]<<1,i[s]=n;for(a=0;a<=t;a++){let t=e[2*a+1];0!==t&&(e[2*a]=z(i[t]++,t))}},Z=e=>{let t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},G=e=>{e.bi_valid>8?T(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},V=(e,t,r,i)=>{const s=2*t,a=2*r;return e[s]<e[a]||e[s]===e[a]&&i[t]<=i[r]},J=(e,t,r)=>{const i=e.heap[r];let s=r<<1;for(;s<=e.heap_len&&(s<e.heap_len&&V(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!V(t,i,e.heap[s],e.depth));)e.heap[r]=e.heap[s],r=s,s<<=1;e.heap[r]=i},q=(e,t,r)=>{let i,s,a,n,o=0;if(0!==e.sym_next)do{i=255&e.pending_buf[e.sym_buf+o++],i+=(255&e.pending_buf[e.sym_buf+o++])<<8,s=e.pending_buf[e.sym_buf+o++],0===i?H(e,s,t):(a=M[s],H(e,a+256+1,t),n=C[a],0!==n&&(s-=x[a],X(e,s,n)),i--,a=L(i),H(e,a,r),n=P[a],0!==n&&(i-=_[a],X(e,i,n)))}while(o<e.sym_next);H(e,256,t)},K=(e,t)=>{const r=t.dyn_tree,i=t.stat_desc.static_tree,s=t.stat_desc.has_stree,a=t.stat_desc.elems;let n,o,h,c=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<a;n++)0!==r[2*n]?(e.heap[++e.heap_len]=c=n,e.depth[n]=0):r[2*n+1]=0;for(;e.heap_len<2;)h=e.heap[++e.heap_len]=c<2?++c:0,r[2*h]=1,e.depth[h]=0,e.opt_len--,s&&(e.static_len-=i[2*h+1]);for(t.max_code=c,n=e.heap_len>>1;n>=1;n--)J(e,r,n);h=a;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],J(e,r,1),o=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=o,r[2*h]=r[2*n]+r[2*o],e.depth[h]=(e.depth[n]>=e.depth[o]?e.depth[n]:e.depth[o])+1,r[2*n+1]=r[2*o+1]=h,e.heap[1]=h++,J(e,r,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const r=t.dyn_tree,i=t.max_code,s=t.stat_desc.static_tree,a=t.stat_desc.has_stree,n=t.stat_desc.extra_bits,o=t.stat_desc.extra_base,h=t.stat_desc.max_length;let c,l,d,u,b,m,g=0;for(u=0;u<=15;u++)e.bl_count[u]=0;for(r[2*e.heap[e.heap_max]+1]=0,c=e.heap_max+1;c<573;c++)l=e.heap[c],u=r[2*r[2*l+1]+1]+1,u>h&&(u=h,g++),r[2*l+1]=u,l>i||(e.bl_count[u]++,b=0,l>=o&&(b=n[l-o]),m=r[2*l],e.opt_len+=m*(u+b),a&&(e.static_len+=m*(s[2*l+1]+b)));if(0!==g){do{for(u=h-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[h]--,g-=2}while(g>0);for(u=h;0!==u;u--)for(l=e.bl_count[u];0!==l;)d=e.heap[--c],d>i||(r[2*d+1]!==u&&(e.opt_len+=(u-r[2*d+1])*r[2*d],r[2*d+1]=u),l--)}})(e,t),U(r,c,e.bl_count)},Q=(e,t,r)=>{let i,s,a=-1,n=t[1],o=0,h=7,c=4;for(0===n&&(h=138,c=3),t[2*(r+1)+1]=65535,i=0;i<=r;i++)s=n,n=t[2*(i+1)+1],++o<h&&s===n||(o<c?e.bl_tree[2*s]+=o:0!==s?(s!==a&&e.bl_tree[2*s]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,a=s,0===n?(h=138,c=3):s===n?(h=6,c=3):(h=7,c=4))},Y=(e,t,r)=>{let i,s,a=-1,n=t[1],o=0,h=7,c=4;for(0===n&&(h=138,c=3),i=0;i<=r;i++)if(s=n,n=t[2*(i+1)+1],!(++o<h&&s===n)){if(o<c)do{H(e,s,e.bl_tree)}while(0!=--o);else 0!==s?(s!==a&&(H(e,s,e.bl_tree),o--),H(e,16,e.bl_tree),X(e,o-3,2)):o<=10?(H(e,17,e.bl_tree),X(e,o-3,3)):(H(e,18,e.bl_tree),X(e,o-11,7));o=0,a=s,0===n?(h=138,c=3):s===n?(h=6,c=3):(h=7,c=4)}};let ee=!1;const te=(e,t,r,i)=>{X(e,0+(i?1:0),3),G(e),T(e,r),T(e,~r),r&&e.pending_buf.set(e.window.subarray(t,t+r),e.pending),e.pending+=r};var re={_tr_init:e=>{ee||((()=>{let e,t,r,i,s;const a=new Array(16);for(r=0,i=0;i<28;i++)for(x[i]=r,e=0;e<1<<C[i];e++)M[r++]=i;for(M[r-1]=i,s=0,i=0;i<16;i++)for(_[i]=s,e=0;e<1<<P[i];e++)j[s++]=i;for(s>>=7;i<30;i++)for(_[i]=s<<7,e=0;e<1<<P[i]-7;e++)j[256+s++]=i;for(t=0;t<=15;t++)a[t]=0;for(e=0;e<=143;)I[2*e+1]=8,e++,a[8]++;for(;e<=255;)I[2*e+1]=9,e++,a[9]++;for(;e<=279;)I[2*e+1]=7,e++,a[7]++;for(;e<=287;)I[2*e+1]=8,e++,a[8]++;for(U(I,287,a),e=0;e<30;e++)D[2*e+1]=5,D[2*e]=z(e,5);N=new F(I,C,257,286,15),W=new F(D,P,0,30,15),$=new F(new Array(0),A,0,19,7)})(),ee=!0),e.l_desc=new E(e.dyn_ltree,N),e.d_desc=new E(e.dyn_dtree,W),e.bl_desc=new E(e.bl_tree,$),e.bi_buf=0,e.bi_valid=0,Z(e)},_tr_stored_block:te,_tr_flush_block:(e,t,r,i)=>{let s,a,n=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),K(e,e.l_desc),K(e,e.d_desc),n=(e=>{let t;for(Q(e,e.dyn_ltree,e.l_desc.max_code),Q(e,e.dyn_dtree,e.d_desc.max_code),K(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*B[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),s=e.opt_len+3+7>>>3,a=e.static_len+3+7>>>3,a<=s&&(s=a)):s=a=r+5,r+4<=s&&-1!==t?te(e,t,r,i):4===e.strategy||a===s?(X(e,2+(i?1:0),3),q(e,I,D)):(X(e,4+(i?1:0),3),((e,t,r,i)=>{let s;for(X(e,t-257,5),X(e,r-1,5),X(e,i-4,4),s=0;s<i;s++)X(e,e.bl_tree[2*B[s]+1],3);Y(e,e.dyn_ltree,t-1),Y(e,e.dyn_dtree,r-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,n+1),q(e,e.dyn_ltree,e.dyn_dtree)),Z(e),i&&G(e)},_tr_tally:(e,t,r)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=r,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(M[r]+256+1)]++,e.dyn_dtree[2*L(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{X(e,2,3),H(e,256,I),(e=>{16===e.bi_valid?(T(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}},ie=(e,t,r,i)=>{let s=65535&e|0,a=e>>>16&65535|0,n=0;for(;0!==r;){n=r>2e3?2e3:r,r-=n;do{s=s+t[i++]|0,a=a+s|0}while(--n);s%=65521,a%=65521}return s|a<<16|0};const se=new Uint32Array((()=>{let e,t=[];for(var r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t})());var ae=(e,t,r,i)=>{const s=se,a=i+r;e^=-1;for(let r=i;r<a;r++)e=e>>>8^s[255&(e^t[r])];return-1^e},ne={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},oe={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:he,_tr_stored_block:ce,_tr_flush_block:le,_tr_tally:de,_tr_align:ue}=re,{Z_NO_FLUSH:be,Z_PARTIAL_FLUSH:me,Z_FULL_FLUSH:ge,Z_FINISH:fe,Z_BLOCK:pe,Z_OK:ye,Z_STREAM_END:ve,Z_STREAM_ERROR:ke,Z_DATA_ERROR:we,Z_BUF_ERROR:Se,Z_DEFAULT_COMPRESSION:Re,Z_FILTERED:Oe,Z_HUFFMAN_ONLY:Ce,Z_RLE:Pe,Z_FIXED:Ae,Z_DEFAULT_STRATEGY:Be,Z_UNKNOWN:Ie,Z_DEFLATED:De}=oe,je=258,Me=262,xe=42,_e=113,Fe=666,Ne=(e,t)=>(e.msg=ne[t],t),We=e=>2*e-(e>4?9:0),$e=e=>{let t=e.length;for(;--t>=0;)e[t]=0},Ee=e=>{let t,r,i,s=e.w_size;t=e.hash_size,i=t;do{r=e.head[--i],e.head[i]=r>=s?r-s:0}while(--t);t=s,i=t;do{r=e.prev[--i],e.prev[i]=r>=s?r-s:0}while(--t)};let Le=(e,t,r)=>(t<<e.hash_shift^r)&e.hash_mask;const Te=e=>{const t=e.state;let r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+r),e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))},Xe=(e,t)=>{le(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Te(e.strm)},He=(e,t)=>{e.pending_buf[e.pending++]=t},ze=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Ue=(e,t,r,i)=>{let s=e.avail_in;return s>i&&(s=i),0===s?0:(e.avail_in-=s,t.set(e.input.subarray(e.next_in,e.next_in+s),r),1===e.state.wrap?e.adler=ie(e.adler,t,s,r):2===e.state.wrap&&(e.adler=ae(e.adler,t,s,r)),e.next_in+=s,e.total_in+=s,s)},Ze=(e,t)=>{let r,i,s=e.max_chain_length,a=e.strstart,n=e.prev_length,o=e.nice_match;const h=e.strstart>e.w_size-Me?e.strstart-(e.w_size-Me):0,c=e.window,l=e.w_mask,d=e.prev,u=e.strstart+je;let b=c[a+n-1],m=c[a+n];e.prev_length>=e.good_match&&(s>>=2),o>e.lookahead&&(o=e.lookahead);do{if(r=t,c[r+n]===m&&c[r+n-1]===b&&c[r]===c[a]&&c[++r]===c[a+1]){a+=2,r++;do{}while(c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&a<u);if(i=je-(u-a),a=u-je,i>n){if(e.match_start=t,n=i,i>=o)break;b=c[a+n-1],m=c[a+n]}}}while((t=d[t&l])>h&&0!=--s);return n<=e.lookahead?n:e.lookahead},Ge=e=>{const t=e.w_size;let r,i,s;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Me)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),Ee(e),i+=t),0===e.strm.avail_in)break;if(r=Ue(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=r,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=Le(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=Le(e,e.ins_h,e.window[s+3-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Me&&0!==e.strm.avail_in)},Ve=(e,t)=>{let r,i,s,a=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,n=0,o=e.strm.avail_in;do{if(r=65535,s=e.bi_valid+42>>3,e.strm.avail_out<s)break;if(s=e.strm.avail_out-s,i=e.strstart-e.block_start,r>i+e.strm.avail_in&&(r=i+e.strm.avail_in),r>s&&(r=s),r<a&&(0===r&&t!==fe||t===be||r!==i+e.strm.avail_in))break;n=t===fe&&r===i+e.strm.avail_in?1:0,ce(e,0,0,n),e.pending_buf[e.pending-4]=r,e.pending_buf[e.pending-3]=r>>8,e.pending_buf[e.pending-2]=~r,e.pending_buf[e.pending-1]=~r>>8,Te(e.strm),i&&(i>r&&(i=r),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,r-=i),r&&(Ue(e.strm,e.strm.output,e.strm.next_out,r),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r)}while(0===n);return o-=e.strm.avail_in,o&&(o>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=o&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-o,e.strm.next_in),e.strstart),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),n?4:t!==be&&t!==fe&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(s=e.window_size-e.strstart,e.strm.avail_in>s&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,s+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),s>e.strm.avail_in&&(s=e.strm.avail_in),s&&(Ue(e.strm,e.window,e.strstart,s),e.strstart+=s,e.insert+=s>e.w_size-e.insert?e.w_size-e.insert:s),e.high_water<e.strstart&&(e.high_water=e.strstart),s=e.bi_valid+42>>3,s=e.pending_buf_size-s>65535?65535:e.pending_buf_size-s,a=s>e.w_size?e.w_size:s,i=e.strstart-e.block_start,(i>=a||(i||t===fe)&&t!==be&&0===e.strm.avail_in&&i<=s)&&(r=i>s?s:i,n=t===fe&&0===e.strm.avail_in&&r===i?1:0,ce(e,e.block_start,r,n),e.block_start+=r,Te(e.strm)),n?3:1)},Je=(e,t)=>{let r,i;for(;;){if(e.lookahead<Me){if(Ge(e),e.lookahead<Me&&t===be)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=Le(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-Me&&(e.match_length=Ze(e,r)),e.match_length>=3)if(i=de(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=Le(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Le(e,e.ins_h,e.window[e.strstart+1]);else i=de(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(Xe(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===fe?(Xe(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Xe(e,!1),0===e.strm.avail_out)?1:2},qe=(e,t)=>{let r,i,s;for(;;){if(e.lookahead<Me){if(Ge(e),e.lookahead<Me&&t===be)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=Le(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-Me&&(e.match_length=Ze(e,r),e.match_length<=5&&(e.strategy===Oe||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,i=de(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=Le(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(Xe(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=de(e,0,e.window[e.strstart-1]),i&&Xe(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=de(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===fe?(Xe(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Xe(e,!1),0===e.strm.avail_out)?1:2};function Ke(e,t,r,i,s){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=i,this.func=s}const Qe=[new Ke(0,0,0,0,Ve),new Ke(4,4,8,4,Je),new Ke(4,5,16,8,Je),new Ke(4,6,32,32,Je),new Ke(4,4,16,16,qe),new Ke(8,16,32,32,qe),new Ke(8,16,128,128,qe),new Ke(8,32,128,256,qe),new Ke(32,128,258,1024,qe),new Ke(32,258,258,4096,qe)];function Ye(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=De,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),$e(this.dyn_ltree),$e(this.dyn_dtree),$e(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),$e(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),$e(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const et=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==xe&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==_e&&t.status!==Fe?1:0},tt=e=>{if(et(e))return Ne(e,ke);e.total_in=e.total_out=0,e.data_type=Ie;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?xe:_e,e.adler=2===t.wrap?0:1,t.last_flush=-2,he(t),ye},rt=e=>{const t=tt(e);var r;return t===ye&&((r=e.state).window_size=2*r.w_size,$e(r.head),r.max_lazy_match=Qe[r.level].max_lazy,r.good_match=Qe[r.level].good_length,r.nice_match=Qe[r.level].nice_length,r.max_chain_length=Qe[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=2,r.match_available=0,r.ins_h=0),t},it=(e,t,r,i,s,a)=>{if(!e)return ke;let n=1;if(t===Re&&(t=6),i<0?(n=0,i=-i):i>15&&(n=2,i-=16),s<1||s>9||r!==De||i<8||i>15||t<0||t>9||a<0||a>Ae||8===i&&1!==n)return Ne(e,ke);8===i&&(i=9);const o=new Ye;return e.state=o,o.strm=e,o.status=xe,o.wrap=n,o.gzhead=null,o.w_bits=i,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=s+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+3-1)/3),o.window=new Uint8Array(2*o.w_size),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<s+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=3*(o.lit_bufsize-1),o.level=t,o.strategy=a,o.method=r,rt(e)};var st=it,at=(e,t)=>et(e)||2!==e.state.wrap?ke:(e.state.gzhead=t,ye),nt=(e,t)=>{if(et(e)||t>pe||t<0)return e?Ne(e,ke):ke;const r=e.state;if(!e.output||0!==e.avail_in&&!e.input||r.status===Fe&&t!==fe)return Ne(e,0===e.avail_out?Se:ke);const i=r.last_flush;if(r.last_flush=t,0!==r.pending){if(Te(e),0===e.avail_out)return r.last_flush=-1,ye}else if(0===e.avail_in&&We(t)<=We(i)&&t!==fe)return Ne(e,Se);if(r.status===Fe&&0!==e.avail_in)return Ne(e,Se);if(r.status===xe&&0===r.wrap&&(r.status=_e),r.status===xe){let t=De+(r.w_bits-8<<4)<<8,i=-1;if(i=r.strategy>=Ce||r.level<2?0:r.level<6?1:6===r.level?2:3,t|=i<<6,0!==r.strstart&&(t|=32),t+=31-t%31,ze(r,t),0!==r.strstart&&(ze(r,e.adler>>>16),ze(r,65535&e.adler)),e.adler=1,r.status=_e,Te(e),0!==r.pending)return r.last_flush=-1,ye}if(57===r.status)if(e.adler=0,He(r,31),He(r,139),He(r,8),r.gzhead)He(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),He(r,255&r.gzhead.time),He(r,r.gzhead.time>>8&255),He(r,r.gzhead.time>>16&255),He(r,r.gzhead.time>>24&255),He(r,9===r.level?2:r.strategy>=Ce||r.level<2?4:0),He(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(He(r,255&r.gzhead.extra.length),He(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=ae(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69;else if(He(r,0),He(r,0),He(r,0),He(r,0),He(r,0),He(r,9===r.level?2:r.strategy>=Ce||r.level<2?4:0),He(r,3),r.status=_e,Te(e),0!==r.pending)return r.last_flush=-1,ye;if(69===r.status){if(r.gzhead.extra){let t=r.pending,i=(65535&r.gzhead.extra.length)-r.gzindex;for(;r.pending+i>r.pending_buf_size;){let s=r.pending_buf_size-r.pending;if(r.pending_buf.set(r.gzhead.extra.subarray(r.gzindex,r.gzindex+s),r.pending),r.pending=r.pending_buf_size,r.gzhead.hcrc&&r.pending>t&&(e.adler=ae(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex+=s,Te(e),0!==r.pending)return r.last_flush=-1,ye;t=0,i-=s}let s=new Uint8Array(r.gzhead.extra);r.pending_buf.set(s.subarray(r.gzindex,r.gzindex+i),r.pending),r.pending+=i,r.gzhead.hcrc&&r.pending>t&&(e.adler=ae(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex=0}r.status=73}if(73===r.status){if(r.gzhead.name){let t,i=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>i&&(e.adler=ae(e.adler,r.pending_buf,r.pending-i,i)),Te(e),0!==r.pending)return r.last_flush=-1,ye;i=0}t=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,He(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>i&&(e.adler=ae(e.adler,r.pending_buf,r.pending-i,i)),r.gzindex=0}r.status=91}if(91===r.status){if(r.gzhead.comment){let t,i=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>i&&(e.adler=ae(e.adler,r.pending_buf,r.pending-i,i)),Te(e),0!==r.pending)return r.last_flush=-1,ye;i=0}t=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,He(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>i&&(e.adler=ae(e.adler,r.pending_buf,r.pending-i,i))}r.status=103}if(103===r.status){if(r.gzhead.hcrc){if(r.pending+2>r.pending_buf_size&&(Te(e),0!==r.pending))return r.last_flush=-1,ye;He(r,255&e.adler),He(r,e.adler>>8&255),e.adler=0}if(r.status=_e,Te(e),0!==r.pending)return r.last_flush=-1,ye}if(0!==e.avail_in||0!==r.lookahead||t!==be&&r.status!==Fe){let i=0===r.level?Ve(r,t):r.strategy===Ce?((e,t)=>{let r;for(;;){if(0===e.lookahead&&(Ge(e),0===e.lookahead)){if(t===be)return 1;break}if(e.match_length=0,r=de(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(Xe(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===fe?(Xe(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Xe(e,!1),0===e.strm.avail_out)?1:2})(r,t):r.strategy===Pe?((e,t)=>{let r,i,s,a;const n=e.window;for(;;){if(e.lookahead<=je){if(Ge(e),e.lookahead<=je&&t===be)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(s=e.strstart-1,i=n[s],i===n[++s]&&i===n[++s]&&i===n[++s])){a=e.strstart+je;do{}while(i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&s<a);e.match_length=je-(a-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(r=de(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=de(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(Xe(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===fe?(Xe(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Xe(e,!1),0===e.strm.avail_out)?1:2})(r,t):Qe[r.level].func(r,t);if(3!==i&&4!==i||(r.status=Fe),1===i||3===i)return 0===e.avail_out&&(r.last_flush=-1),ye;if(2===i&&(t===me?ue(r):t!==pe&&(ce(r,0,0,!1),t===ge&&($e(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),Te(e),0===e.avail_out))return r.last_flush=-1,ye}return t!==fe?ye:r.wrap<=0?ve:(2===r.wrap?(He(r,255&e.adler),He(r,e.adler>>8&255),He(r,e.adler>>16&255),He(r,e.adler>>24&255),He(r,255&e.total_in),He(r,e.total_in>>8&255),He(r,e.total_in>>16&255),He(r,e.total_in>>24&255)):(ze(r,e.adler>>>16),ze(r,65535&e.adler)),Te(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?ye:ve)},ot=e=>{if(et(e))return ke;const t=e.state.status;return e.state=null,t===_e?Ne(e,we):ye},ht=(e,t)=>{let r=t.length;if(et(e))return ke;const i=e.state,s=i.wrap;if(2===s||1===s&&i.status!==xe||i.lookahead)return ke;if(1===s&&(e.adler=ie(e.adler,t,r,0)),i.wrap=0,r>=i.w_size){0===s&&($e(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(r-i.w_size,r),0),t=e,r=i.w_size}const a=e.avail_in,n=e.next_in,o=e.input;for(e.avail_in=r,e.next_in=0,e.input=t,Ge(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=Le(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,Ge(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=n,e.input=o,e.avail_in=a,i.wrap=s,ye};const ct=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var lt=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(const t in r)ct(r,t)&&(e[t]=r[t])}}return e},dt=e=>{let t=0;for(let r=0,i=e.length;r<i;r++)t+=e[r].length;const r=new Uint8Array(t);for(let t=0,i=0,s=e.length;t<s;t++){let s=e[t];r.set(s,i),i+=s.length}return r};let ut=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){ut=!1}const bt=new Uint8Array(256);for(let e=0;e<256;e++)bt[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;bt[254]=bt[254]=1;var mt=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,r,i,s,a,n=e.length,o=0;for(s=0;s<n;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<n&&(i=e.charCodeAt(s+1),56320==(64512&i)&&(r=65536+(r-55296<<10)+(i-56320),s++)),o+=r<128?1:r<2048?2:r<65536?3:4;for(t=new Uint8Array(o),a=0,s=0;a<o;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<n&&(i=e.charCodeAt(s+1),56320==(64512&i)&&(r=65536+(r-55296<<10)+(i-56320),s++)),r<128?t[a++]=r:r<2048?(t[a++]=192|r>>>6,t[a++]=128|63&r):r<65536?(t[a++]=224|r>>>12,t[a++]=128|r>>>6&63,t[a++]=128|63&r):(t[a++]=240|r>>>18,t[a++]=128|r>>>12&63,t[a++]=128|r>>>6&63,t[a++]=128|63&r);return t},gt=(e,t)=>{const r=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,s;const a=new Array(2*r);for(s=0,i=0;i<r;){let t=e[i++];if(t<128){a[s++]=t;continue}let n=bt[t];if(n>4)a[s++]=65533,i+=n-1;else{for(t&=2===n?31:3===n?15:7;n>1&&i<r;)t=t<<6|63&e[i++],n--;n>1?a[s++]=65533:t<65536?a[s++]=t:(t-=65536,a[s++]=55296|t>>10&1023,a[s++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&ut)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(e[i]);return r})(a,s)},ft=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let r=t-1;for(;r>=0&&128==(192&e[r]);)r--;return r<0||0===r?t:r+bt[e[r]]>t?r:t},pt=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const yt=Object.prototype.toString,{Z_NO_FLUSH:vt,Z_SYNC_FLUSH:kt,Z_FULL_FLUSH:wt,Z_FINISH:St,Z_OK:Rt,Z_STREAM_END:Ot,Z_DEFAULT_COMPRESSION:Ct,Z_DEFAULT_STRATEGY:Pt,Z_DEFLATED:At}=oe;function Bt(e){this.options=lt({level:Ct,method:At,chunkSize:16384,windowBits:15,memLevel:8,strategy:Pt},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pt,this.strm.avail_out=0;let r=st(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==Rt)throw new Error(ne[r]);if(t.header&&at(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?mt(t.dictionary):"[object ArrayBuffer]"===yt.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,r=ht(this.strm,e),r!==Rt)throw new Error(ne[r]);this._dict_set=!0}}function It(e,t){const r=new Bt(t);if(r.push(e,!0),r.err)throw r.msg||ne[r.err];return r.result}Bt.prototype.push=function(e,t){const r=this.strm,i=this.options.chunkSize;let s,a;if(this.ended)return!1;for(a=t===~~t?t:!0===t?St:vt,"string"==typeof e?r.input=mt(e):"[object ArrayBuffer]"===yt.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;)if(0===r.avail_out&&(r.output=new Uint8Array(i),r.next_out=0,r.avail_out=i),(a===kt||a===wt)&&r.avail_out<=6)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else{if(s=nt(r,a),s===Ot)return r.next_out>0&&this.onData(r.output.subarray(0,r.next_out)),s=ot(this.strm),this.onEnd(s),this.ended=!0,s===Rt;if(0!==r.avail_out){if(a>0&&r.next_out>0)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else if(0===r.avail_in)break}else this.onData(r.output)}return!0},Bt.prototype.onData=function(e){this.chunks.push(e)},Bt.prototype.onEnd=function(e){e===Rt&&(this.result=dt(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Dt={Deflate:Bt,deflate:It,deflateRaw:function(e,t){return(t=t||{}).raw=!0,It(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,It(e,t)},constants:oe};const jt=16209;var Mt=function(e,t){let r,i,s,a,n,o,h,c,l,d,u,b,m,g,f,p,y,v,k,w,S,R,O,C;const P=e.state;r=e.next_in,O=e.input,i=r+(e.avail_in-5),s=e.next_out,C=e.output,a=s-(t-e.avail_out),n=s+(e.avail_out-257),o=P.dmax,h=P.wsize,c=P.whave,l=P.wnext,d=P.window,u=P.hold,b=P.bits,m=P.lencode,g=P.distcode,f=(1<<P.lenbits)-1,p=(1<<P.distbits)-1;e:do{b<15&&(u+=O[r++]<<b,b+=8,u+=O[r++]<<b,b+=8),y=m[u&f];t:for(;;){if(v=y>>>24,u>>>=v,b-=v,v=y>>>16&255,0===v)C[s++]=65535&y;else{if(!(16&v)){if(0==(64&v)){y=m[(65535&y)+(u&(1<<v)-1)];continue t}if(32&v){P.mode=16191;break e}e.msg="invalid literal/length code",P.mode=jt;break e}k=65535&y,v&=15,v&&(b<v&&(u+=O[r++]<<b,b+=8),k+=u&(1<<v)-1,u>>>=v,b-=v),b<15&&(u+=O[r++]<<b,b+=8,u+=O[r++]<<b,b+=8),y=g[u&p];r:for(;;){if(v=y>>>24,u>>>=v,b-=v,v=y>>>16&255,!(16&v)){if(0==(64&v)){y=g[(65535&y)+(u&(1<<v)-1)];continue r}e.msg="invalid distance code",P.mode=jt;break e}if(w=65535&y,v&=15,b<v&&(u+=O[r++]<<b,b+=8,b<v&&(u+=O[r++]<<b,b+=8)),w+=u&(1<<v)-1,w>o){e.msg="invalid distance too far back",P.mode=jt;break e}if(u>>>=v,b-=v,v=s-a,w>v){if(v=w-v,v>c&&P.sane){e.msg="invalid distance too far back",P.mode=jt;break e}if(S=0,R=d,0===l){if(S+=h-v,v<k){k-=v;do{C[s++]=d[S++]}while(--v);S=s-w,R=C}}else if(l<v){if(S+=h+l-v,v-=l,v<k){k-=v;do{C[s++]=d[S++]}while(--v);if(S=0,l<k){v=l,k-=v;do{C[s++]=d[S++]}while(--v);S=s-w,R=C}}}else if(S+=l-v,v<k){k-=v;do{C[s++]=d[S++]}while(--v);S=s-w,R=C}for(;k>2;)C[s++]=R[S++],C[s++]=R[S++],C[s++]=R[S++],k-=3;k&&(C[s++]=R[S++],k>1&&(C[s++]=R[S++]))}else{S=s-w;do{C[s++]=C[S++],C[s++]=C[S++],C[s++]=C[S++],k-=3}while(k>2);k&&(C[s++]=C[S++],k>1&&(C[s++]=C[S++]))}break}}break}}while(r<i&&s<n);k=b>>3,r-=k,b-=k<<3,u&=(1<<b)-1,e.next_in=r,e.next_out=s,e.avail_in=r<i?i-r+5:5-(r-i),e.avail_out=s<n?n-s+257:257-(s-n),P.hold=u,P.bits=b};const xt=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),_t=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Ft=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Nt=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Wt=(e,t,r,i,s,a,n,o)=>{const h=o.bits;let c,l,d,u,b,m,g=0,f=0,p=0,y=0,v=0,k=0,w=0,S=0,R=0,O=0,C=null;const P=new Uint16Array(16),A=new Uint16Array(16);let B,I,D,j=null;for(g=0;g<=15;g++)P[g]=0;for(f=0;f<i;f++)P[t[r+f]]++;for(v=h,y=15;y>=1&&0===P[y];y--);if(v>y&&(v=y),0===y)return s[a++]=20971520,s[a++]=20971520,o.bits=1,0;for(p=1;p<y&&0===P[p];p++);for(v<p&&(v=p),S=1,g=1;g<=15;g++)if(S<<=1,S-=P[g],S<0)return-1;if(S>0&&(0===e||1!==y))return-1;for(A[1]=0,g=1;g<15;g++)A[g+1]=A[g]+P[g];for(f=0;f<i;f++)0!==t[r+f]&&(n[A[t[r+f]]++]=f);if(0===e?(C=j=n,m=20):1===e?(C=xt,j=_t,m=257):(C=Ft,j=Nt,m=0),O=0,f=0,g=p,b=a,k=v,w=0,d=-1,R=1<<v,u=R-1,1===e&&R>852||2===e&&R>592)return 1;for(;;){B=g-w,n[f]+1<m?(I=0,D=n[f]):n[f]>=m?(I=j[n[f]-m],D=C[n[f]-m]):(I=96,D=0),c=1<<g-w,l=1<<k,p=l;do{l-=c,s[b+(O>>w)+l]=B<<24|I<<16|D|0}while(0!==l);for(c=1<<g-1;O&c;)c>>=1;if(0!==c?(O&=c-1,O+=c):O=0,f++,0==--P[g]){if(g===y)break;g=t[r+n[f]]}if(g>v&&(O&u)!==d){for(0===w&&(w=v),b+=p,k=g-w,S=1<<k;k+w<y&&(S-=P[k+w],!(S<=0));)k++,S<<=1;if(R+=1<<k,1===e&&R>852||2===e&&R>592)return 1;d=O&u,s[d]=v<<24|k<<16|b-a|0}}return 0!==O&&(s[b+O]=g-w<<24|64<<16|0),o.bits=v,0};const{Z_FINISH:$t,Z_BLOCK:Et,Z_TREES:Lt,Z_OK:Tt,Z_STREAM_END:Xt,Z_NEED_DICT:Ht,Z_STREAM_ERROR:zt,Z_DATA_ERROR:Ut,Z_MEM_ERROR:Zt,Z_BUF_ERROR:Gt,Z_DEFLATED:Vt}=oe,Jt=16180,qt=16190,Kt=16191,Qt=16192,Yt=16194,er=16199,tr=16200,rr=16206,ir=16209,sr=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function ar(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const nr=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<Jt||t.mode>16211?1:0},or=e=>{if(nr(e))return zt;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Jt,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Tt},hr=e=>{if(nr(e))return zt;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,or(e)},cr=(e,t)=>{let r;if(nr(e))return zt;const i=e.state;return t<0?(r=0,t=-t):(r=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?zt:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=r,i.wbits=t,hr(e))},lr=(e,t)=>{if(!e)return zt;const r=new ar;e.state=r,r.strm=e,r.window=null,r.mode=Jt;const i=cr(e,t);return i!==Tt&&(e.state=null),i};let dr,ur,br=!0;const mr=e=>{if(br){dr=new Int32Array(512),ur=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Wt(1,e.lens,0,288,dr,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Wt(2,e.lens,0,32,ur,0,e.work,{bits:5}),br=!1}e.lencode=dr,e.lenbits=9,e.distcode=ur,e.distbits=5},gr=(e,t,r,i)=>{let s;const a=e.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new Uint8Array(a.wsize)),i>=a.wsize?(a.window.set(t.subarray(r-a.wsize,r),0),a.wnext=0,a.whave=a.wsize):(s=a.wsize-a.wnext,s>i&&(s=i),a.window.set(t.subarray(r-i,r-i+s),a.wnext),(i-=s)?(a.window.set(t.subarray(r-i,r),0),a.wnext=i,a.whave=a.wsize):(a.wnext+=s,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=s))),0};var fr=hr,pr=lr,yr=(e,t)=>{let r,i,s,a,n,o,h,c,l,d,u,b,m,g,f,p,y,v,k,w,S,R,O=0;const C=new Uint8Array(4);let P,A;const B=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(nr(e)||!e.output||!e.input&&0!==e.avail_in)return zt;r=e.state,r.mode===Kt&&(r.mode=Qt),n=e.next_out,s=e.output,h=e.avail_out,a=e.next_in,i=e.input,o=e.avail_in,c=r.hold,l=r.bits,d=o,u=h,R=Tt;e:for(;;)switch(r.mode){case Jt:if(0===r.wrap){r.mode=Qt;break}for(;l<16;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(2&r.wrap&&35615===c){0===r.wbits&&(r.wbits=15),r.check=0,C[0]=255&c,C[1]=c>>>8&255,r.check=ae(r.check,C,2,0),c=0,l=0,r.mode=16181;break}if(r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",r.mode=ir;break}if((15&c)!==Vt){e.msg="unknown compression method",r.mode=ir;break}if(c>>>=4,l-=4,S=8+(15&c),0===r.wbits&&(r.wbits=S),S>15||S>r.wbits){e.msg="invalid window size",r.mode=ir;break}r.dmax=1<<r.wbits,r.flags=0,e.adler=r.check=1,r.mode=512&c?16189:Kt,c=0,l=0;break;case 16181:for(;l<16;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(r.flags=c,(255&r.flags)!==Vt){e.msg="unknown compression method",r.mode=ir;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=ir;break}r.head&&(r.head.text=c>>8&1),512&r.flags&&4&r.wrap&&(C[0]=255&c,C[1]=c>>>8&255,r.check=ae(r.check,C,2,0)),c=0,l=0,r.mode=16182;case 16182:for(;l<32;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.head&&(r.head.time=c),512&r.flags&&4&r.wrap&&(C[0]=255&c,C[1]=c>>>8&255,C[2]=c>>>16&255,C[3]=c>>>24&255,r.check=ae(r.check,C,4,0)),c=0,l=0,r.mode=16183;case 16183:for(;l<16;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.head&&(r.head.xflags=255&c,r.head.os=c>>8),512&r.flags&&4&r.wrap&&(C[0]=255&c,C[1]=c>>>8&255,r.check=ae(r.check,C,2,0)),c=0,l=0,r.mode=16184;case 16184:if(1024&r.flags){for(;l<16;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.length=c,r.head&&(r.head.extra_len=c),512&r.flags&&4&r.wrap&&(C[0]=255&c,C[1]=c>>>8&255,r.check=ae(r.check,C,2,0)),c=0,l=0}else r.head&&(r.head.extra=null);r.mode=16185;case 16185:if(1024&r.flags&&(b=r.length,b>o&&(b=o),b&&(r.head&&(S=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(i.subarray(a,a+b),S)),512&r.flags&&4&r.wrap&&(r.check=ae(r.check,i,b,a)),o-=b,a+=b,r.length-=b),r.length))break e;r.length=0,r.mode=16186;case 16186:if(2048&r.flags){if(0===o)break e;b=0;do{S=i[a+b++],r.head&&S&&r.length<65536&&(r.head.name+=String.fromCharCode(S))}while(S&&b<o);if(512&r.flags&&4&r.wrap&&(r.check=ae(r.check,i,b,a)),o-=b,a+=b,S)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=16187;case 16187:if(4096&r.flags){if(0===o)break e;b=0;do{S=i[a+b++],r.head&&S&&r.length<65536&&(r.head.comment+=String.fromCharCode(S))}while(S&&b<o);if(512&r.flags&&4&r.wrap&&(r.check=ae(r.check,i,b,a)),o-=b,a+=b,S)break e}else r.head&&(r.head.comment=null);r.mode=16188;case 16188:if(512&r.flags){for(;l<16;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(4&r.wrap&&c!==(65535&r.check)){e.msg="header crc mismatch",r.mode=ir;break}c=0,l=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=Kt;break;case 16189:for(;l<32;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}e.adler=r.check=sr(c),c=0,l=0,r.mode=qt;case qt:if(0===r.havedict)return e.next_out=n,e.avail_out=h,e.next_in=a,e.avail_in=o,r.hold=c,r.bits=l,Ht;e.adler=r.check=1,r.mode=Kt;case Kt:if(t===Et||t===Lt)break e;case Qt:if(r.last){c>>>=7&l,l-=7&l,r.mode=rr;break}for(;l<3;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}switch(r.last=1&c,c>>>=1,l-=1,3&c){case 0:r.mode=16193;break;case 1:if(mr(r),r.mode=er,t===Lt){c>>>=2,l-=2;break e}break;case 2:r.mode=16196;break;case 3:e.msg="invalid block type",r.mode=ir}c>>>=2,l-=2;break;case 16193:for(c>>>=7&l,l-=7&l;l<32;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if((65535&c)!=(c>>>16^65535)){e.msg="invalid stored block lengths",r.mode=ir;break}if(r.length=65535&c,c=0,l=0,r.mode=Yt,t===Lt)break e;case Yt:r.mode=16195;case 16195:if(b=r.length,b){if(b>o&&(b=o),b>h&&(b=h),0===b)break e;s.set(i.subarray(a,a+b),n),o-=b,a+=b,h-=b,n+=b,r.length-=b;break}r.mode=Kt;break;case 16196:for(;l<14;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(r.nlen=257+(31&c),c>>>=5,l-=5,r.ndist=1+(31&c),c>>>=5,l-=5,r.ncode=4+(15&c),c>>>=4,l-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=ir;break}r.have=0,r.mode=16197;case 16197:for(;r.have<r.ncode;){for(;l<3;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.lens[B[r.have++]]=7&c,c>>>=3,l-=3}for(;r.have<19;)r.lens[B[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,P={bits:r.lenbits},R=Wt(0,r.lens,0,19,r.lencode,0,r.work,P),r.lenbits=P.bits,R){e.msg="invalid code lengths set",r.mode=ir;break}r.have=0,r.mode=16198;case 16198:for(;r.have<r.nlen+r.ndist;){for(;O=r.lencode[c&(1<<r.lenbits)-1],f=O>>>24,p=O>>>16&255,y=65535&O,!(f<=l);){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(y<16)c>>>=f,l-=f,r.lens[r.have++]=y;else{if(16===y){for(A=f+2;l<A;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(c>>>=f,l-=f,0===r.have){e.msg="invalid bit length repeat",r.mode=ir;break}S=r.lens[r.have-1],b=3+(3&c),c>>>=2,l-=2}else if(17===y){for(A=f+3;l<A;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}c>>>=f,l-=f,S=0,b=3+(7&c),c>>>=3,l-=3}else{for(A=f+7;l<A;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}c>>>=f,l-=f,S=0,b=11+(127&c),c>>>=7,l-=7}if(r.have+b>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=ir;break}for(;b--;)r.lens[r.have++]=S}}if(r.mode===ir)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=ir;break}if(r.lenbits=9,P={bits:r.lenbits},R=Wt(1,r.lens,0,r.nlen,r.lencode,0,r.work,P),r.lenbits=P.bits,R){e.msg="invalid literal/lengths set",r.mode=ir;break}if(r.distbits=6,r.distcode=r.distdyn,P={bits:r.distbits},R=Wt(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,P),r.distbits=P.bits,R){e.msg="invalid distances set",r.mode=ir;break}if(r.mode=er,t===Lt)break e;case er:r.mode=tr;case tr:if(o>=6&&h>=258){e.next_out=n,e.avail_out=h,e.next_in=a,e.avail_in=o,r.hold=c,r.bits=l,Mt(e,u),n=e.next_out,s=e.output,h=e.avail_out,a=e.next_in,i=e.input,o=e.avail_in,c=r.hold,l=r.bits,r.mode===Kt&&(r.back=-1);break}for(r.back=0;O=r.lencode[c&(1<<r.lenbits)-1],f=O>>>24,p=O>>>16&255,y=65535&O,!(f<=l);){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(p&&0==(240&p)){for(v=f,k=p,w=y;O=r.lencode[w+((c&(1<<v+k)-1)>>v)],f=O>>>24,p=O>>>16&255,y=65535&O,!(v+f<=l);){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}c>>>=v,l-=v,r.back+=v}if(c>>>=f,l-=f,r.back+=f,r.length=y,0===p){r.mode=16205;break}if(32&p){r.back=-1,r.mode=Kt;break}if(64&p){e.msg="invalid literal/length code",r.mode=ir;break}r.extra=15&p,r.mode=16201;case 16201:if(r.extra){for(A=r.extra;l<A;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.length+=c&(1<<r.extra)-1,c>>>=r.extra,l-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=16202;case 16202:for(;O=r.distcode[c&(1<<r.distbits)-1],f=O>>>24,p=O>>>16&255,y=65535&O,!(f<=l);){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(0==(240&p)){for(v=f,k=p,w=y;O=r.distcode[w+((c&(1<<v+k)-1)>>v)],f=O>>>24,p=O>>>16&255,y=65535&O,!(v+f<=l);){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}c>>>=v,l-=v,r.back+=v}if(c>>>=f,l-=f,r.back+=f,64&p){e.msg="invalid distance code",r.mode=ir;break}r.offset=y,r.extra=15&p,r.mode=16203;case 16203:if(r.extra){for(A=r.extra;l<A;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}r.offset+=c&(1<<r.extra)-1,c>>>=r.extra,l-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=ir;break}r.mode=16204;case 16204:if(0===h)break e;if(b=u-h,r.offset>b){if(b=r.offset-b,b>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=ir;break}b>r.wnext?(b-=r.wnext,m=r.wsize-b):m=r.wnext-b,b>r.length&&(b=r.length),g=r.window}else g=s,m=n-r.offset,b=r.length;b>h&&(b=h),h-=b,r.length-=b;do{s[n++]=g[m++]}while(--b);0===r.length&&(r.mode=tr);break;case 16205:if(0===h)break e;s[n++]=r.length,h--,r.mode=tr;break;case rr:if(r.wrap){for(;l<32;){if(0===o)break e;o--,c|=i[a++]<<l,l+=8}if(u-=h,e.total_out+=u,r.total+=u,4&r.wrap&&u&&(e.adler=r.check=r.flags?ae(r.check,s,u,n-u):ie(r.check,s,u,n-u)),u=h,4&r.wrap&&(r.flags?c:sr(c))!==r.check){e.msg="incorrect data check",r.mode=ir;break}c=0,l=0}r.mode=16207;case 16207:if(r.wrap&&r.flags){for(;l<32;){if(0===o)break e;o--,c+=i[a++]<<l,l+=8}if(4&r.wrap&&c!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=ir;break}c=0,l=0}r.mode=16208;case 16208:R=Xt;break e;case ir:R=Ut;break e;case 16210:return Zt;default:return zt}return e.next_out=n,e.avail_out=h,e.next_in=a,e.avail_in=o,r.hold=c,r.bits=l,(r.wsize||u!==e.avail_out&&r.mode<ir&&(r.mode<rr||t!==$t))&&gr(e,e.output,e.next_out,u-e.avail_out),d-=e.avail_in,u-=e.avail_out,e.total_in+=d,e.total_out+=u,r.total+=u,4&r.wrap&&u&&(e.adler=r.check=r.flags?ae(r.check,s,u,e.next_out-u):ie(r.check,s,u,e.next_out-u)),e.data_type=r.bits+(r.last?64:0)+(r.mode===Kt?128:0)+(r.mode===er||r.mode===Yt?256:0),(0===d&&0===u||t===$t)&&R===Tt&&(R=Gt),R},vr=e=>{if(nr(e))return zt;let t=e.state;return t.window&&(t.window=null),e.state=null,Tt},kr=(e,t)=>{if(nr(e))return zt;const r=e.state;return 0==(2&r.wrap)?zt:(r.head=t,t.done=!1,Tt)},wr=(e,t)=>{const r=t.length;let i,s,a;return nr(e)?zt:(i=e.state,0!==i.wrap&&i.mode!==qt?zt:i.mode===qt&&(s=1,s=ie(s,t,r,0),s!==i.check)?Ut:(a=gr(e,t,r,r),a?(i.mode=16210,Zt):(i.havedict=1,Tt)))},Sr=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Rr=Object.prototype.toString,{Z_NO_FLUSH:Or,Z_FINISH:Cr,Z_OK:Pr,Z_STREAM_END:Ar,Z_NEED_DICT:Br,Z_STREAM_ERROR:Ir,Z_DATA_ERROR:Dr,Z_MEM_ERROR:jr}=oe;function Mr(e){this.options=lt({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pt,this.strm.avail_out=0;let r=pr(this.strm,t.windowBits);if(r!==Pr)throw new Error(ne[r]);if(this.header=new Sr,kr(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=mt(t.dictionary):"[object ArrayBuffer]"===Rr.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(r=wr(this.strm,t.dictionary),r!==Pr)))throw new Error(ne[r])}function xr(e,t){const r=new Mr(t);if(r.push(e),r.err)throw r.msg||ne[r.err];return r.result}Mr.prototype.push=function(e,t){const r=this.strm,i=this.options.chunkSize,s=this.options.dictionary;let a,n,o;if(this.ended)return!1;for(n=t===~~t?t:!0===t?Cr:Or,"[object ArrayBuffer]"===Rr.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;){for(0===r.avail_out&&(r.output=new Uint8Array(i),r.next_out=0,r.avail_out=i),a=yr(r,n),a===Br&&s&&(a=wr(r,s),a===Pr?a=yr(r,n):a===Dr&&(a=Br));r.avail_in>0&&a===Ar&&r.state.wrap>0&&0!==e[r.next_in];)fr(r),a=yr(r,n);switch(a){case Ir:case Dr:case Br:case jr:return this.onEnd(a),this.ended=!0,!1}if(o=r.avail_out,r.next_out&&(0===r.avail_out||a===Ar))if("string"===this.options.to){let e=ft(r.output,r.next_out),t=r.next_out-e,s=gt(r.output,e);r.next_out=t,r.avail_out=i-t,t&&r.output.set(r.output.subarray(e,e+t),0),this.onData(s)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(a!==Pr||0!==o){if(a===Ar)return a=vr(this.strm),this.onEnd(a),this.ended=!0,!0;if(0===r.avail_in)break}}return!0},Mr.prototype.onData=function(e){this.chunks.push(e)},Mr.prototype.onEnd=function(e){e===Pr&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=dt(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var _r={Inflate:Mr,inflate:xr,inflateRaw:function(e,t){return(t=t||{}).raw=!0,xr(e,t)},ungzip:xr,constants:oe};const{Deflate:Fr,deflate:Nr,deflateRaw:Wr,gzip:$r}=Dt,{Inflate:Er,inflate:Lr,inflateRaw:Tr,ungzip:Xr}=_r;var Hr,zr,Ur,Zr,Gr,Vr,Jr,qr,Kr,Qr,Yr,ei,ti,ri=Xr;class ii{constructor(e){Object.defineProperty(this,"objStoreName",{enumerable:!0,configurable:!0,writable:!0,value:"data"}),Object.defineProperty(this,"dbName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"database",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.dbName=e}async initialize(){return new Promise((e=>{const t=indexedDB.open(this.dbName,1);t.onerror=()=>{alert("Database error")},t.onsuccess=()=>{this.database=t.result,this.ready=!0,e()},t.onupgradeneeded=t=>{const r=t.target;this.database=r.result,this.database.createObjectStore(this.objStoreName,{keyPath:"key"}).createIndex("primary","key"),r.transaction.oncomplete=()=>{this.ready=!0,e()}}}))}async setData(e,t){if(this.ready)return new Promise(((r,i)=>{const s=this.database.transaction(this.objStoreName,"readwrite").objectStore(this.objStoreName).put({key:e,data:t});s.onsuccess=()=>{r()},s.onerror=()=>{i()}}))}async getData(e){if(this.ready)return new Promise((t=>{const r=this.database.transaction(this.objStoreName,"readonly").objectStore(this.objStoreName).index("primary").get(e);r.onsuccess=e=>{t(e.target.result?.data)},r.onerror=()=>{t(void 0)}}))}}class si{constructor(e,t,r,i,s){Object.defineProperty(this,"biosType",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cylinders",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"heads",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sectors",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"switchCode",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.biosType=e,this.cylinders=t,this.heads=r,this.sectors=i,this.switchCode=s}get diskSize(){return this.heads*this.cylinders*this.sectors*si.sectorSize}calcLba(e,t,r){return e<this.cylinders||t<this.heads||r<this.sectors?(e*this.heads+t)*this.sectors+r:null}}Object.defineProperty(si,"sectorSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),function(e){e[e.None=0]="None",e[e.NoIndexSignal=1]="NoIndexSignal",e[e.NoSeekCompleteSignal=2]="NoSeekCompleteSignal",e[e.WriteFault=3]="WriteFault",e[e.NoReadyAfterDriveSelect=4]="NoReadyAfterDriveSelect",e[e.NoTrack00Signal=6]="NoTrack00Signal",e[e.SeekNotComplete=8]="SeekNotComplete",e[e.IdReadError=16]="IdReadError",e[e.DataError=17]="DataError",e[e.NoAddressMark=18]="NoAddressMark",e[e.SectorNotFound=20]="SectorNotFound",e[e.SeekError=21]="SeekError",e[e.CorrectableDataError=24]="CorrectableDataError",e[e.BadTrack=25]="BadTrack",e[e.InvalidCommand=32]="InvalidCommand",e[e.IllegalDiskAddress=33]="IllegalDiskAddress",e[e.RamError=48]="RamError",e[e.ProgramChecksumError=49]="ProgramChecksumError",e[e.EccError=50]="EccError"}(Hr||(Hr={}));class ai extends p{constructor(e,t){super(),Object.defineProperty(this,"driveCount",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"commandDelay",{enumerable:!0,configurable:!0,writable:!0,value:500}),Object.defineProperty(this,"readWriteDelay",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"pic",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"allDriveSpecs",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"driveSpecs",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.driveCount)}),Object.defineProperty(this,"diskImages",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.driveCount)}),Object.defineProperty(this,"diskImagePath",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.driveCount)}),Object.defineProperty(this,"imageChanged",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.driveCount)}),Object.defineProperty(this,"selectedDrive",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"head",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cylinder",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sector",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"interlBlockCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"controlField",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"statusByte",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dataPointer",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"busyBit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"commandDataBit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modeBit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"requestBit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaInterruptMask",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"interruptEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isBusy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"driveCharacteristics",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.driveCount)}),Object.defineProperty(this,"dcbByteNo",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"currentCommandError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"errorBytes",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"outputBytes",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"addressValid",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pic=e,this.dmaController=t,this.initDriveSpecs(),this.setDriveType(0,2),this.setDriveType(1,2);for(let e=0;e<this.driveCount;e++)this.driveCharacteristics[e]=new Uint8Array(8),this.diskImagePath[e]=k.hdImageDir+"HD"+e+".ima.gz"}async loadImages(){for(let e=0;e<this.driveCount;e++){if(null==this.driveSpecs[e])return;await this.loadImage(e)}}async saveImages(){for(let e=0;e<this.driveCount;e++)await this.saveImage(e)}async loadImage(e){const t=k.baseDir+this.diskImagePath[e];this.storage||(this.storage=new ii("HDD"),await this.storage.initialize());const r=await this.storage.getData(`image${e}`);if(void 0!==r){const t=new Uint8Array(r);if(t.length==this.driveSpecs[e].diskSize)return this.diskImages[e]=t,void(this.imageChanged[e]=!1)}return new Promise(((r,i)=>{const s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",t,!0),s.onload=()=>{if(200!=s.status)return void i();const t=s.response,a=ri(new Uint8Array(t));a.length==this.driveSpecs[e].diskSize&&(this.diskImages[e]=a,this.imageChanged[e]=!1),r()},s.onerror=()=>{i()},s.send()}))}async saveImage(e){this.storage&&await this.storage.setData(`image${e}`,this.diskImages[e].buffer)}generateError(e){this.errorBytes.length=0,this.errorBytes.push(255&(this.addressValid?128:0+e)),this.errorBytes.push((this.selectedDrive<<5)+this.head&255),this.errorBytes.push(((1792&this.cylinder)>>3)+this.sector&255),this.errorBytes.push(this.cylinder),this.currentCommandError=!0}in(e){switch(e){case 800:if(null!=this.statusByte){const e=this.statusByte;return this.statusByte=null,this.requestBit=!1,this.modeBit=!1,this.commandDataBit=!1,this.busyBit=!1,e}if(this.outputBytes.length>0)return this.outputBytes.shift();break;case 801:return(this.requestBit?1:0)+(this.modeBit?2:0)+(this.commandDataBit?4:0)+(this.busyBit?8:0)+(null!=this.statusByte?32:0)&65535;case 802:return 65535&(this.driveSpecs[0]?.switchCode<<2??0)+(this.driveSpecs[1]?.switchCode??0)}return 0}out(e,t,r){switch(e){case 800:this.commandDataBit=!1,this.writeDataByte(255&t);break;case 801:(64&t)>0&&this.reset();break;case 802:this.requestBit=!0,this.commandDataBit=!0,this.busyBit=!0;break;case 803:this.interruptEnabled=(2&t)>0,this.dmaInterruptMask=t}}setDriveType(e,t){const r=this.allDriveSpecs.find((e=>e.biosType==t));if(null==r)throw new Error("Harddisk drive type "+t+" not found.");this.driveSpecs[e]=r,this.diskImages[e]=new Uint8Array(r.diskSize)}initDriveSpecs(){this.allDriveSpecs.push(new si(1,306,4,17,0)),this.allDriveSpecs.push(new si(2,615,4,17,1)),this.allDriveSpecs.push(new si(13,306,8,17,3)),this.allDriveSpecs.push(new si(16,612,4,17,2))}reset(){super.reset(),this.selectedDrive=0,this.dcbByteNo=0,this.requestBit=!1,this.commandDataBit=!1,this.busyBit=!1,this.requestBit=!1,this.errorBytes.length=0,this.currentCommandError=!1,this.outputBytes.length=0}writeDataByte(e){switch(this.dcbByteNo){case 0:this.command=e;break;case 1:this.head=31&e,this.selectedDrive=(32&e)>0?1:0;break;case 2:this.sector=63&e,this.cylinder=(192&e)<<2;break;case 3:this.cylinder=this.cylinder+e;break;case 4:this.interlBlockCount=e;break;case 5:this.controlField=e}this.dcbByteNo<5?this.dcbByteNo++:12==this.command&&this.dcbByteNo<13?(this.driveCharacteristics[this.selectedDrive][this.dcbByteNo-5]=e,this.dcbByteNo++):(this.dcbByteNo=0,this.executeCommand())}getStatusByte(){let e=0;return 1==this.selectedDrive&&(e|=32),this.currentCommandError&&(e|=2),e}commandFinished(){this.command=0,this.eventTimer.setEvent(this.commandDelay,(()=>{this.commandDataBit=!0,this.modeBit=!0,this.statusByte=this.getStatusByte(),this.currentCommandError=!1,this.isBusy=!1,this.interruptEnabled&&this.pic.doInterrupt(d.Harddisk)}))}executeCommand(){if(!this.isBusy){if(this.isBusy=!0,this.currentCommandError=!1,this.errorBytes.length=0,null==this.driveSpecs[this.selectedDrive]);else switch(this.command){case 0:case 1:case 4:case 5:case 6:case 7:case 11:case 12:case 13:case 15:case 224:case 227:case 228:break;case 3:for(;this.errorBytes.length>0;)this.outputBytes.push(this.errorBytes.shift());break;case 8:this.dataPointer=this.calcLba(this.cylinder,this.head,this.sector)*si.sectorSize,this.currentCommandError||this.eventTimer.setEvent(this.readWriteDelay,(()=>this.dmaController.triggerDmaDeviceToMem(3,this,null)));break;case 10:this.dataPointer=this.calcLba(this.cylinder,this.head,this.sector)*si.sectorSize,this.currentCommandError||this.eventTimer.setEvent(this.readWriteDelay,(()=>{this.dmaController.triggerDmaMemToDevice(3,this,null),this.imageChanged[this.selectedDrive]=!0}));break;case 14:case 229:case 230:throw new Error("Method not implemented.");default:this.generateError(Hr.InvalidCommand)}this.commandFinished()}}calcLba(e,t,r){const i=this.driveSpecs[this.selectedDrive].calcLba(e,t,r);return null==i?(this.generateError(Hr.IllegalDiskAddress),0):i}getNextByte(e){const t=this.diskImages[this.selectedDrive];return this.dataPointer<t.length?(e.endOfData=!1,t[this.dataPointer++]):(e.endOfData=!0,0)}setNextByte(e,t){t.endOfData=!1,this.diskImages[this.selectedDrive][this.dataPointer++]=e}}!function(e){e[e.F360=0]="F360",e[e.F720=1]="F720"}(zr||(zr={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Ur||(Ur={}));class ni{constructor(){Object.defineProperty(this,"seekEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"noData",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endOfCylinder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"deleteAddressMark",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}reset(){this.seekEnd=!1,this.noData=!1,this.timeout=!1,this.endOfCylinder=!1,this.deleteAddressMark=!1}}class oi{constructor(){Object.defineProperty(this,"head",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"track",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sector",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sectorSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"trackLength",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"gap3Length",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dataLength",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"fillByte",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"multiTrack",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}}class hi{constructor(e,t,r){Object.defineProperty(this,"heads",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tracks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sectors",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.heads=e,this.sectors=t,this.tracks=r}get diskSize(){return this.heads*this.tracks*this.sectors*hi.sectorSize}calcLba(e,t,r){return(e*this.heads+t)*this.sectors+r-1}}Object.defineProperty(hi,"sectorSize",{enumerable:!0,configurable:!0,writable:!0,value:512});class ci extends p{constructor(e,t){super(),Object.defineProperty(this,"commandDelay",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"maxDriveCount",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"driveSpecsByFloppyType",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"pic",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaIrqEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"motor",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"active",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"selectedDrive",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dataRegisterReady",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"busy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dataDirection",{enumerable:!0,configurable:!0,writable:!0,value:Ur.Input}),Object.defineProperty(this,"resetCount",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"driveInfo",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"commandInfo",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"driveSpecs",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"interruptCode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"diskImages",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"diskImagePath",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"imageChanged",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"outputQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"currDataPosition",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"currDataLength",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"currentCommand",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cmdByteNo",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"headLoadTime",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"headUnloadTime",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),Object.defineProperty(this,"stepRate",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.maxDriveCount)}),this.pic=e,this.dmaController=t;for(let e=0;e<this.maxDriveCount;e++)this.driveInfo[e]=new ni,this.commandInfo[e]=new oi;this.initDriveSpecs()}*getFloppyTypes(){yield zr.F360,yield zr.F720}initDriveSpecs(){this.driveSpecsByFloppyType=new Array(Object.keys(zr).length),this.driveSpecsByFloppyType[zr.F360]=new hi(2,9,40),this.driveSpecsByFloppyType[zr.F720]=new hi(2,9,80)}internalLoadImage(e,t){for(const r of this.getFloppyTypes()){const i=this.driveSpecsByFloppyType[r];if(i&&i.diskSize==t.byteLength)return this.resetImage(e,i),this.diskImages[e]=new Uint8Array(t),!0}return!1}resetImage(e,t){this.driveInfo[e].reset(),this.active[e]=!1,this.motor[e]=!1,this.driveSpecs[e]=t,this.diskImages[e]=new Uint8Array(t.diskSize)}async loadImageFromFile(e,t){return new Promise(((r,i)=>{const s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",k.baseDir+e,!0),s.onload=async()=>{if(200!=s.status)return void i();const a=s.response,n=ri(new Uint8Array(a));if(this.internalLoadImage(t,n.buffer))return this.diskImagePath[t]=e,void r(!0);this.diskImages[t]=null,r(!1)},s.onerror=()=>{this.diskImages[t]=null,i()},s.send()}))}loadImageFromBuffer(e,t){this.internalLoadImage(t,e)}async newImage(e){await this.loadImageFromFile("Floppy/empty.ima.gz",e)}getDiskImage(e){const t=this.diskImages[e];return null!=t&&t.length>0?this.diskImages[e].buffer:null}async saveImage(e){this.diskImagePath[e]&&this.imageChanged[e]&&(this.imageChanged[e]=!1)}async saveImages(){for(let e=0;e<this.maxDriveCount;e++)await this.saveImage(e)}async ejectImage(e){await this.saveImage(e),this.diskImages[e]=null}internalReset(){for(let e=0;e<this.maxDriveCount;e++)this.motor[e]=!1;this.selectedDrive=0,this.dmaIrqEnabled=!1,this.dataDirection=Ur.Input,this.outputQueue.length=0,this.resetCount=0,this.doInterrupt(100,3)}doInterrupt(e,t){this.busy=this.outputQueue.length>0,this.interruptCode=t,0==e?this.pic.doInterrupt(d.Diskette):this.eventTimer.setEvent(e,(()=>{this.pic.doInterrupt(d.Diskette)}))}newCommand(){this.driveInfo[this.selectedDrive].reset(),this.dataDirection=Ur.Input,this.outputQueue.length=0}getStatus0(){let e;return null!=this.resetCount?(e=this.resetCount,this.resetCount<3?this.resetCount++:this.resetCount=null,e|=192):(e=this.selectedDrive,e|=this.interruptCode<<6),1==this.commandInfo[this.selectedDrive].head&&(e|=4),this.driveInfo[this.selectedDrive].seekEnd&&(e|=32),e|=this.interruptCode<<6,e}getStatus1(){let e=0;return this.driveInfo[this.selectedDrive].noData&&(e|=4),this.driveInfo[this.selectedDrive].timeout&&(e|=16),this.driveInfo[this.selectedDrive].endOfCylinder&&(e|=128),e}getStatus2(){let e=0;return this.driveInfo[this.selectedDrive].deleteAddressMark&&(e|=64),e}getStatus3(){let e=this.selectedDrive;return 1==this.commandInfo[this.selectedDrive].head&&(e|=4),e|=8,0==this.commandInfo[this.selectedDrive].track&&(e|=16),e|=32,e}initOutput(){this.outputQueue.length=0,this.dataDirection=Ur.Output}in(e){switch(e){case 1012:{let e=0;for(let t=0;t<this.maxDriveCount;t++)this.active[t]&&(e|=1<<t&255);return this.busy&&(e|=16),this.dmaIrqEnabled||(e|=32),this.dataDirection==Ur.Output&&(e|=64),this.dataRegisterReady&&(e|=128),e}case 1013:if(this.dataDirection==Ur.Output&&this.outputQueue.length>0){const e=this.outputQueue.shift();return 0==this.outputQueue.length&&(this.dataDirection=Ur.Input,this.busy=!1),e}}return 255}out(e,t,r){this.busy&&(this.busy=!1,this.outputQueue.length=0);const i=255&t;switch(e){case 1010:if(0==(4&i))return void this.internalReset();this.selectedDrive=3&i,this.dmaIrqEnabled=(8&i)>0;for(let e=0;e<this.maxDriveCount;e++)this.motor[e]=(i&16<<e)>0;break;case 1013:switch(0==this.cmdByteNo&&(this.currentCommand=31&i,this.commandInfo[this.selectedDrive].multiTrack=(128&i)>0,this.newCommand()),this.currentCommand){case 2:this.cmdReadTrack(i);break;case 5:this.cmdWriteSector(i);break;case 6:this.cmdReadSector(i);break;case 9:this.cmdWriteDeletedSector(i);break;case 12:this.cmdReadDeletedSector(i);break;case 13:this.cmdFormatTrack(i);break;case 3:this.cmdFixDriveData(i);break;case 4:this.cmdCheckDriveStatus();break;case 7:this.cmdCalibrateDrive();break;case 8:this.cmdCheckInterruptStatus();break;case 10:this.cmdReadSectorId(i);break;case 15:this.cmdSeekParkHead(i);break;default:this.cmdInvalid()}}}cmdReadTrack(e){if(this.resetCount=null,this.setAccessValues(e),8==this.cmdByteNo)throw this.cmdByteNo=0,this.busy=!0,new Error("Method not implemented.");this.cmdByteNo++}cmdWriteSector(e){if(this.resetCount=null,this.setAccessValues(e),8==this.cmdByteNo)if(this.cmdByteNo=0,this.busy=!0,null==this.diskImages[this.selectedDrive])this.doInterrupt(10,1);else{const e=this.commandInfo[this.selectedDrive],t=this.driveSpecs[this.selectedDrive].calcLba(e.track,e.head,e.sector)*hi.sectorSize;let r=e.trackLength*hi.sectorSize;r<0&&(r=hi.sectorSize),this.currDataPosition[this.selectedDrive]=t,this.currDataLength[this.selectedDrive]=r;const i=()=>{this.driveInfo[this.selectedDrive].seekEnd=!0,this.initOutput(),this.outputQueue.push(this.getStatus0()),this.outputQueue.push(this.getStatus1()),this.outputQueue.push(this.getStatus2()),this.outputQueue.push(e.track),this.outputQueue.push(e.head),this.outputQueue.push(e.sector),this.outputQueue.push(e.sectorSize),this.doInterrupt(10,0)};this.eventTimer.setEvent(this.commandDelay,(()=>{this.dmaController.triggerDmaMemToDevice(2,this,i),this.imageChanged[this.selectedDrive]=!0}))}else this.cmdByteNo++}cmdReadSector(e){if(this.resetCount=null,this.setAccessValues(e),8==this.cmdByteNo)if(this.cmdByteNo=0,this.busy=!0,null==this.diskImages[this.selectedDrive])this.doInterrupt(10,1);else{const e=this.commandInfo[this.selectedDrive],t=this.driveSpecs[this.selectedDrive];this.currDataPosition[this.selectedDrive]=0;const r=t.calcLba(e.track,e.head,e.sector)*hi.sectorSize;let i=e.trackLength*hi.sectorSize;i<0&&(i=hi.sectorSize),this.currDataPosition[this.selectedDrive]=r,this.currDataLength[this.selectedDrive]=i;const s=()=>{this.driveInfo[this.selectedDrive].seekEnd=!0,this.initOutput(),this.outputQueue.push(this.getStatus0()),this.outputQueue.push(this.getStatus1()),this.outputQueue.push(this.getStatus2()),this.outputQueue.push(e.track),this.outputQueue.push(e.head),this.outputQueue.push(e.sector),this.outputQueue.push(e.sectorSize),this.doInterrupt(10,0)};this.eventTimer.setEvent(this.commandDelay,(()=>this.dmaController.triggerDmaDeviceToMem(2,this,(()=>s()))))}else this.cmdByteNo++}cmdWriteDeletedSector(e){if(this.resetCount=null,this.setAccessValues(e),8==this.cmdByteNo)throw this.cmdByteNo=0,this.busy=!0,new Error("Method not implemented.");this.cmdByteNo++}cmdReadDeletedSector(e){if(this.resetCount=null,this.setAccessValues(e),8==this.cmdByteNo)throw this.cmdByteNo=0,this.busy=!0,new Error("Method not implemented.");this.cmdByteNo++}cmdFormatTrack(e){switch(this.resetCount=null,this.cmdByteNo){case 1:this.commandInfo[this.selectedDrive].head=e>>2&1;break;case 2:this.commandInfo[this.selectedDrive].sectorSize=e;break;case 3:this.commandInfo[this.selectedDrive].trackLength=e;break;case 4:this.commandInfo[this.selectedDrive].gap3Length=e;break;case 5:this.commandInfo[this.selectedDrive].fillByte=e}5==this.cmdByteNo?(this.cmdByteNo=0,this.busy=!0,this.eventTimer.setEvent(1e3,(()=>this.doInterrupt(10,0)))):this.cmdByteNo++}cmdFixDriveData(e){switch(this.resetCount=null,this.cmdByteNo){case 1:this.headUnloadTime[this.selectedDrive]=3&e,this.stepRate[this.selectedDrive]=e>>4&3;break;case 2:this.dmaIrqEnabled=(1&e)>0,this.headLoadTime[this.selectedDrive]=e>>1&127}2==this.cmdByteNo?this.cmdByteNo=0:this.cmdByteNo++}cmdCheckDriveStatus(){this.resetCount=null,1==this.cmdByteNo?(this.cmdByteNo=0,this.busy=!0,this.initOutput(),this.outputQueue.push(this.getStatus3())):this.cmdByteNo++}cmdCalibrateDrive(){this.resetCount=null,1==this.cmdByteNo?(this.cmdByteNo=0,this.active[this.selectedDrive]=!0,this.eventTimer.setEvent(1e4,(()=>{this.commandInfo[this.selectedDrive].track=0,this.driveInfo[this.selectedDrive].seekEnd=!0,this.active[this.selectedDrive]=!1,this.doInterrupt(0,0)}))):this.cmdByteNo++}cmdCheckInterruptStatus(){this.busy=!0,this.initOutput(),this.outputQueue.push(this.getStatus0()),this.outputQueue.push(this.commandInfo[this.selectedDrive].track)}cmdReadSectorId(e){if(this.resetCount=null,1==this.cmdByteNo)throw this.cmdByteNo=0,this.commandInfo[this.selectedDrive].head=e>>2&1,this.busy=!0,new Error("Method not implemented.");this.cmdByteNo++}cmdSeekParkHead(e){this.resetCount=null,2==this.cmdByteNo?(this.cmdByteNo=0,this.active[this.selectedDrive]=!0,this.eventTimer.setEvent(1e4,(()=>{this.commandInfo[this.selectedDrive].track=e,this.driveInfo[this.selectedDrive].seekEnd=!0,this.active[this.selectedDrive]=!1,this.doInterrupt(0,0)}))):this.cmdByteNo++}cmdInvalid(){this.resetCount=null,this.busy=!0,this.interruptCode=2,this.initOutput(),this.outputQueue.push(this.getStatus0())}setAccessValues(e){switch(this.cmdByteNo){case 1:break;case 2:this.commandInfo[this.selectedDrive].track=e;break;case 3:this.commandInfo[this.selectedDrive].head=e;break;case 4:this.commandInfo[this.selectedDrive].sector=e;break;case 5:this.commandInfo[this.selectedDrive].sectorSize=e;break;case 6:this.commandInfo[this.selectedDrive].trackLength=e;break;case 7:this.commandInfo[this.selectedDrive].gap3Length=e;break;case 8:this.commandInfo[this.selectedDrive].dataLength=e}}getNextByte(e){return this.currDataLength[this.selectedDrive]>0?(e.endOfData=!1,this.currDataLength[this.selectedDrive]--,this.diskImages[this.selectedDrive][this.currDataPosition[this.selectedDrive]++]):(e.endOfData=!0,0)}setNextByte(e,t){this.currDataLength[this.selectedDrive]>0?(t.endOfData=!1,this.currDataLength[this.selectedDrive]--,this.diskImages[this.selectedDrive][this.currDataPosition[this.selectedDrive]++]=e):t.endOfData=!0}}!function(e){e[e.One=0]="One",e[e.OnePointFive=1]="OnePointFive",e[e.Two=2]="Two"}(Zr||(Zr={})),function(e){e[e.None=0]="None",e[e.Odd=1]="Odd",e[e.Even=2]="Even",e[e.Mark=3]="Mark",e[e.Space=4]="Space"}(Gr||(Gr={})),function(e){e[e.None=0]="None",e[e.ModemStatusChange=1]="ModemStatusChange",e[e.TransmitterHoldingRegEmpty=2]="TransmitterHoldingRegEmpty",e[e.ReceivedDataAvailable=3]="ReceivedDataAvailable",e[e.LineStatusChange=4]="LineStatusChange",e[e.CharacterTimeout=5]="CharacterTimeout"}(Vr||(Vr={}));class li extends p{constructor(e,t,r){super(),Object.defineProperty(this,"pic",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"port",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"irq",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveIrqDelay",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"serialDevice",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveBuffer",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"divisorLatch",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"interruptEnableRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"lineControlRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"scratchRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"fifosEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaMode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"uartInterruptPending",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptCause",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptPending",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"breakSignalEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dlab",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dataTerminalReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"requestToSend",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auxOutput1",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auxOutput2",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loopbackMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lastModemStatus",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"trailingEdgeRingIndicator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dataWordLen",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"stopBits",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receivedBytesThreshold",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"onBeforeReadReceiveBuffer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onTransmit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onSerialParamsChanged",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.port=e,this.irq=t,this.pic=r,this.receivedBytesThreshold=1}getModemStatus(){return this.loopbackMode?(this.requestToSend?1:0)+(this.dataTerminalReady?2:0)+(this.auxOutput1?4:0)+(this.auxOutput2?8:0):null!=this.serialDevice?(this.serialDevice.clearToSend?1:0)+(this.serialDevice.dataSetReady?2:0)+(this.serialDevice.ringIndicator?4:0)+(this.serialDevice.dataCarrierDetect?8:0):0}in(e){switch(e-this.port){case 0:if(0==this.dlab){let e=0;return this.onBeforeReadReceiveBuffer&&this.onBeforeReadReceiveBuffer(),this.receiveBuffer.length>0&&(e=this.receiveBuffer.shift()),this.clearInterrupt(Vr.ReceivedDataAvailable),this.clearInterrupt(Vr.CharacterTimeout),(1&this.interruptEnableRegister)>0&&this.receiveBuffer.length>=this.receivedBytesThreshold&&this.doInterruptWithDelay(Vr.ReceivedDataAvailable,this.receiveIrqDelay),e}return 255&this.divisorLatch;case 1:return 0==this.dlab?this.interruptEnableRegister:this.divisorLatch>>8&65535;case 2:{let e=0;switch(this.uartInterruptPending||(e=1),this.interruptCause){case Vr.ModemStatusChange:break;case Vr.TransmitterHoldingRegEmpty:e|=2,this.interruptCause=Vr.None,this.uartInterruptPending=!1;break;case Vr.ReceivedDataAvailable:e|=4;break;case Vr.LineStatusChange:e|=6;break;case Vr.CharacterTimeout:e|=12}return this.fifosEnabled&&(e|=192),255&e}case 3:return this.lineControlRegister;case 4:return 255&(this.dataTerminalReady?1:0)+(this.requestToSend?2:0)+(this.auxOutput1?4:0)+(this.auxOutput2?8:0)+(this.loopbackMode?16:0);case 5:{let e=0;return this.receiveBuffer.length>0&&(e+=1),(null==this.serialDevice||this.serialDevice.transmitBufferEmpty)&&(e|=96),this.clearInterrupt(Vr.LineStatusChange),255&e}case 6:{const e=this.getModemStatus();let t=(11&(this.lastModemStatus^e))+(e<<4);return t+=this.trailingEdgeRingIndicator?4:0,this.trailingEdgeRingIndicator=!1,this.lastModemStatus=e,this.clearInterrupt(Vr.ModemStatusChange),255&t}case 7:return this.scratchRegister}return 0}out(e,t,r){switch(e-this.port){case 0:0==this.dlab?(this.clearInterrupt(Vr.TransmitterHoldingRegEmpty),this.loopbackMode?(this.transmitBufferEmpty(),this.writeData(255&t)):this.onTransmit&&this.onTransmit(255&t)):(this.divisorLatch=(65280&this.divisorLatch)+(255&t)&65535,this.serialParamsChanged());break;case 1:0==this.dlab?this.interruptEnableRegister=15&t:(this.divisorLatch=(255&this.divisorLatch)+(t<<8)&65535,this.serialParamsChanged());break;case 2:switch(this.fifosEnabled=(1&t)>0,(2&t)>0&&(this.receiveBuffer.length=0),(4&t)>0&&this.serialDevice?.clearTransmitBuffer(),this.dmaMode=t>>3&1,t>>6){case 0:this.receivedBytesThreshold=1;break;case 1:this.receivedBytesThreshold=4;break;case 2:this.receivedBytesThreshold=8;break;case 3:this.receivedBytesThreshold=14}break;case 3:switch(this.lineControlRegister=255&t,3&t){case 0:this.dataWordLen=5;break;case 1:this.dataWordLen=6;break;case 2:this.dataWordLen=7;break;case 3:this.dataWordLen=8}if(this.stopBits=(4&t)>0?this.dataWordLen<=5?Zr.OnePointFive:Zr.Two:Zr.One,0==(8&t))this.parity=Gr.None;else switch(t>>4&3){case 0:this.parity=Gr.Odd;break;case 1:this.parity=Gr.Even;break;case 2:this.parity=Gr.Mark;break;case 3:this.parity=Gr.Space}this.breakSignalEnabled=(64&t)>0,this.dlab=t>>7&1,this.serialParamsChanged();break;case 4:{const e=this.loopbackMode;this.dataTerminalReady=(1&t)>0,this.requestToSend=(2&t)>0,this.auxOutput1=(4&t)>0,this.auxOutput2=(8&t)>0,this.loopbackMode=(16&t)>0,this.loopbackMode&&!e&&(this.lastModemStatus=this.getModemStatus()),this.loopbackMode&&this.modemStatusChanged(),null!=this.serialDevice&&(this.serialDevice.dataTerminalReady=this.dataTerminalReady,this.serialDevice.requestToSend=this.requestToSend)}break;case 5:break;case 6:this.trailingEdgeRingIndicator=(4&t)>0;break;case 7:this.scratchRegister=255&t}}get baudRate(){return this.divisorLatch>0?Math.trunc(1843200/(this.divisorLatch<<4)):0}connect(e){this.serialDevice=e,this.serialDevice.uartPort=this,this.serialDevice.onTransmitBufferEmpty=this.transmitBufferEmpty}disconnect(){this.serialDevice.uartPort=null,this.serialDevice=null}writeData(e){this.receiveBuffer.push(e),(1&this.interruptEnableRegister)>0&&this.receiveBuffer.length>=this.receivedBytesThreshold&&this.doInterrupt(Vr.ReceivedDataAvailable)}modemStatusChanged(){(8&this.interruptEnableRegister)>0&&this.doInterrupt(Vr.ModemStatusChange)}doInterruptWithDelay(e,t){this.interruptPending||(this.interruptPending=!0,this.eventTimer.setEvent(t,(()=>this.doInterrupt(e))))}doInterrupt(e){this.uartInterruptPending||(this.interruptCause=e,this.uartInterruptPending=!0,this.pic.doInterrupt(this.irq),this.interruptPending=!1)}clearInterrupt(e){this.interruptCause==e&&(this.interruptCause=Vr.None,this.uartInterruptPending=!1)}serialParamsChanged(){this.onSerialParamsChanged&&this.onSerialParamsChanged(),this.receiveBuffer.length=0,this.baudRate>0&&(this.receiveIrqDelay=Math.trunc(1e6/this.baudRate))}transmitBufferEmpty(){(2&this.interruptEnableRegister)>0&&this.doInterrupt(Vr.TransmitterHoldingRegEmpty)}}class di extends p{get dataTerminalReady(){return this._dataTerminalReady}set dataTerminalReady(e){this._dataTerminalReady!=e&&(this._dataTerminalReady=e,this.paramsChanged())}get requestToSend(){return this._requestToSend}set requestToSend(e){this._requestToSend!=e&&(this._requestToSend=e,this.paramsChanged())}get uartPort(){return this._uartPort}set uartPort(e){null!=this._uartPort&&(this._uartPort.onSerialParamsChanged=null),this._uartPort=e,null!=this._uartPort&&(this._uartPort.onSerialParamsChanged=this.paramsChanged)}get checkParamsOk(){return 1200==this.uartPort.baudRate&&7==this.uartPort.dataWordLen&&this.uartPort.stopBits==Zr.One&&this.uartPort.parity==Gr.None&&this.requestToSend&&this.dataTerminalReady}get transmitBufferEmpty(){return!0}constructor(e){super(),Object.defineProperty(this,"_uartPort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lastPosition",{enumerable:!0,configurable:!0,writable:!0,value:{x:0,y:0}}),Object.defineProperty(this,"eventId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"paramsOk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_dataTerminalReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_requestToSend",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dataCarrierDetect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dataSetReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ringIndicator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clearToSend",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onTransmitBufferEmpty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.eventTimer=e}paramsChanged(){this.checkParamsOk?(null!=this.eventId&&this.eventTimer.deleteEvent(this.eventId),this.eventId=this.eventTimer.setEvent(2500,(()=>{this.uartPort.writeData(77),this.paramsOk=!0,this.eventId=null}))):this.paramsOk=!1}sendMouseData(e,t,r,i){if(this.paramsOk){let s=e;s<-128&&(s=-128),s>127&&(s=127),s<0&&(s+=256);let a=t;a<-128&&(a=-128),a>127&&(a=127),a<0&&(a+=256);const n=64+(r?32:0)+(i?16:0)+((192&a)>>4)+((192&s)>>6);this.uartPort.writeData(255&n),this.uartPort.writeData(63&s),this.uartPort.writeData(63&a)}}clearTransmitBuffer(){}mouseMoveDelta(e,t){this.sendMouseData(e,t,!1,!1)}mouseEventAbs(e,t,r){if(Math.abs(this.lastPosition.x)>.1||Math.abs(this.lastPosition.y)>.1){const i=e.x-this.lastPosition.x,s=e.y-this.lastPosition.y;this.sendMouseData(i,s,t,r)}this.lastPosition=e}mouseEventRel(e,t,r){this.sendMouseData(e.x,e.y,t,r)}resetMove(){this.lastPosition={x:0,y:0}}}class ui extends p{constructor(e){super(),Object.defineProperty(this,"startAddr",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportWrite",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"supportRead",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.startAddr=e}async load(e){return new Promise(((t,r)=>{const i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",k.baseDir+e,!0),i.onload=()=>{if(200==i.status){const e=i.response;this.data=new Uint8Array(e),this.size=this.data.length,t()}else r()},i.onerror=()=>{r()},i.send()}))}getEndAddr(){return this.startAddr+this.size-1}peek(e){return this.data[e-this.startAddr]}poke(e,t){}}class bi extends p{constructor(e,t){super(),Object.defineProperty(this,"memory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sizeKb",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"supportWrite",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"supportRead",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.sizeKb=e,this.offset=t,this.memory=new Uint8Array(1024*e)}get addrLo(){return this.offset}get addrHi(){return this.offset+1024*this.sizeKb}peek(e){return e>=this.offset&&e<this.offset+this.memory.length?this.memory[e-this.offset]:0}poke(e,t){e>=this.offset&&e<this.offset+this.memory.length&&(this.memory[e-this.offset]=t)}}!function(e){e[e.Carry=1]="Carry",e[e.Parity=4]="Parity",e[e.Adjust=16]="Adjust",e[e.Zero=64]="Zero",e[e.Sign=128]="Sign",e[e.Trap=256]="Trap",e[e.IntEnable=512]="IntEnable",e[e.Direction=1024]="Direction",e[e.Overflow=2048]="Overflow",e[e.IoPrivilegeLevel0=4096]="IoPrivilegeLevel0",e[e.IoPrivilegeLevel1=8192]="IoPrivilegeLevel1",e[e.NestedTask=16384]="NestedTask",e[e.Resume=65536]="Resume",e[e.Virtual8086Mode=131072]="Virtual8086Mode"}(Jr||(Jr={}));class mi{constructor(){Object.defineProperty(this,"internalValue",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.internalValue=61440}setFlag(e){this.internalValue|=e}resetFlag(e){this.internalValue&=65535&~e}getFlag(e){return(this.internalValue&e)>0}get CF(){return this.getFlag(Jr.Carry)}set CF(e){e?this.setFlag(Jr.Carry):this.resetFlag(Jr.Carry)}get PF(){return this.getFlag(Jr.Parity)}set PF(e){e?this.setFlag(Jr.Parity):this.resetFlag(Jr.Parity)}get AF(){return this.getFlag(Jr.Adjust)}set AF(e){e?this.setFlag(Jr.Adjust):this.resetFlag(Jr.Adjust)}get ZF(){return this.getFlag(Jr.Zero)}set ZF(e){e?this.setFlag(Jr.Zero):this.resetFlag(Jr.Zero)}get SF(){return this.getFlag(Jr.Sign)}set SF(e){e?this.setFlag(Jr.Sign):this.resetFlag(Jr.Sign)}get TF(){return this.getFlag(Jr.Trap)}set TF(e){e?this.setFlag(Jr.Trap):this.resetFlag(Jr.Trap)}get IF(){return this.getFlag(Jr.IntEnable)}set IF(e){e?this.setFlag(Jr.IntEnable):this.resetFlag(Jr.IntEnable)}get DF(){return this.getFlag(Jr.Direction)}set DF(e){e?this.setFlag(Jr.Direction):this.resetFlag(Jr.Direction)}get OF(){return this.getFlag(Jr.Overflow)}set OF(e){e?this.setFlag(Jr.Overflow):this.resetFlag(Jr.Overflow)}get value(){return this.internalValue}set value(e){this.internalValue=61440|e}}class gi{}Object.defineProperty(gi,"Rep",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(gi,"Lock",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"SegOverride",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Aaa",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"Aad",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"Aam",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(gi,"Aas",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(gi,"AdcRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AdcRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AdcRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AdcRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AdcAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AdcAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"AdcRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"AdcRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"AddRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AddRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AddRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AddRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AddAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AddAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"AddRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"AddRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"AndRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AndRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AndRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AndRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"AndRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"AndRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"AndAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"AndAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"Bound",{enumerable:!0,configurable:!0,writable:!0,value:34}),Object.defineProperty(gi,"CallNear",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(gi,"CallFar",{enumerable:!0,configurable:!0,writable:!0,value:31}),Object.defineProperty(gi,"CallNearReg",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(gi,"CallNearMem",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(gi,"CallFarRm",{enumerable:!0,configurable:!0,writable:!0,value:38}),Object.defineProperty(gi,"Cbw",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Clc",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Cld",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Cli",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Cmc",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"CmpRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"CmpRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"CmpRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"CmpRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"CmpAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"CmpAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"CmpRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"CmpRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"Cmps",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(gi,"Cwd",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"Daa",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"Das",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"DivReg",{enumerable:!0,configurable:!0,writable:!0,value:29}),Object.defineProperty(gi,"DivMem",{enumerable:!0,configurable:!0,writable:!0,value:35}),Object.defineProperty(gi,"DivReg16",{enumerable:!0,configurable:!0,writable:!0,value:38}),Object.defineProperty(gi,"DivMem16",{enumerable:!0,configurable:!0,writable:!0,value:44}),Object.defineProperty(gi,"DecReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"DecMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"EnterLvl0",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(gi,"EnterLvl1",{enumerable:!0,configurable:!0,writable:!0,value:29}),Object.defineProperty(gi,"EnterInitial",{enumerable:!0,configurable:!0,writable:!0,value:26}),Object.defineProperty(gi,"EnterPerLvl",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(gi,"Hlt",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"IdivReg",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(gi,"IdivMem",{enumerable:!0,configurable:!0,writable:!0,value:54}),Object.defineProperty(gi,"IdivReg16",{enumerable:!0,configurable:!0,writable:!0,value:57}),Object.defineProperty(gi,"IdivMem16",{enumerable:!0,configurable:!0,writable:!0,value:63}),Object.defineProperty(gi,"ImulImmReg",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(gi,"ImulImmMem",{enumerable:!0,configurable:!0,writable:!0,value:31}),Object.defineProperty(gi,"ImulImmReg16",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(gi,"ImulImmMem16",{enumerable:!0,configurable:!0,writable:!0,value:31}),Object.defineProperty(gi,"ImulReg",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(gi,"ImulMem",{enumerable:!0,configurable:!0,writable:!0,value:33}),Object.defineProperty(gi,"ImulReg16",{enumerable:!0,configurable:!0,writable:!0,value:36}),Object.defineProperty(gi,"ImulMem16",{enumerable:!0,configurable:!0,writable:!0,value:42}),Object.defineProperty(gi,"InImm",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"InDx",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"IncReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"IncMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"Ins",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"InsRep",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"Int3",{enumerable:!0,configurable:!0,writable:!0,value:45}),Object.defineProperty(gi,"IntImm",{enumerable:!0,configurable:!0,writable:!0,value:47}),Object.defineProperty(gi,"Into",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(gi,"IntoNoInt",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"Iret",{enumerable:!0,configurable:!0,writable:!0,value:28}),Object.defineProperty(gi,"JumpCondMet",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(gi,"JumpCondNotMet",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"JcxzMet",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"JcxzNotMet",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(gi,"JmpShort",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"JmpNear",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"JmpNearReg",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(gi,"JmpNearMem",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(gi,"JmpFar",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"JmpFarRm",{enumerable:!0,configurable:!0,writable:!0,value:26}),Object.defineProperty(gi,"Lahf",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"Lds",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(gi,"Lea",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(gi,"Leave",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"Les",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(gi,"Lods",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(gi,"LodsRep",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(gi,"Loop",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"LoopFinished",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(gi,"MovAxMemoffs",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"MovMemoffsAx",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"MovRegImm8",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"MovRegImm16",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"MovRmImm8",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(gi,"MovRmImm16",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(gi,"MovRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"MovRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(gi,"MovRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"MovRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"MovRmSegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"MovRmSegMem",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(gi,"MovSegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"MovSegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"Movs",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"MovsRep",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"MulReg",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(gi,"MulMem",{enumerable:!0,configurable:!0,writable:!0,value:33}),Object.defineProperty(gi,"MulReg16",{enumerable:!0,configurable:!0,writable:!0,value:36}),Object.defineProperty(gi,"MulMem16",{enumerable:!0,configurable:!0,writable:!0,value:42}),Object.defineProperty(gi,"NegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"NegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"Nop",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"NotRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"NotRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"OrRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"OrRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"OrRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"OrRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"OrAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"OrAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"OrRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"OrRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"OutImm",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"OutDx",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(gi,"Outs",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(gi,"OutsRep",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"PopMem",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(gi,"PopReg",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"PopSeg",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"Popa",{enumerable:!0,configurable:!0,writable:!0,value:51}),Object.defineProperty(gi,"Popf",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(gi,"PushMem",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(gi,"PushReg",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"PushSeg",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"Pusha",{enumerable:!0,configurable:!0,writable:!0,value:36}),Object.defineProperty(gi,"Pushf",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"PushImm8",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"PushImm16",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"PushRm",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"Ret",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"RetImm",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(gi,"Retf",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(gi,"RetfImm",{enumerable:!0,configurable:!0,writable:!0,value:25}),Object.defineProperty(gi,"Sahf",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SbbRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SbbRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"SbbRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SbbRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"SbbAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SbbAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"SbbRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"SbbRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"Scas",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"SetFlag",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"ShiftRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(gi,"ShiftRmMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(gi,"ShiftRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(gi,"ShiftRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(gi,"ShiftRmClReg",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(gi,"ShiftRmClMem",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(gi,"Stos",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"StosRep",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(gi,"SubRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SubRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"SubRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SubRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"SubAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"SubAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"SubRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"SubRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"TestReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"TestMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"TestAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"TestAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"TestRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"TestRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"Wait",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(gi,"XchgReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"XchgRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"XchgRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(gi,"Xlat",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(gi,"XorRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"XorRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"XorRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"XorRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(gi,"XorAlImm",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"XorAxImm",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"XorRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(gi,"XorRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(gi,"FpuInstruction",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(gi,"HardInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:40});class fi{}Object.defineProperty(fi,"Rep",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Lock",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SegOverride",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Aaa",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"Aad",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"Aam",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(fi,"Aas",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"AdcRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AdcRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"AdcRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AdcRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"AdcAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AdcAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AdcRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AdcRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"AddRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AddRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"AddRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AddRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"AddAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AddAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AddRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AddRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"AndRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AndRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"AndRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AndRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"AndAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AndAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AndRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"AndRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"ArplReg",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(fi,"ArplMem",{enumerable:!0,configurable:!0,writable:!0,value:21}),Object.defineProperty(fi,"Bound",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"BsfBase",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"BsfBit",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"BtReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"BtMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"BtImmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"BtImmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"BtcReg",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"BtcMem",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(fi,"BtcImmReg",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"BtcImmMem",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(fi,"CallNear",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"CallFar",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(fi,"CallNearReg",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"CallNearMem",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(fi,"CallFarRm",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(fi,"Cbw",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"Clc",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Cld",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Cli",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"Clts",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"Cmc",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"CmpRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"CmpAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"CmpRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"Cmps",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"Cwd",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Daa",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"Das",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"DecReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"DecMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"DivReg",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(fi,"DivMem",{enumerable:!0,configurable:!0,writable:!0,value:17}),Object.defineProperty(fi,"DivReg16",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(fi,"DivMem16",{enumerable:!0,configurable:!0,writable:!0,value:25}),Object.defineProperty(fi,"DivReg32",{enumerable:!0,configurable:!0,writable:!0,value:38}),Object.defineProperty(fi,"DivMem32",{enumerable:!0,configurable:!0,writable:!0,value:41}),Object.defineProperty(fi,"EnterLvl0",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"EnterLvl1",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"EnterInitial",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"EnterPerLvl",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"Hlt",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"IdivReg",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"IdivMem",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"IdivReg16",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"IdivMem16",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"IdivReg32",{enumerable:!0,configurable:!0,writable:!0,value:43}),Object.defineProperty(fi,"IdivMem32",{enumerable:!0,configurable:!0,writable:!0,value:43}),Object.defineProperty(fi,"ImulImmReg",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"ImulImmMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"ImulImmReg16",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(fi,"ImulImmMem16",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"ImulImmReg32",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(fi,"ImulImmMem32",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"ImulReg",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"ImulMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"ImulReg16",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(fi,"ImulMem16",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"ImulReg32",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(fi,"ImulMem32",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"InImm",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"InDx",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(fi,"IncReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"IncMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"Ins",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"InsRep",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"Int3",{enumerable:!0,configurable:!0,writable:!0,value:33}),Object.defineProperty(fi,"IntImm",{enumerable:!0,configurable:!0,writable:!0,value:37}),Object.defineProperty(fi,"Into",{enumerable:!0,configurable:!0,writable:!0,value:35}),Object.defineProperty(fi,"IntoNo",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"Iret",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(fi,"JumpCondMet",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"JumpCondNotMet",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"JcxzMet",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(fi,"JcxzNotMet",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"JmpShort",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"JmpNear",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"JmpNearReg",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"JmpNearMem",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"JmpFar",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"JmpFarRm",{enumerable:!0,configurable:!0,writable:!0,value:43}),Object.defineProperty(fi,"Lahf",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Lar",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(fi,"Lds",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"Lea",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Leave",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"LidtLgdt",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(fi,"Lldt",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(fi,"Ltr",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"LmswReg",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"LmswMem",{enumerable:!0,configurable:!0,writable:!0,value:13}),Object.defineProperty(fi,"Lods",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"LodsRep",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"Loop",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(fi,"LoopFinished",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovAxMemoffs",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"MovMemoffsAx",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRegImm8",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRegImm16",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRmImm8",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRmImm16",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"MovRmSegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovRmSegMem",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovSegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"MovSegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"MovRegCr",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"MovCr0Reg",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"MovCr2Reg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"MovCr3Reg",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"MovDr0Reg",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(fi,"MovDr6Reg",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(fi,"MovRegDr0",{enumerable:!0,configurable:!0,writable:!0,value:22}),Object.defineProperty(fi,"MovRegDr6",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(fi,"MovRegTr",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"MovTrReg",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"Movs",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"MovsRep",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"MovsxReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"MovsxMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"MovzxReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"MovzxMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"MulReg",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(fi,"MulMem",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(fi,"MulReg16",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(fi,"MulMem16",{enumerable:!0,configurable:!0,writable:!0,value:19}),Object.defineProperty(fi,"MulReg32",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(fi,"MulMem32",{enumerable:!0,configurable:!0,writable:!0,value:27}),Object.defineProperty(fi,"NegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"NegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"Nop",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"NotRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"NotRmMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"OrRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"OrRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"OrRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"OrRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"OrAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"OrAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"OrRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"OrRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"OutImm",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"OutDx",{enumerable:!0,configurable:!0,writable:!0,value:11}),Object.defineProperty(fi,"Outs",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(fi,"OutsRep",{enumerable:!0,configurable:!0,writable:!0,value:14}),Object.defineProperty(fi,"PopMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"PopReg",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"PopSeg",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"Popa",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(fi,"Popf",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"PushMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"PushReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"PushSeg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Pusha",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(fi,"Pushf",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"PushImm8",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"PushImm16",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"PushRm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"Ret",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"RetImm",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(fi,"Retf",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(fi,"RetfImm",{enumerable:!0,configurable:!0,writable:!0,value:18}),Object.defineProperty(fi,"Sahf",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"SbbRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SbbRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"SbbRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SbbRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"SbbAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SbbAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SbbRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SbbRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"Scas",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"SetCondMet",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"SetCondNotMet",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"SetFlag",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"ShiftRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"ShiftRmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"ShiftRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"ShiftRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"ShiftRmClReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"ShiftRmClMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"ShldReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"ShldMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"SidtSgdt",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(fi,"Sldt",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SmswReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SmswMem",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"Stos",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"StosRep",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(fi,"Str",{enumerable:!0,configurable:!0,writable:!0,value:25}),Object.defineProperty(fi,"SubRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SubRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"SubRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SubRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"SubAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SubAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SubRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"SubRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"TestReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"TestMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"TestAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"TestAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"TestRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"TestRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"Wait",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"XchgReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"XchgRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"XchgRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"Xlat",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(fi,"XorRegRmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"XorRegRmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"XorRmRegReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"XorRmRegMem",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(fi,"XorAlImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"XorAxImm",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"XorRmImmReg",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(fi,"XorRmImmMem",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(fi,"FpuInstruction",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(fi,"HardInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:40});class pi{constructor(){Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rmAddr",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}}class yi{constructor(){Object.defineProperty(this,"ea",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultSeg",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}}class vi{get AL(){return 255&this.AX}set AL(e){this.AX=65280&this.AX|255&e}get AH(){return this.AX>>8&255}set AH(e){this.AX=255&this.AX|(255&e)<<8}get BL(){return 255&this.BX}set BL(e){this.BX=65280&this.BX|255&e}get BH(){return this.BX>>8&255}set BH(e){this.BX=255&this.BX|(255&e)<<8}get CL(){return 255&this.CX}set CL(e){this.CX=65280&this.CX|255&e}get CH(){return this.CX>>8&255}set CH(e){this.CX=255&this.CX|(255&e)<<8}get DL(){return 255&this.DX}set DL(e){this.DX=65280&this.DX|255&e}get DH(){return this.DX>>8&255}set DH(e){this.DX=255&this.DX|(255&e)<<8}get FLAGS(){return this.flags.value}getInstructionByte(){return this.getMemByte(this.CS,this.IP)}getAddressByte(){return this.getMemByte(this.CS,this.IP+1&65535)}getName(){return"Intel 80186"}getCurrentCodeAddr(){return this.genAddr(this.CS,this.IP)}getCodeSeg32Bit(){return!1}constructor(e,t){Object.defineProperty(this,"memoryProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"portProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parities",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256)}),Object.defineProperty(this,"flags",{enumerable:!0,configurable:!0,writable:!0,value:new mi}),Object.defineProperty(this,"doReset",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"softInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hardInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instStartIp",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"repeatIp",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"stringOperation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"segOverride",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cpuEvents",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"eventGen",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"AX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"BX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"CX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"DX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"SP",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"BP",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"SI",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"DI",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"IP",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"CS",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"SS",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"ES",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"DS",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"halt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"clockCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"workLoad",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.memoryProvider=e,this.portProvider=t,this.initParities(),this.execReset()}initParities(){for(let e=0;e<256;e++){const t=(0!=(1&e)?1:0)+(0!=(2&e)?1:0)+(0!=(4&e)?1:0)+(0!=(8&e)?1:0)+(0!=(16&e)?1:0)+(0!=(32&e)?1:0)+(0!=(64&e)?1:0)+(0!=(128&e)?1:0);this.parities[e]=0==(1&t)}}reset(){this.doReset=!0}execNextInstruction(){this.execInstructions(1)}genAddr(e,t){return(e<<4)+t&1048575}execReset(){this.cpuEvents.length=0,this.hardInterrupt=null,this.softInterrupt=null,this.blockInterrupt=!1,this.stringOperation=s.None,this.repeatIp=0,this.segOverride=null,this.flags.value=0,this.IP=65520,this.CS=61440,this.DS=this.ES=this.SS=0,this.halt=!1}execInstructions(e){const t=this.clockCount+e;do{try{for(;this.clockCount<t;){this.instStartIp=this.IP;let e,t=this.readNextCodeByte();if(this.doReset)return this.doReset=!1,void this.execReset();do{switch(e=!1,t){case 243:this.clockCount+=gi.Rep,this.stringOperation=s.RepZ,this.repeatIp=this.IP-1&65535,t=this.readNextCodeByte(),e=!0;break;case 242:this.clockCount+=gi.Rep,this.stringOperation=s.RepNz,this.repeatIp=this.IP-1&65535,t=this.readNextCodeByte(),e=!0;break;case 240:this.clockCount+=gi.Lock,t=this.readNextCodeByte(),e=!0;break;case 46:this.clockCount+=gi.SegOverride,this.segOverride=this.CS,t=this.readNextCodeByte(),e=!0;break;case 62:this.clockCount+=gi.SegOverride,this.segOverride=this.DS,t=this.readNextCodeByte(),e=!0;break;case 38:this.clockCount+=gi.SegOverride,this.segOverride=this.ES,t=this.readNextCodeByte(),e=!0;break;case 54:this.clockCount+=gi.SegOverride,this.segOverride=this.SS,t=this.readNextCodeByte(),e=!0;break;case 55:this.clockCount+=gi.Aaa,(15&this.AL)>9||this.flags.AF?(this.AL=this.AL+6,this.AH=this.AH+1,this.flags.CF=!0,this.flags.AF=!0):(this.flags.CF=!1,this.flags.AF=!1),this.AL=15&this.AL,this.calcParitySignZeroFlagW(this.AX);break;case 213:{this.clockCount+=gi.Aad;const e=this.readNextCodeByte();this.AL=this.AH*e+this.AL,this.AH=0,this.calcParitySignZeroFlagW(this.AX);break}case 212:{this.clockCount+=gi.Aam;const e=this.readNextCodeByte();this.AH=this.AL/e,this.AL=this.AL%e,this.calcParitySignZeroFlagW(this.AX);break}case 63:this.clockCount+=gi.Aas,(15&this.AL)>9||this.flags.AF?(this.AL=this.AL-6,this.AH=this.AH-1,this.flags.CF=!0,this.flags.AF=!0):(this.flags.CF=!1,this.flags.AF=!1),this.AL=15&this.AL;break;case 16:this.doByteOperation(i.RegToRm,((e,t)=>this.adcByte(e,t)),gi.AddRmRegReg,gi.AddRmRegMem);break;case 17:this.doWordOperation(i.RegToRm,((e,t)=>this.adcWord(e,t)),gi.AdcRegRmReg,gi.AdcRegRmMem);break;case 18:this.doByteOperation(i.RmToReg,((e,t)=>this.adcByte(e,t)),gi.AddRmRegReg,gi.AddRmRegMem);break;case 19:this.doWordOperation(i.RmToReg,((e,t)=>this.adcWord(e,t)),gi.AddRmRegReg,gi.AddRmRegMem);break;case 20:{this.clockCount+=gi.AddAlImm;const e=this.readNextCodeByte();this.AL=this.adcByte(this.AL,e);break}case 21:{this.clockCount+=gi.AddAxImm;const e=this.readNextCodeWord();this.AX=this.adcWord(this.AX,e);break}case 0:this.doByteOperation(i.RegToRm,((e,t)=>this.addByte(e,t)),gi.AddRmRegReg,gi.AddRmRegMem);break;case 1:this.doWordOperation(i.RegToRm,((e,t)=>this.addWord(e,t)),gi.AddRmRegReg,gi.AddRmRegMem);break;case 2:this.doByteOperation(i.RmToReg,((e,t)=>this.addByte(e,t)),gi.AddRegRmMem,gi.AddRegRmMem);break;case 3:this.doWordOperation(i.RmToReg,((e,t)=>this.addWord(e,t)),gi.AddRegRmReg,gi.AddRegRmMem);break;case 4:{this.clockCount+=gi.AddAlImm;const e=this.readNextCodeByte();this.AL=this.addByte(this.AL,e);break}case 5:{this.clockCount+=gi.AddAxImm;const e=this.readNextCodeWord();this.AX=this.addWord(this.AX,e);break}case 32:this.doByteOperation(i.RegToRm,((e,t)=>{const r=e&t&255;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.AndRmRegReg,gi.AndRmRegMem);break;case 33:this.doWordOperation(i.RegToRm,((e,t)=>{const r=e&t&65535;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.AndRmRegReg,gi.AndRmRegMem);break;case 34:this.doByteOperation(i.RmToReg,((e,t)=>{const r=e&t&255;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.AndRegRmReg,gi.AndRegRmMem);break;case 35:this.doWordOperation(i.RmToReg,((e,t)=>{const r=e&t&65535;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.AndRegRmReg,gi.AndRegRmMem);break;case 36:{this.clockCount+=gi.AndAlImm;const e=this.readNextCodeByte(),t=this.AL&e&255;this.flags.CF=this.flags.OF=!1,this.AL=t,this.calcParitySignZeroFlagB(t);break}case 37:{this.clockCount+=gi.AndAxImm;const e=this.readNextCodeWord(),t=this.AX&e&65535;this.flags.CF=this.flags.OF=!1,this.AX=t,this.calcParitySignZeroFlagW(t)}break;case 98:{this.clockCount+=gi.Bound;const e=this.readAndDecodeAddressByte();3==e.mode&&this.handleIllegalOpcode();let t=this.memoryProvider.peekW(e.rmAddr);t>32767&&(t-=65536);let r=this.memoryProvider.peekW(e.rmAddr+2)+2;r>32767&&(r-=65536);let i=this.getRegWord(e.reg);if(i>32767&&(i-=65536),i<t||i>r)throw this.IP=this.instStartIp,new f(o.BR)}break;case 232:{this.clockCount+=gi.CallNear;let e=this.readNextCodeWord();e>32767&&(e-=65536),this.pushWord(65535&this.IP),this.IP=this.IP+e&65535;break}case 154:this.clockCount+=gi.CallFar;{const e=this.readNextCodeWord(),t=this.readNextCodeWord();this.pushWord(this.CS),this.pushWord(65535&this.IP),this.CS=t,this.IP=e}break;case 152:this.clockCount+=gi.Cbw,this.AL>127?this.AH=255:this.AH=0;break;case 248:this.clockCount+=gi.Clc,this.flags.CF=!1;break;case 252:this.clockCount+=gi.Cld,this.flags.DF=!1;break;case 250:this.clockCount+=gi.Clc,this.flags.IF=!1;break;case 245:this.clockCount+=gi.Cmc,this.flags.CF=!this.flags.CF;break;case 56:this.doByteOperation(i.RegToRm,((e,t)=>(this.subByte(e,t),0)),gi.CmpRmRegReg,gi.CmpRmRegMem,!1);break;case 57:this.doWordOperation(i.RegToRm,((e,t)=>(this.subWord(e,t),0)),gi.CmpRmRegReg,gi.CmpRmRegMem,!1);break;case 58:this.doByteOperation(i.RmToReg,((e,t)=>(this.subByte(e,t),0)),gi.CmpRegRmReg,gi.CmpRegRmMem,!1);break;case 59:this.doWordOperation(i.RmToReg,((e,t)=>(this.subWord(e,t),0)),gi.CmpRegRmReg,gi.CmpRegRmMem,!1);break;case 60:this.clockCount+=gi.CmpAlImm,this.subByte(this.AL,this.readNextCodeByte());break;case 61:{this.clockCount+=gi.CmpAxImm;const e=this.readNextCodeWord();this.subWord(this.AX,e)}break;case 166:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=gi.Cmps,this.subByte(this.getMemByte(this.segOverride??this.DS,this.SI),this.getMemByte(this.ES,this.DI)),this.flags.DF?(this.SI=this.SI-1&65535,this.DI=this.DI-1&65535):(this.SI=this.SI+1&65535,this.DI=this.DI+1&65535),this.handleRepeatCheckZeroFlag()),this.stringOperation=s.None;break;case 167:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=gi.Cmps,this.subWord(this.getMemWord(this.segOverride??this.DS,this.SI),this.getMemWord(this.ES,this.DI)),this.flags.DF?(this.SI=this.SI-2&65535,this.DI=this.DI-2&65535):(this.SI=this.SI+2&65535,this.DI=this.DI+2&65535),this.handleRepeatCheckZeroFlag()),this.stringOperation=s.None;break;case 153:this.clockCount+=gi.Cwd,this.DX=65535&(this.AX>=32768?65535:0);break;case 39:this.clockCount+=gi.Daa,((15&this.AL)>9||this.flags.AF)&&(this.AL=this.AL+6,this.flags.AF=!0),(this.AL>159||this.flags.CF)&&(this.AL=this.AL+96,this.flags.CF=!0),this.calcParitySignZeroFlagB(this.AL);break;case 47:this.clockCount+=gi.Das,((15&this.AL)>9||this.flags.AF)&&(this.AL=this.AL-6,this.flags.AF=!0),(this.AL>159||this.flags.CF)&&(this.AL=this.AL-96,this.flags.CF=!0),this.calcParitySignZeroFlagB(this.AL);break;case 72:this.clockCount+=gi.DecReg,this.AX=this.decWord(this.AX);break;case 73:this.clockCount+=gi.DecReg,this.CX=this.decWord(this.CX);break;case 74:this.clockCount+=gi.DecReg,this.DX=this.decWord(this.DX);break;case 75:this.clockCount+=gi.DecReg,this.BX=this.decWord(this.BX);break;case 76:this.clockCount+=gi.DecReg,this.SP=this.decWord(this.SP);break;case 77:this.clockCount+=gi.DecReg,this.BP=this.decWord(this.BP);break;case 78:this.clockCount+=gi.DecReg,this.SI=this.decWord(this.SI);break;case 79:this.clockCount+=gi.DecReg,this.DI=this.decWord(this.DI);break;case 200:{const e=this.readNextCodeWord();let t=this.readNextCodeByte();this.clockCount+=0==t?gi.EnterLvl0:1==t?gi.EnterLvl1:gi.EnterInitial+gi.EnterPerLvl*(t-1),t&=31,this.pushWord(this.BP);const r=this.SP;if(t>0){for(let e=1;e<t;e++)this.BP=this.BP-2&65535,this.pushWord(this.getMemWord(this.SS,this.BP));this.pushWord(r)}this.BP=r,this.SP=this.SP-e&65535;break}case 244:this.clockCount+=gi.Hlt,this.halt=!0,this.IP=this.IP-1&65535;break;case 107:this.doWordOperation(i.RmToReg,((e,t)=>{t>32767&&(t-=65536);let r=this.readNextCodeByte();r>127&&(r-=256);const i=t*r,s=i>>16&65535;return this.flags.CF=this.flags.OF=0!=s&&65535!=s,this.flags.ZF=!1,65535&i}),gi.ImulImmReg,gi.ImulImmMem);break;case 105:this.doWordOperation(i.RmToReg,((e,t)=>{t>32767&&(t-=65536);let r=this.readNextCodeWord();r>32767&&(r-=65536);const i=t*r,s=i>>16&65535;return this.flags.CF=this.flags.OF=0!=s&&65535!=s,this.flags.ZF=!1,65535&i}),gi.ImulImmReg16,gi.ImulImmMem16);break;case 228:{this.clockCount+=gi.InImm;const e=this.readNextCodeByte();this.AL=this.portProvider.in(e);break}case 229:{this.clockCount+=gi.InImm;const e=this.readNextCodeByte();this.AX=this.portProvider.in(e);break}case 236:this.clockCount+=gi.InDx,this.AL=this.portProvider.in(this.DX);break;case 237:this.clockCount+=gi.InDx,this.AX=this.portProvider.in(this.DX);break;case 64:this.clockCount+=gi.IncReg,this.AX=this.incWord(this.AX);break;case 65:this.clockCount+=gi.IncReg,this.CX=this.incWord(this.CX);break;case 66:this.clockCount+=gi.IncReg,this.DX=this.incWord(this.DX);break;case 67:this.clockCount+=gi.IncReg,this.BX=this.incWord(this.BX);break;case 68:this.clockCount+=gi.IncReg,this.SP=this.incWord(this.SP);break;case 69:this.clockCount+=gi.IncReg,this.BP=this.incWord(this.BP);break;case 70:this.clockCount+=gi.IncReg,this.SI=this.incWord(this.SI);break;case 71:this.clockCount+=gi.IncReg,this.DI=this.incWord(this.DI);break;case 108:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Ins:gi.InsRep,this.setMemByte(this.ES,this.DI,255&this.portProvider.in(this.DX)),this.flags.DF?this.DI=this.DI-1&65535:this.DI=this.DI+1&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 109:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Ins:gi.InsRep,this.setMemWord(this.ES,this.DI,this.portProvider.in(this.DX)),this.flags.DF?this.DI=this.DI-2&65535:this.DI=this.DI+2&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 204:this.clockCount+=gi.Int3,this.doSoftInterrupt(3);break;case 205:this.clockCount+=gi.IntImm,this.doSoftInterrupt(this.readNextCodeByte());break;case 206:this.flags.OF?(this.clockCount+=gi.Into,this.doSoftInterrupt(4)):this.clockCount+=gi.IntoNoInt;break;case 207:this.clockCount+=gi.Iret,this.IP=this.popWord(),this.CS=this.popWord(),this.flags.value=this.popWord(),this.blockInterrupt=!0;break;case 119:this.handleConditionalJump(!this.flags.CF&&!this.flags.ZF);break;case 115:this.handleConditionalJump(!this.flags.CF);break;case 114:this.handleConditionalJump(this.flags.CF);break;case 118:this.handleConditionalJump(this.flags.CF||this.flags.ZF);break;case 227:{let e=this.readNextCodeByte();e>127&&(e-=256),0==this.CX?(this.clockCount+=gi.JcxzMet,this.IP=this.IP+e&65535):this.clockCount+=gi.JcxzNotMet;break}case 116:this.handleConditionalJump(this.flags.ZF);break;case 127:this.handleConditionalJump(!this.flags.ZF&&this.flags.SF==this.flags.OF);break;case 125:this.handleConditionalJump(this.flags.SF==this.flags.OF);break;case 124:this.handleConditionalJump(this.flags.SF!=this.flags.OF);break;case 126:this.handleConditionalJump(this.flags.ZF||this.flags.SF!=this.flags.OF);break;case 235:{this.clockCount+=gi.JmpShort;let e=this.readNextCodeByte();e>127&&(e-=256),this.IP=this.IP+e&65535;break}case 233:{this.clockCount+=gi.JmpNear;let e=this.readNextCodeWord();e>32767&&(e-=65536),this.IP=this.IP+e&65535;break}case 234:this.clockCount+=gi.JmpFar;{const e=this.readNextCodeWord(),t=this.readNextCodeWord();this.CS=t,this.IP=e}break;case 117:this.handleConditionalJump(!this.flags.ZF);break;case 113:this.handleConditionalJump(!this.flags.OF);break;case 121:this.handleConditionalJump(!this.flags.SF);break;case 123:this.handleConditionalJump(!this.flags.PF);break;case 112:this.handleConditionalJump(this.flags.OF);break;case 122:this.handleConditionalJump(this.flags.PF);break;case 120:this.handleConditionalJump(this.flags.SF);break;case 159:this.clockCount+=gi.Lahf,this.AH=this.flags.value;break;case 197:this.DS=this.loadSeg();break;case 141:{this.clockCount+=gi.Lea;const e=this.readNextCodeByte(),t=(192&e)>>6,r=(56&e)>>3,i=7&e;3==t&&this.handleIllegalOpcode();const s=this.calcEa(t,i);this.setRegWord(r,s.ea)}break;case 201:this.clockCount+=gi.Leave,this.SP=this.BP,this.BP=this.popWord();break;case 196:this.ES=this.loadSeg();break;case 172:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Lods:gi.LodsRep,this.AL=this.getMemByte(this.segOverride??this.DS,this.SI),this.flags.DF?this.SI=this.SI-1&65535:this.SI=this.SI+1&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 173:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Lods:gi.LodsRep,this.AX=this.getMemWord(this.segOverride??this.DS,this.SI),this.flags.DF?this.SI=this.SI-2&65535:this.SI=this.SI+2&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 226:{let e=this.readNextCodeByte();e>127&&(e-=256),this.CX=this.CX-1&65535,this.CX>0?(this.clockCount+=gi.Loop,this.IP=this.IP+e&65535):this.clockCount+=gi.LoopFinished;break}case 225:{let e=this.readNextCodeByte();e>127&&(e-=256),this.CX=this.CX-1&65535,this.CX>0&&this.flags.ZF?(this.clockCount+=gi.Loop,this.IP=this.IP+e&65535):this.clockCount+=gi.LoopFinished;break}case 224:{let e=this.readNextCodeByte();e>127&&(e-=256),this.CX=this.CX-1&65535,this.CX>0&&!this.flags.ZF?(this.clockCount+=gi.Loop,this.IP=this.IP+e&65535):this.clockCount+=gi.LoopFinished;break}case 160:{this.clockCount+=gi.MovAxMemoffs;const e=this.readNextCodeWord();this.AL=this.getMemByte(this.segOverride??this.DS,e);break}case 161:{this.clockCount+=gi.MovAxMemoffs;const e=this.readNextCodeWord();this.AX=this.getMemWord(this.segOverride??this.DS,e)}break;case 162:{this.clockCount+=gi.MovMemoffsAx;const e=this.readNextCodeWord();this.setMemByte(this.segOverride??this.DS,e,this.AL);break}case 163:{this.clockCount+=gi.MovMemoffsAx;const e=this.readNextCodeWord();this.setMemWord(this.segOverride??this.DS,e,this.AX)}break;case 176:this.clockCount+=gi.MovRegImm8,this.AL=this.readNextCodeByte();break;case 177:this.clockCount+=gi.MovRegImm8,this.CL=this.readNextCodeByte();break;case 178:this.clockCount+=gi.MovRegImm8,this.DL=this.readNextCodeByte();break;case 179:this.clockCount+=gi.MovRegImm8,this.BL=this.readNextCodeByte();break;case 180:this.clockCount+=gi.MovRegImm8,this.AH=this.readNextCodeByte();break;case 181:this.clockCount+=gi.MovRegImm8,this.CH=this.readNextCodeByte();break;case 182:this.clockCount+=gi.MovRegImm8,this.DH=this.readNextCodeByte();break;case 183:this.clockCount+=gi.MovRegImm8,this.BH=this.readNextCodeByte();break;case 184:this.clockCount+=gi.MovRegImm16,this.AX=this.readNextCodeWord();break;case 185:this.clockCount+=gi.MovRegImm16,this.CX=this.readNextCodeWord();break;case 186:this.clockCount+=gi.MovRegImm16,this.DX=this.readNextCodeWord();break;case 187:this.clockCount+=gi.MovRegImm16,this.BX=this.readNextCodeWord();break;case 188:this.clockCount+=gi.MovRegImm16,this.SP=this.readNextCodeWord();break;case 189:this.clockCount+=gi.MovRegImm16,this.BP=this.readNextCodeWord();break;case 190:this.clockCount+=gi.MovRegImm16,this.SI=this.readNextCodeWord();break;case 191:this.clockCount+=gi.MovRegImm16,this.DI=this.readNextCodeWord();break;case 198:{this.clockCount+=gi.MovRmImm8;const e=this.readAndDecodeAddressByte(),t=this.readNextCodeByte();this.setRmByte(e.mode,e.rm,e.rmAddr,t);break}case 199:{this.clockCount+=gi.MovRmImm16;const e=this.readAndDecodeAddressByte(),t=this.readNextCodeWord();this.setRmWord(e.mode,e.rm,e.rmAddr,t);break}case 136:this.doByteOperationU(i.RegToRm,(e=>e),gi.MovRmRegReg,gi.MovRmRegMem);break;case 137:this.doWordOperationU(i.RegToRm,(e=>e),gi.MovRmRegReg,gi.MovRmRegMem);break;case 138:this.doByteOperationU(i.RmToReg,(e=>e),gi.MovRegRmReg,gi.MovRegRmMem);break;case 139:this.doWordOperationU(i.RmToReg,(e=>e),gi.MovRegRmReg,gi.MovRegRmMem);break;case 140:this.doSegRegWordOperation(i.RegToRm,(e=>e),gi.MovRmSegReg,gi.MovRmSegMem);break;case 142:this.doSegRegWordOperation(i.RmToReg,(e=>e),gi.MovSegRmReg,gi.MovSegRmMem);break;case 164:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?14:8,this.setMemByte(this.ES,this.DI,this.getMemByte(this.segOverride??this.DS,this.SI)),this.flags.DF?(this.SI=this.SI-1&65535,this.DI=this.DI-1&65535):(this.SI=this.SI+1&65535,this.DI=this.DI+1&65535),this.handleRepeat()),this.stringOperation=s.None;break;case 165:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Movs:gi.MovsRep,this.setMemWord(this.ES,this.DI,this.getMemWord(this.segOverride??this.DS,this.SI)),this.flags.DF?(this.SI=this.SI-2&65535,this.DI=this.DI-2&65535):(this.SI=this.SI+2&65535,this.DI=this.DI+2&65535),this.handleRepeat()),this.stringOperation=s.None;break;case 144:this.clockCount+=gi.Nop;break;case 8:this.doByteOperation(i.RegToRm,((e,t)=>{const r=255&(e|t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.OrRmRegReg,gi.OrRmRegMem);break;case 9:this.doWordOperation(i.RegToRm,((e,t)=>{const r=65535&(e|t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.OrRmRegReg,gi.OrRmRegMem);break;case 10:this.doByteOperation(i.RmToReg,((e,t)=>{const r=255&(e|t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.OrRegRmReg,gi.OrRegRmMem);break;case 11:this.doWordOperation(i.RmToReg,((e,t)=>{const r=65535&(e|t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.OrRegRmReg,gi.OrRegRmMem);break;case 12:{this.clockCount+=gi.OrAlImm;const e=this.readNextCodeByte(),t=255&(this.AL|e);this.flags.CF=this.flags.OF=!1,this.AL=t,this.calcParitySignZeroFlagB(this.AL);break}case 13:this.clockCount+=gi.OrAxImm;{const e=this.readNextCodeWord(),t=65535&(this.AX|e);this.flags.CF=this.flags.OF=!1,this.AX=t,this.calcParitySignZeroFlagW(this.AX)}break;case 230:{this.clockCount+=gi.OutImm;const e=this.readNextCodeByte();this.portProvider.out(e,this.AL,!1);break}case 231:{this.clockCount+=gi.OutImm;const e=this.readNextCodeByte();this.portProvider.out(e,this.AX,!0);break}case 238:this.clockCount+=gi.OutDx,this.portProvider.out(this.DX,this.AL,!1);break;case 239:this.clockCount+=gi.OutDx,this.portProvider.out(this.DX,this.AX,!0);break;case 110:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Outs:gi.OutsRep,this.portProvider.out(this.DX,this.getMemByte(this.segOverride??this.DS,this.SI),!1),this.flags.DF?this.SI=this.SI-1&65535:this.SI=this.SI+1&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 111:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Outs:gi.OutsRep,this.portProvider.out(this.DX,this.getMemWord(this.segOverride??this.DS,this.SI),!0),this.flags.DF?this.SI=this.SI-2&65535:this.SI=this.SI+2&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 88:this.clockCount+=gi.PopReg,this.AX=this.popWord();break;case 89:this.clockCount+=gi.PopReg,this.CX=this.popWord();break;case 90:this.clockCount+=gi.PopReg,this.DX=this.popWord();break;case 91:this.clockCount+=gi.PopReg,this.BX=this.popWord();break;case 92:this.clockCount+=gi.PopReg,this.SP=this.popWord();break;case 93:this.clockCount+=gi.PopReg,this.BP=this.popWord();break;case 94:this.clockCount+=gi.PopReg,this.SI=this.popWord();break;case 95:this.clockCount+=gi.PopReg,this.DI=this.popWord();break;case 7:this.clockCount+=gi.PopSeg,this.ES=this.popWord();break;case 23:this.clockCount+=gi.PopSeg,this.SS=this.popWord(),this.blockInterrupt=!0;break;case 31:this.clockCount+=gi.PopSeg,this.DS=this.popWord();break;case 143:{this.clockCount+=gi.PopMem;const e=this.readAndDecodeAddressByte();this.setRmWord(e.mode,e.rm,e.rmAddr,this.popWord());break}case 97:this.clockCount+=gi.Popa,this.DI=this.popWord(),this.SI=this.popWord(),this.BP=this.popWord(),this.SP=this.SP+2&65535,this.BX=this.popWord(),this.DX=this.popWord(),this.CX=this.popWord(),this.AX=this.popWord();break;case 157:this.clockCount+=gi.Popf,this.flags.value=this.popWord();break;case 80:this.clockCount+=gi.PushReg,this.pushWord(this.AX);break;case 81:this.clockCount+=gi.PushReg,this.pushWord(this.CX);break;case 82:this.clockCount+=gi.PushReg,this.pushWord(this.DX);break;case 83:this.clockCount+=gi.PushReg,this.pushWord(this.BX);break;case 84:this.clockCount+=gi.PushReg,this.pushWord(this.SP-2&65535);break;case 85:this.clockCount+=gi.PushReg,this.pushWord(this.BP);break;case 86:this.clockCount+=gi.PushReg,this.pushWord(this.SI);break;case 87:this.clockCount+=gi.PushReg,this.pushWord(this.DI);break;case 6:this.clockCount+=gi.PushSeg,this.pushWord(this.ES);break;case 14:this.clockCount+=gi.PushSeg,this.pushWord(this.CS);break;case 22:this.clockCount+=gi.PushSeg,this.pushWord(this.SS);break;case 30:this.clockCount+=gi.PushSeg,this.pushWord(this.DS);break;case 106:this.clockCount+=gi.PushImm8,this.pushWord(this.readNextCodeByte());break;case 104:this.clockCount+=gi.PushImm16,this.pushWord(this.readNextCodeWord());break;case 96:{this.clockCount+=gi.Pusha;const e=this.SP;this.pushWord(this.AX),this.pushWord(this.CX),this.pushWord(this.DX),this.pushWord(this.BX),this.pushWord(e),this.pushWord(this.BP),this.pushWord(this.SI),this.pushWord(this.DI);break}case 156:this.clockCount+=gi.Pushf,this.pushWord(this.flags.value);break;case 195:this.clockCount+=gi.Ret,this.IP=this.popWord();break;case 194:{this.clockCount+=gi.RetImm;const e=this.readNextCodeWord();this.IP=this.popWord(),this.SP=this.SP+e&65535;break}case 203:this.clockCount+=gi.Retf,this.IP=this.popWord(),this.CS=this.popWord();break;case 202:{this.clockCount+=gi.RetfImm;const e=this.readNextCodeWord();this.IP=this.popWord(),this.CS=this.popWord(),this.SP=this.SP+e&65535;break}case 158:this.clockCount+=gi.Lahf,this.flags.value=65535&(65280&this.flags.value|this.AH);break;case 24:this.doByteOperation(i.RegToRm,((e,t)=>this.sbbByte(e,t)),gi.SbbRmRegReg,gi.SbbRmRegMem);break;case 25:this.doWordOperation(i.RegToRm,((e,t)=>this.sbbWord(e,t)),gi.SbbRmRegReg,gi.SbbRmRegMem);break;case 26:this.doByteOperation(i.RmToReg,((e,t)=>this.sbbByte(e,t)),gi.SbbRegRmReg,gi.SbbRegRmMem);break;case 27:this.doWordOperation(i.RmToReg,((e,t)=>this.sbbWord(e,t)),gi.SbbRegRmReg,gi.SbbRegRmMem);break;case 28:this.clockCount+=gi.SbbAlImm,this.AL=this.sbbByte(this.AL,this.readNextCodeByte());break;case 29:this.clockCount+=gi.SbbAxImm,this.AX=this.sbbWord(this.AX,this.readNextCodeWord());break;case 174:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=gi.Scas,this.subByte(this.AL,this.getMemByte(this.ES,this.DI)),this.flags.DF?this.DI=this.DI-1&65535:this.DI=this.DI+1&65535,this.handleRepeatCheckZeroFlag()),this.stringOperation=s.None;break;case 175:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=gi.Scas,this.subWord(this.AX,this.getMemWord(this.ES,this.DI)),this.flags.DF?this.DI=this.DI-2&65535:this.DI=this.DI+2&65535,this.handleRepeatCheckZeroFlag()),this.stringOperation=s.None;break;case 249:this.clockCount+=gi.SetFlag,this.flags.CF=!0;break;case 253:this.clockCount+=gi.SetFlag,this.flags.DF=!0;break;case 251:this.clockCount+=gi.SetFlag,this.flags.IF=!0,this.blockInterrupt=!0;break;case 170:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Stos:gi.StosRep,this.setMemByte(this.ES,this.DI,this.AL),this.flags.DF?this.DI=this.DI-1&65535:this.DI=this.DI+1&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 171:this.stringOperation!=s.None&&0==this.CX||(this.clockCount+=this.stringOperation==s.None?gi.Stos:gi.StosRep,this.setMemWord(this.ES,this.DI,this.AX),this.flags.DF?this.DI=this.DI-2&65535:this.DI=this.DI+2&65535,this.handleRepeat()),this.stringOperation=s.None;break;case 40:this.doByteOperation(i.RegToRm,((e,t)=>this.subByte(e,t)),gi.SubRmRegReg,gi.SubRmRegMem);break;case 41:this.doWordOperation(i.RegToRm,((e,t)=>this.subWord(e,t)),gi.SubRmRegReg,gi.SubRmRegMem);break;case 42:this.doByteOperation(i.RmToReg,((e,t)=>this.subByte(e,t)),gi.SubRegRmReg,gi.SubRegRmMem);break;case 43:this.doWordOperation(i.RmToReg,((e,t)=>this.subWord(e,t)),gi.SubRegRmReg,gi.SubRegRmMem);break;case 44:{this.clockCount+=gi.SubAlImm;const e=this.readNextCodeByte();this.AL=this.subByte(this.AL,e);break}case 45:this.clockCount+=gi.SubAxImm,this.AX=this.subWord(this.AX,this.readNextCodeWord());break;case 132:this.doByteOperation(i.RegToRm,((e,t)=>{const r=e&t&255;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),0}),gi.TestReg,gi.TestMem,!1);break;case 133:this.doWordOperation(i.RegToRm,((e,t)=>{const r=e&t&65535;return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),0}),gi.TestReg,gi.TestMem,!1);break;case 168:{this.clockCount+=gi.TestAlImm;const e=this.readNextCodeByte(),t=this.AL&e&255;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(t);break}case 169:this.clockCount+=gi.TestAxImm;{const e=this.readNextCodeWord(),t=this.AX&e&65535;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(t)}break;case 155:this.clockCount+=gi.Wait;break;case 145:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.CX,this.CX=e}break;case 146:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.DX,this.DX=e}break;case 147:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.BX,this.BX=e}break;case 148:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.SP,this.SP=e}break;case 149:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.BP,this.BP=e}break;case 150:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.SI,this.SI=e}break;case 151:this.clockCount+=gi.XchgReg;{const e=this.AX;this.AX=this.DI,this.DI=e}break;case 134:{const e=this.readAndDecodeAddressByte();this.clockCount+=3==e.mode?gi.XchgRegRmReg:gi.XchgRegRmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr);this.setRmByte(e.mode,e.rm,e.rmAddr,this.getRegByte(e.reg)),this.setRegByte(e.reg,t);break}case 135:{const e=this.readAndDecodeAddressByte();this.clockCount+=3==e.mode?gi.XchgRegRmReg:gi.XchgRegRmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr);this.setRmWord(e.mode,e.rm,e.rmAddr,this.getRegWord(e.reg)),this.setRegWord(e.reg,t)}break;case 215:this.clockCount+=gi.Xlat,this.AL=this.getMemByte(this.segOverride??this.DS,this.BX+this.AL&65535);break;case 48:this.doByteOperation(i.RegToRm,((e,t)=>{const r=255&(e^t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.XorRmRegReg,gi.XorRmRegMem);break;case 49:this.doWordOperation(i.RegToRm,((e,t)=>{const r=65535&(e^t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.XorRmRegReg,gi.XorRmRegMem);break;case 50:this.doByteOperation(i.RmToReg,((e,t)=>{const r=255&(e^t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r),r}),gi.XorRegRmReg,gi.XorRegRmMem);break;case 51:this.doWordOperation(i.RmToReg,((e,t)=>{const r=65535&(e^t);return this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r),r}),gi.XorRegRmReg,gi.XorRegRmMem);break;case 52:{this.clockCount+=gi.XorAlImm;const e=this.readNextCodeByte(),t=255&(this.AL^e);this.flags.CF=this.flags.OF=!1,this.AL=t,this.calcParitySignZeroFlagB(this.AL);break}case 53:{this.clockCount+=gi.XorAxImm;const e=this.readNextCodeWord(),t=65535&(this.AX^e);this.flags.CF=this.flags.OF=!1,this.AX=t,this.calcParitySignZeroFlagW(this.AX)}break;case 254:this.handleOpcodeFeFf(!1);break;case 255:this.handleOpcodeFeFf(!0);break;case 128:this.handleOpcode80();break;case 129:this.handleOpcode81();break;case 131:this.handleOpcode83();break;case 246:this.handleOpcodeF6();break;case 247:this.handleOpcodeF7();break;case 208:this.handleOpcodeD0();break;case 209:this.handleOpcodeD1();break;case 210:this.handleOpcodeD2();break;case 211:this.handleOpcodeD3();break;case 192:this.handleOpcodeC0();break;case 193:this.handleOpcodeC1();break;case 216:case 217:case 218:case 219:case 220:case 221:case 222:case 223:this.handleFpuInstruction(t);break;default:this.handleIllegalOpcode()}}while(e);this.segOverride=null,this.blockInterrupt?this.blockInterrupt=!1:(this.flags.TF&&this.doSoftInterrupt(1),null==this.softInterrupt&&null==this.hardInterrupt||this.processInterrupt()),0==(15&this.instCount)&&this.handleCpuEvents(),this.instCount++}}catch(e){if(!(e instanceof f))throw e;this.segOverride=null,this.doSoftInterrupt(e.exCode),this.blockInterrupt?this.blockInterrupt=!1:this.processInterrupt(),this.instCount++}}while(this.clockCount<t)}handleIllegalOpcode(){}handleFpuInstruction(e){this.clockCount+=gi.FpuInstruction,this.readNextCodeByte()<192&&(this.IP=this.IP-1&65535,this.readAndDecodeAddressByte())}handleCpuEvents(){for(let e=this.cpuEvents.length-1;e>=0;e--){const t=this.cpuEvents[e];t.clockCount<=this.clockCount&&(t.action(),this.cpuEvents.splice(e,1))}}handleConditionalJump(e){if(e){let e=this.readNextCodeByte();e>127&&(e-=256),this.clockCount+=gi.JumpCondMet,this.IP=this.IP+e&65535}else this.IP=this.IP+1&65535,this.clockCount+=gi.JumpCondNotMet}handleRepeat(){this.stringOperation!=s.None&&(this.CX=this.CX-1&65535,0!=this.CX&&(this.IP=this.repeatIp))}handleRepeatCheckZeroFlag(){this.stringOperation!=s.None&&(this.CX=this.CX-1&65535,0!=this.CX&&(this.stringOperation==s.RepZ&&this.flags.ZF||this.stringOperation==s.RepNz&&!this.flags.ZF)&&(this.IP=this.repeatIp))}processInterrupt(){let e;if(null!=this.softInterrupt)e=this.softInterrupt,this.softInterrupt=null,this.pushWord(this.flags.value);else{if(null==this.hardInterrupt||!this.flags.IF)return;this.clockCount+=gi.HardInterrupt,this.halt&&(this.halt=!1,this.IP=this.IP+1&65535),e=this.hardInterrupt,this.hardInterrupt=null,this.pushWord(this.flags.value)}this.flags.IF=!1,this.flags.TF=!1,this.pushWord(this.CS),this.pushWord(this.IP),this.IP=this.memoryProvider.peekW(4*e),this.CS=this.memoryProvider.peekW(4*e+2)}handleOpcodeFeFf(e){const t=this.readAndDecodeAddressByte();switch(t.reg){case 0:this.clockCount+=3==t.mode?gi.IncReg:gi.IncMem,e?this.setRmWord(t.mode,t.rm,t.rmAddr,this.incWord(this.getRmWord(t.mode,t.rm,t.rmAddr))):this.setRmByte(t.mode,t.rm,t.rmAddr,this.incByte(this.getRmByte(t.mode,t.rm,t.rmAddr)));break;case 1:this.clockCount+=3==t.mode?gi.DecReg:gi.DecMem,e?this.setRmWord(t.mode,t.rm,t.rmAddr,this.decWord(this.getRmWord(t.mode,t.rm,t.rmAddr))):this.setRmByte(t.mode,t.rm,t.rmAddr,this.decByte(this.getRmByte(t.mode,t.rm,t.rmAddr)));break;case 2:this.clockCount+=3==t.mode?gi.CallNearReg:gi.CallNearMem,this.pushWord(this.IP),this.IP=this.getRmWord(t.mode,t.rm,t.rmAddr);break;case 3:{this.clockCount+=gi.CallFarRm,3==t.mode&&this.handleIllegalOpcode(),this.pushWord(this.CS),this.pushWord(this.IP);const e=this.memoryProvider.peekW(t.rmAddr);t.rmAddr+=2;const r=this.memoryProvider.peekW(t.rmAddr);this.CS=r,this.IP=e}break;case 4:this.clockCount+=3==t.mode?gi.JmpNearReg:gi.JmpNearMem,this.IP=this.getRmWord(t.mode,t.rm,t.rmAddr);break;case 5:{this.clockCount+=gi.JmpFarRm,3==t.mode&&this.handleIllegalOpcode();const e=this.memoryProvider.peekW(t.rmAddr),r=this.memoryProvider.peekW(t.rmAddr+2);this.CS=r,this.IP=e}break;case 6:this.clockCount+=gi.PushRm,this.pushWord(this.getRmWord(t.mode,t.rm,t.rmAddr));break;default:this.handleIllegalOpcode()}}handleOpcode80(){const e=this.readAndDecodeAddressByte();switch(e.reg){case 0:{this.clockCount+=3==e.mode?gi.AddRmImmReg:gi.AddRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=this.addByte(t,r);this.setRmByte(e.mode,e.rm,e.rmAddr,i);break}case 1:{this.clockCount+=3==e.mode?gi.OrRmImmReg:gi.OrRmImmMem;const t=255&(this.getRmByte(e.mode,e.rm,e.rmAddr)|this.readNextCodeByte());this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(t),this.setRmByte(e.mode,e.rm,e.rmAddr,t);break}case 2:{this.clockCount+=3==e.mode?gi.AdcRmImmReg:gi.AdcRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=this.adcByte(t,r);this.setRmByte(e.mode,e.rm,e.rmAddr,i);break}case 3:{this.clockCount+=3==e.mode?gi.SbbRmImmReg:gi.SbbRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=this.sbbByte(t,r);this.setRmByte(e.mode,e.rm,e.rmAddr,i);break}case 4:{this.clockCount+=3==e.mode?gi.AndRmImmReg:gi.AndRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr)&this.readNextCodeByte()&255;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(t),this.setRmByte(e.mode,e.rm,e.rmAddr,t);break}case 5:{this.clockCount+=3==e.mode?gi.SubRmImmReg:gi.SubRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=this.subByte(t,r);this.setRmByte(e.mode,e.rm,e.rmAddr,i);break}case 6:{this.clockCount+=3==e.mode?gi.XorRmImmReg:gi.XorRmImmMem;const t=255&(this.getRmByte(e.mode,e.rm,e.rmAddr)^this.readNextCodeByte());this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(t),this.setRmByte(e.mode,e.rm,e.rmAddr,t);break}case 7:{this.clockCount+=3==e.mode?gi.CmpRmImmReg:gi.CmpRmImmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte();this.subByte(t,r);break}default:this.handleIllegalOpcode()}}handleOpcode81(){const e=this.readAndDecodeAddressByte();switch(e.reg){case 0:{this.clockCount+=3==e.mode?gi.AddRmImmReg:gi.AddRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeWord(),i=this.addWord(t,r);this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 1:{this.clockCount+=3==e.mode?gi.OrRmImmReg:gi.OrRmImmMem;const t=65535&(this.getRmWord(e.mode,e.rm,e.rmAddr)|this.readNextCodeWord());this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(t),this.setRmWord(e.mode,e.rm,e.rmAddr,t)}break;case 2:{this.clockCount+=3==e.mode?gi.AdcRmImmReg:gi.AdcRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeWord(),i=this.adcWord(t,r);this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 3:{this.clockCount+=3==e.mode?gi.SbbRmImmReg:gi.SbbRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeWord(),i=this.sbbWord(t,r);this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 4:{this.clockCount+=3==e.mode?gi.AndRmImmReg:gi.AndRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr)&this.readNextCodeWord()&65535;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(t),this.setRmWord(e.mode,e.rm,e.rmAddr,t);break}case 5:{this.clockCount+=3==e.mode?gi.SubRmImmReg:gi.SubRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeWord(),i=this.subWord(t,r);this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 6:{this.clockCount+=3==e.mode?gi.XorRmImmReg:gi.XorRmImmMem;const t=65535&(this.getRmWord(e.mode,e.rm,e.rmAddr)^this.readNextCodeWord());this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(t),this.setRmWord(e.mode,e.rm,e.rmAddr,t);break}case 7:{this.clockCount+=3==e.mode?gi.CmpRmImmReg:gi.CmpRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeWord();this.subWord(t,r);break}default:this.handleIllegalOpcode()}}handleOpcode83(){const e=this.readAndDecodeAddressByte();switch(e.reg){case 0:{this.clockCount+=3==e.mode?gi.AddRmImmReg:gi.AddRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=r>127?r+65280:r,s=this.addWord(t,i);this.setRmWord(e.mode,e.rm,e.rmAddr,s);break}case 1:{this.clockCount+=3==e.mode?gi.OrRmImmReg:gi.OrRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=65535&(t|(r>127?r+65280:r));this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(i),this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 2:{this.clockCount+=3==e.mode?gi.AdcRmImmReg:gi.AdcRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=r>127?r+65280:r,s=this.adcWord(t,i);this.setRmWord(e.mode,e.rm,e.rmAddr,s);break}case 3:{this.clockCount+=3==e.mode?gi.SbbRmImmReg:gi.SbbRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=r>127?r+65280:r,s=this.sbbWord(t,i);this.setRmWord(e.mode,e.rm,e.rmAddr,s);break}case 4:{this.clockCount+=3==e.mode?gi.AndRmImmReg:gi.AndRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=t&(r>127?r+65280:r)&65535;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(i),this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 5:{this.clockCount+=3==e.mode?gi.SubRmImmReg:gi.SubRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=r>127?r+65280:r,s=this.subWord(t,i);this.setRmWord(e.mode,e.rm,e.rmAddr,s);break}case 6:{this.clockCount+=3==e.mode?gi.XorRmImmReg:gi.XorRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=65535&(t^(r>127?r+65280:r));this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(i),this.setRmWord(e.mode,e.rm,e.rmAddr,i);break}case 7:{this.clockCount+=3==e.mode?gi.CmpRmImmReg:gi.CmpRmImmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.readNextCodeByte(),i=r>127?r+65280:r;this.subWord(t,i);break}default:this.handleIllegalOpcode()}}handleOpcodeF6(){const e=this.readAndDecodeAddressByte();switch(e.reg){case 0:{this.clockCount+=3==e.mode?gi.TestRmImmReg:gi.TestRmImmMem;const t=this.readNextCodeByte(),r=this.getRmByte(e.mode,e.rm,e.rmAddr)&t;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagB(r);break}case 2:{this.clockCount+=3==e.mode?gi.NotRmReg:gi.NotRmMem;let t=this.getRmByte(e.mode,e.rm,e.rmAddr);t=255&~t,this.setRmByte(e.mode,e.rm,e.rmAddr,t);break}case 3:{this.clockCount+=3==e.mode?gi.NegRmReg:gi.NegRmMem;const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=this.subByte(0,t);this.setRmByte(e.mode,e.rm,e.rmAddr,r);break}case 4:{this.clockCount+=3==e.mode?gi.MulReg:gi.MulMem;const t=this.AL*this.getRmByte(e.mode,e.rm,e.rmAddr);this.flags.CF=this.flags.OF=t>255,this.flags.ZF=!1,this.AX=65535&t;break}case 5:{this.clockCount+=3==e.mode?gi.ImulReg:gi.ImulMem;let t=this.AL;t>127&&(t-=256);let r=this.getRmByte(e.mode,e.rm,e.rmAddr);r>127&&(r-=256);const i=t*r;this.AX=65535&i,this.flags.CF=this.flags.OF=0!=this.AH&&255!=this.AH,this.flags.ZF=!1;break}case 6:{this.clockCount+=3==e.mode?gi.DivReg:gi.DivMem;const t=this.AX,r=this.getRmByte(e.mode,e.rm,e.rmAddr);if(0==r)this.doSoftInterrupt(0);else{const e=Math.trunc(t/r);e>255?this.doSoftInterrupt(0):(this.AL=e,this.AH=t%r)}break}case 7:{this.clockCount+=3==e.mode?gi.IdivReg:gi.IdivMem;const t=this.AX>32767?this.AX-65536:this.AX;let r=this.getRmByte(e.mode,e.rm,e.rmAddr);if(r>127&&(r-=256),0==r)this.doSoftInterrupt(0);else{const e=Math.trunc(t/r);e>=128||e<-128?this.doSoftInterrupt(0):(this.AL=e,this.AH=t%r)}break}default:this.handleIllegalOpcode()}}handleOpcodeF7(){const e=this.readAndDecodeAddressByte();switch(e.reg){case 0:this.clockCount+=3==e.mode?gi.TestRmImmReg:gi.TestRmImmMem;{const t=this.readNextCodeWord(),r=this.getRmWord(e.mode,e.rm,e.rmAddr)&t;this.flags.CF=this.flags.OF=!1,this.calcParitySignZeroFlagW(r)}break;case 2:{this.clockCount+=3==e.mode?gi.NotRmReg:gi.NotRmMem;let t=this.getRmWord(e.mode,e.rm,e.rmAddr);t=65535&~t,this.setRmWord(e.mode,e.rm,e.rmAddr,t)}break;case 3:{this.clockCount+=3==e.mode?gi.NegRmReg:gi.NegRmMem;const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=this.subWord(0,t);this.setRmWord(e.mode,e.rm,e.rmAddr,r)}break;case 4:{this.clockCount+=3==e.mode?gi.MulReg16:gi.MulMem16;const t=this.AX*this.getRmWord(e.mode,e.rm,e.rmAddr);this.flags.CF=this.flags.OF=t>65535,this.flags.ZF=!1,this.AX=65535&t,this.DX=t>>16&65535}break;case 5:{this.clockCount+=3==e.mode?gi.ImulReg16:gi.ImulMem16;const t=this.AX>32767?this.AX-65536:this.AX;let r=this.getRmWord(e.mode,e.rm,e.rmAddr);r>32767&&(r-=65536);const i=t*r;this.AX=65535&i,this.DX=i>>16&65535,this.flags.CF=this.flags.OF=0!=this.DX&&65535!=this.DX,this.flags.ZF=!1}break;case 6:{this.clockCount+=3==e.mode?gi.DivReg16:gi.DivMem16;const t=(this.DX<<16)+this.AX,r=this.getRmWord(e.mode,e.rm,e.rmAddr);if(0==r)this.doSoftInterrupt(0);else{const e=Math.trunc(t/r);e>65535?this.doSoftInterrupt(0):(this.AX=65535&e,this.DX=t%r&65535)}}break;case 7:{this.clockCount+=3==e.mode?gi.IdivReg16:gi.IdivMem16;const t=(this.DX<<16)+this.AX&4294967295;let r=this.getRmWord(e.mode,e.rm,e.rmAddr);if(r>32767&&(r-=65536),0==r)this.softInterrupt=0;else{const e=Math.trunc(t/r);e>=32768||e<-32768?this.doSoftInterrupt(0):(this.AX=65535&e,this.DX=t%r&65535)}}break;default:this.handleIllegalOpcode()}}handleOpcodeD0(){const e=this.readAndDecodeAddressByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmReg:gi.ShiftRmMem,e.reg){case 0:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=255&(t<<1|t>>7);this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(128&t)>0;break}case 1:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=255&(t>>1|t<<7);this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(1&t)>0;break}case 2:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=(t<<1)+(this.flags.CF?1:0)&255;this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(128&t)>0;break}case 3:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=(t>>1)+(this.flags.CF?128:0)&255;this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(1&t)>0;break}case 4:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=t<<1&255;this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagB(r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(128&t)>0;break}case 5:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=t>>1&255;this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagB(r),this.flags.OF=(128&t)!=(128&r),this.flags.CF=(1&t)>0;break}case 7:{const t=this.getRmByte(e.mode,e.rm,e.rmAddr),r=255&(t>>1|128&t);this.setRmByte(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagB(r),this.flags.OF=!1,this.flags.CF=(1&t)>0;break}default:this.handleIllegalOpcode()}}handleOpcodeD1(){const e=this.readAndDecodeAddressByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmReg:gi.ShiftRmMem,e.reg){case 0:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=65535&(t<<1|t>>15);this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(32768&t)>0;break}case 1:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=65535&(t>>1|t<<15);this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(1&t)>0;break}case 2:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=(t<<1)+(this.flags.CF?1:0)&65535;this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(32768&t)>0;break}case 3:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=(t>>1)+(this.flags.CF?32768:0)&65535;this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(1&t)>0;break}case 4:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=t<<1&65535;this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagW(r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(32768&t)>0;break}case 5:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=t>>1&65535;this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagW(r),this.flags.OF=(32768&t)!=(32768&r),this.flags.CF=(1&t)>0;break}case 7:{const t=this.getRmWord(e.mode,e.rm,e.rmAddr),r=65535&(t>>1|32768&t);this.setRmWord(e.mode,e.rm,e.rmAddr,r),this.calcParitySignZeroFlagW(r),this.flags.OF=!1,this.flags.CF=(1&t)>0;break}default:this.handleIllegalOpcode()}}handleOpcodeC0(){const e=this.readAndDecodeAddressByte(),t=31&this.readNextCodeByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmImmReg+t:gi.ShiftRmImmMem+t,e.reg){case 0:this.rolByte(e.mode,e.rm,e.rmAddr,t);break;case 1:this.rorByte(e.mode,e.rm,e.rmAddr,t);break;case 2:this.rclByte(e.mode,e.rm,e.rmAddr,t);break;case 3:this.rcrByte(e.mode,e.rm,e.rmAddr,t);break;case 4:this.shlByte(e.mode,e.rm,e.rmAddr,t);break;case 5:this.shrByte(e.mode,e.rm,e.rmAddr,t);break;case 7:this.sarByte(e.mode,e.rm,e.rmAddr,t);break;default:this.handleIllegalOpcode()}}handleOpcodeC1(){const e=this.readAndDecodeAddressByte(),t=this.readNextCodeByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmImmReg+t:gi.ShiftRmImmMem+t,e.reg){case 0:this.rolWord(e.mode,e.rm,e.rmAddr,t);break;case 1:this.rorWord(e.mode,e.rm,e.rmAddr,t);break;case 2:this.rclWord(e.mode,e.rm,e.rmAddr,t);break;case 3:this.rcrWord(e.mode,e.rm,e.rmAddr,t);break;case 4:this.shlWord(e.mode,e.rm,e.rmAddr,t);break;case 5:this.shrWord(e.mode,e.rm,e.rmAddr,t);break;case 7:this.sarWord(e.mode,e.rm,e.rmAddr,t);break;default:this.handleIllegalOpcode()}}handleOpcodeD2(){const e=this.readAndDecodeAddressByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmClReg+this.CL:gi.ShiftRmClMem+this.CL,e.reg){case 0:this.rolByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 1:this.rorByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 2:this.rclByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 3:this.rcrByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 4:this.shlByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 5:this.shrByte(e.mode,e.rm,e.rmAddr,this.CL);break;case 7:this.sarByte(e.mode,e.rm,e.rmAddr,this.CL);break;default:this.handleIllegalOpcode()}}handleOpcodeD3(){const e=this.readAndDecodeAddressByte();switch(this.clockCount+=3==e.mode?gi.ShiftRmClReg+this.CL:gi.ShiftRmClMem+this.CL,e.reg){case 0:this.rolWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 1:this.rorWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 2:this.rclWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 3:this.rcrWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 4:this.shlWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 5:this.shrWord(e.mode,e.rm,e.rmAddr,this.CL);break;case 7:this.sarWord(e.mode,e.rm,e.rmAddr,this.CL);break;default:this.handleIllegalOpcode()}}incByte(e){return e=e+1&255,this.calcParitySignZeroFlagB(e),this.flags.OF=128==e,this.flags.AF=0==(15&e),e}incWord(e){return e=e+1&65535,this.calcParitySignZeroFlagW(e),this.flags.OF=32768==e,this.flags.AF=0==(15&e),e}decWord(e){return e=e-1&65535,this.calcParitySignZeroFlagW(e),this.flags.OF=32767==e,this.flags.AF=15==(15&e),e}decByte(e){return e=e-1&255,this.calcParitySignZeroFlagB(e),this.flags.OF=127==e,this.flags.AF=15==(15&e),e}rolByte(e,t,r,i){const s=7&i,a=this.getRmByte(e,t,r),n=255&(a<<s|a>>8-s);this.setRmByte(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=(a&1<<8-s)>0)}rorByte(e,t,r,i){const s=7&i,a=this.getRmByte(e,t,r),n=255&(a>>s|a<<8-s);this.setRmByte(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=(a&1<<s-1)>0)}rclByte(e,t,r,i){const s=(31&i)%9,a=this.getRmByte(e,t,r),n=255&(a<<s|(s>0&&this.flags.CF?1<<s-1:0)|a>>9-s);this.setRmByte(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=(a&1<<8-s)>0)}rcrByte(e,t,r,i){const s=(31&i)%9,a=this.getRmByte(e,t,r),n=255&(a>>s|(s>0&&this.flags.CF?1<<8-s:0)|a<<9-s);this.setRmByte(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=(a&1<<s-1)>0)}shlByte(e,t,r,i){const s=31&i,a=this.getRmByte(e,t,r),n=a<<s&255;this.setRmByte(e,t,r,n),this.calcParitySignZeroFlagB(n),1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=s<=8&&(a&1<<8-s)>0}shrByte(e,t,r,i){const s=31&i,a=this.getRmByte(e,t,r),n=a>>s&255;this.setRmByte(e,t,r,n),this.calcParitySignZeroFlagB(n),1==s&&(this.flags.OF=(128&a)!=(128&n)),this.flags.CF=s>0&&(a&1<<s-1)>0}sarByte(e,t,r,i){const s=31&i,a=this.getRmByte(e,t,r),n=255&(a>>s|((128&a)>0?255<<8-s:0));this.setRmByte(e,t,r,n),this.calcParitySignZeroFlagB(n),this.flags.OF=!1,this.flags.CF=s>0&&(a&1<<s-1)>0}rolWord(e,t,r,i){const s=15&i,a=this.getRmWord(e,t,r),n=65535&(a<<s|a>>16-s);this.setRmWord(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=(a&1<<16-s)>0)}rorWord(e,t,r,i){const s=15&i,a=this.getRmWord(e,t,r),n=65535&(a>>s|a<<16-s);this.setRmWord(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=(a&1<<s-1)>0)}rclWord(e,t,r,i){const s=(31&i)%17,a=this.getRmWord(e,t,r),n=65535&(a<<s|(s>0&&this.flags.CF?1<<s-1:0)|a>>17-s);this.setRmWord(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=(a&1<<16-s)>0)}rcrWord(e,t,r,i){const s=(31&i)%17,a=this.getRmWord(e,t,r),n=65535&(a>>s|(s>0&&this.flags.CF?1<<16-s:0)|a<<17-s);this.setRmWord(e,t,r,n),s>0&&(1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=(a&1<<s-1)>0)}shlWord(e,t,r,i){const s=31&i,a=this.getRmWord(e,t,r),n=a<<s&65535;this.setRmWord(e,t,r,n),this.calcParitySignZeroFlagW(n),1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=s<=16&&(a&1<<16-s)>0}shrWord(e,t,r,i){const s=31&i,a=this.getRmWord(e,t,r),n=a>>s&65535;this.setRmWord(e,t,r,n),this.calcParitySignZeroFlagW(n),1==s&&(this.flags.OF=(32768&a)!=(32768&n)),this.flags.CF=s>0&&(a&1<<s-1)>0}sarWord(e,t,r,i){const s=31&i,a=this.getRmWord(e,t,r),n=65535&(a>>s|((32768&a)>0?65535<<16-s:0));this.setRmWord(e,t,r,n),this.calcParitySignZeroFlagW(n),this.flags.OF=!1,this.flags.CF=s>0&&(a&1<<s-1)>0}subByte(e,t){let r=e-t;const i=(e>127?e-256:e)-(t>127?t-256:t);return this.flags.CF=r<0,this.flags.OF=i>127||i<-128,this.flags.AF=(15&e)-(15&t)<0,r&=255,this.calcParitySignZeroFlagB(r),r}subWord(e,t){let r=e-t;const i=(e>32767?e-65536:e)-(t>32767?t-65536:t);return this.flags.CF=r<0,this.flags.OF=i>32767||i<-32768,this.flags.AF=(15&e)-(15&t)<0,r&=65535,this.calcParitySignZeroFlagW(r),r}sbbByte(e,t){const r=this.flags.CF?1:0;let i=e-t-r;const s=(e>127?e-256:e)-(t>127?t-256:t)-r;return this.flags.CF=i<0,this.flags.OF=s>127||s<-128,this.flags.AF=(15&e)-(15&t)-r<0,i&=255,this.calcParitySignZeroFlagB(i),i}sbbWord(e,t){const r=this.flags.CF?1:0;let i=e-t-r;const s=(e>32767?e-65536:e)-(t>32767?t-65536:t)-r;return this.flags.CF=i<0,this.flags.OF=s>32767||s<-32768,this.flags.AF=(15&e)-(15&t)-r<0,i&=65535,this.calcParitySignZeroFlagW(i),i}addByte(e,t){let r=e+t;const i=(e>127?e-256:e)-(t>127?t-256:t);return this.flags.CF=r>255,this.flags.OF=i>127||i<-128,this.flags.AF=(15&e)+(15&t)>15,r&=255,this.calcParitySignZeroFlagB(r),r}addWord(e,t){let r=e+t;const i=(e>32767?e-65536:e)-(t>32767?t-65536:t);return this.flags.CF=r>65535,this.flags.OF=i>32767||i<-32768,this.flags.AF=(15&e)+(15&t)>15,r&=65535,this.calcParitySignZeroFlagW(r),r}adcByte(e,t){const r=this.flags.CF?1:0;let i=e+t+r;const s=(e>127?e-256:e)-(t>127?t-256:t)+r;return this.flags.CF=i>255,this.flags.OF=s>127||s<-128,this.flags.AF=(15&e)+(15&t)+r>15,i&=255,this.calcParitySignZeroFlagB(i),i}adcWord(e,t){const r=this.flags.CF?1:0;let i=e+t+r;const s=(e>32767?e-65536:e)-(t>32767?t-65536:t)+r;return this.flags.CF=i>65535,this.flags.OF=s>32767||s<-32768,this.flags.AF=(15&e)+(15&t)+r>15,i&=65535,this.calcParitySignZeroFlagW(i),i}loadSeg(){this.clockCount+=gi.Lds;const e=this.readAndDecodeAddressByte();3==e.mode&&this.handleIllegalOpcode();const t=this.memoryProvider.peekW(e.rmAddr);return this.setRegWord(e.reg,t),e.rmAddr+=2,this.memoryProvider.peekW(e.rmAddr)}pushWord(e){this.SP=this.SP-2&65535,this.memoryProvider.pokeW(this.genAddr(this.SS,this.SP),e)}popWord(){const e=this.memoryProvider.peekW(this.genAddr(this.SS,this.SP));return this.SP=this.SP+2&65535,e}calcParitySignZeroFlagB(e){e&=255,this.flags.PF=this.parities[e],this.flags.SF=(128&e)>0,this.flags.ZF=0==e}calcParitySignZeroFlagW(e){e&=65535,this.flags.PF=this.parities[255&e],this.flags.SF=(32768&e)>0,this.flags.ZF=0==e}readAndDecodeAddressByte(){const e=new pi,t=this.readNextCodeByte();return e.mode=(192&t)>>6,e.reg=(56&t)>>3,e.rm=7&t,3==e.mode?e.rmAddr=0:e.rmAddr=this.calcRmAddr(e.mode,e.rm),e}doByteOperationU(e,t,r,s,a=!0){const n=this.readAndDecodeAddressByte();if(this.clockCount+=3==n.mode?r:s,e==i.RegToRm){const e=t(this.getRegByte(n.reg));a&&this.setRmByte(n.mode,n.rm,n.rmAddr,e)}else{const e=t(this.getRmByte(n.mode,n.rm,n.rmAddr));a&&this.setRegByte(n.reg,e)}}doByteOperation(e,t,r,s,a=!0){const n=this.readAndDecodeAddressByte();if(this.clockCount+=3==n.mode?r:s,e==i.RegToRm){const e=t(this.getRmByte(n.mode,n.rm,n.rmAddr),this.getRegByte(n.reg));a&&this.setRmByte(n.mode,n.rm,n.rmAddr,e)}else{const e=t(this.getRegByte(n.reg),this.getRmByte(n.mode,n.rm,n.rmAddr));a&&this.setRegByte(n.reg,e)}}doWordOperationU(e,t,r,s,a=!0){const n=this.readAndDecodeAddressByte();if(this.clockCount+=3==n.mode?r:s,e==i.RegToRm){const e=t(this.getRegWord(n.reg));a&&this.setRmWord(n.mode,n.rm,n.rmAddr,e)}else{const e=t(this.getRmWord(n.mode,n.rm,n.rmAddr));a&&this.setRegWord(n.reg,e)}}doSegRegWordOperation(e,t,r,s,a=!0){const n=this.readAndDecodeAddressByte();if(this.clockCount+=3==n.mode?r:s,e==i.RegToRm){const e=t(this.getSegReg(n.reg));a&&this.setRmWord(n.mode,n.rm,n.rmAddr,e)}else{const e=t(this.getRmWord(n.mode,n.rm,n.rmAddr));a&&this.setSegReg(n.reg,e)}}doWordOperation(e,t,r,s,a=!0){const n=this.readAndDecodeAddressByte();if(this.clockCount+=3==n.mode?r:s,e==i.RegToRm){const e=t(this.getRmWord(n.mode,n.rm,n.rmAddr),this.getRegWord(n.reg));a&&this.setRmWord(n.mode,n.rm,n.rmAddr,e)}else{const e=t(this.getRegWord(n.reg),this.getRmWord(n.mode,n.rm,n.rmAddr));a&&this.setRegWord(n.reg,e)}}calcRmAddr(e,t){const r=this.calcEa(e,t);return this.genAddr(this.segOverride??r.defaultSeg,r.ea)}calcEa(e,t){const r=new yi;switch(e){case 0:switch(t){case 0:return r.defaultSeg=this.DS,r.ea=this.BX+this.SI&65535,r;case 1:return r.defaultSeg=this.DS,r.ea=this.BX+this.DI&65535,r;case 2:return r.defaultSeg=this.SS,r.ea=this.BP+this.SI&65535,r;case 3:return r.defaultSeg=this.SS,r.ea=this.BP+this.DI&65535,r;case 4:return r.defaultSeg=this.DS,r.ea=this.SI,r;case 5:return r.defaultSeg=this.DS,r.ea=this.DI,r;case 6:return r.defaultSeg=this.DS,r.ea=this.readNextCodeWord(),r;case 7:return r.defaultSeg=this.DS,r.ea=this.BX,r}break;case 1:{let e=this.readNextCodeByte();switch(e>127&&(e-=256),t){case 0:return r.defaultSeg=this.DS,r.ea=this.BX+this.SI+e&65535,r;case 1:return r.defaultSeg=this.DS,r.ea=this.BX+this.DI+e&65535,r;case 2:return r.defaultSeg=this.SS,r.ea=this.BP+this.SI+e&65535,r;case 3:return r.defaultSeg=this.SS,r.ea=this.BP+this.DI+e&65535,r;case 4:return r.defaultSeg=this.DS,r.ea=this.SI+e&65535,r;case 5:return r.defaultSeg=this.DS,r.ea=this.DI+e&65535,r;case 6:return r.defaultSeg=this.SS,r.ea=this.BP+e&65535,r;case 7:return r.defaultSeg=this.DS,r.ea=this.BX+e&65535,r}}break;case 2:{const e=this.readNextCodeWord();switch(t){case 0:return r.defaultSeg=this.DS,r.ea=this.BX+this.SI+e&65535,r;case 1:return r.defaultSeg=this.DS,r.ea=this.BX+this.DI+e&65535,r;case 2:return r.defaultSeg=this.SS,r.ea=this.BP+this.SI+e&65535,r;case 3:return r.defaultSeg=this.SS,r.ea=this.BP+this.DI+e&65535,r;case 4:return r.defaultSeg=this.DS,r.ea=this.SI+e&65535,r;case 5:return r.defaultSeg=this.DS,r.ea=this.DI+e&65535,r;case 6:return r.defaultSeg=this.SS,r.ea=this.BP+e&65535,r;case 7:return r.defaultSeg=this.DS,r.ea=this.BX+e&65535,r}}}return r.defaultSeg=this.DS,r.ea=0,r}getRegByte(e){switch(e){case 0:return this.AL;case 1:return this.CL;case 2:return this.DL;case 3:return this.BL;case 4:return this.AH;case 5:return this.CH;case 6:return this.DH;case 7:return this.BH}return 0}setRegByte(e,t){switch(e){case 0:this.AL=t;break;case 1:this.CL=t;break;case 2:this.DL=t;break;case 3:this.BL=t;break;case 4:this.AH=t;break;case 5:this.CH=t;break;case 6:this.DH=t;break;case 7:this.BH=t}}getRmByte(e,t,r){return 3==e?this.getRegByte(t):this.memoryProvider.peek(r)}setRmByte(e,t,r,i){3==e?this.setRegByte(t,i):this.memoryProvider.poke(r,i)}getRegWord(e){switch(e){case 0:return this.AX;case 1:return this.CX;case 2:return this.DX;case 3:return this.BX;case 4:return this.SP;case 5:return this.BP;case 6:return this.SI;case 7:return this.DI}return 0}getSegReg(e){switch(e){case 0:return this.ES;case 1:return this.CS;case 2:return this.SS;case 3:return this.DS}return 0}setRegWord(e,t){switch(e){case 0:this.AX=t;break;case 1:this.CX=t;break;case 2:this.DX=t;break;case 3:this.BX=t;break;case 4:this.SP=t;break;case 5:this.BP=t;break;case 6:this.SI=t;break;case 7:this.DI=t}}setSegReg(e,t){switch(e){case 0:this.ES=t;break;case 1:this.CS=t;break;case 2:this.SS=t,this.blockInterrupt=!0;break;case 3:this.DS=t}}getRmWord(e,t,r){return 3==e?this.getRegWord(t):this.memoryProvider.peekW(r)}setRmWord(e,t,r,i){3==e?this.setRegWord(t,i):this.memoryProvider.pokeW(r,i)}setMemByte(e,t,r){this.memoryProvider.poke(this.genAddr(e,t),r)}setMemWord(e,t,r){this.memoryProvider.pokeW(this.genAddr(e,t),r)}readNextCodeByte(){const e=this.genAddr(this.CS,this.IP);return this.IP=this.IP+1&65535,this.memoryProvider.peek(e)}readNextCodeWord(){const e=this.memoryProvider.peekW(this.genAddr(this.CS,this.IP));return this.IP=this.IP+2&65535,e}getMemByte(e,t){return this.memoryProvider.peek(this.genAddr(e,t))}getMemWord(e,t){return this.memoryProvider.peekW(this.genAddr(e,t))}doSoftInterrupt(e){this.handleSoftInterrupt(e)||(this.softInterrupt=e)}handleSoftInterrupt(e){return 19===e&&4==this.AH&&(this.AH=0,this.flags.CF=!1,!0)}doInterrupt(e){this.hardInterrupt=e}setEvent(e,t){const r=++this.eventGen;return this.cpuEvents.push({action:t,clockCount:this.clockCount+Math.trunc(e*k.cpuFrequency/1e3),id:r}),r}deleteEvent(e){for(let t=0;t<this.cpuEvents.length;t++)if(this.cpuEvents[t].id==e){this.cpuEvents.splice(t,1);break}}}class ki{constructor(e,t){Object.defineProperty(this,"workLoad",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instCount",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"CX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"DX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"SP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"SI",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"DI",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"CS",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"DS",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ES",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"SS",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"IP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"FLAGS",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"halt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clockCount",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}reset(){throw new Error("Method not implemented.")}getCurrentCodeAddr(){throw new Error("Method not implemented.")}getCodeSeg32Bit(){throw new Error("Method not implemented.")}execNextInstruction(){throw new Error("Method not implemented.")}execInstructions(e){throw new Error("Method not implemented.")}getInstructionByte(){throw new Error("Method not implemented.")}getAddressByte(){throw new Error("Method not implemented.")}getName(){throw new Error("Method not implemented.")}doInterrupt(e){throw new Error("Method not implemented.")}setEvent(e,t){throw new Error("Method not implemented.")}deleteEvent(e){throw new Error("Method not implemented.")}}class wi{constructor(){Object.defineProperty(this,"reg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regStr",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rmStr",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}}class Si{get instBytes(){let e="";for(let t=0;t<this.hexValues.length;t++)""!=e&&(e+=" "),e+=this.hexValues[t].toString(16).toUpperCase().padStart(2,"0");return e}get disassembledLine(){const e=this.instBytes.padEnd(this.instructionLineOffset," ");return this.startAddress.toString(16).toUpperCase().padStart(5,"0")+"  "+e+"    "+this.instruction}constructor(e,t){Object.defineProperty(this,"instructionLineOffset",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"cpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"memory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hexValues",{enumerable:!0,configurable:!0,writable:!0,value:Array()}),Object.defineProperty(this,"startAddress",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"localAddress",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"segOverride",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"op32Bit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"addr32Bit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instruction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cpu=e,this.memory=t}doDisassemble(e=-1){this.hexValues.length=0,this.instruction="",this.startAddress=-1==e?this.cpu.getCurrentCodeAddr():e,this.localAddress=this.startAddress;let t,r=this.getNextByte();this.op32Bit=this.addr32Bit=this.cpu.getCodeSeg32Bit();do{switch(t=!1,r){case 243:this.instruction+="REP ",r=this.getNextByte(),t=!0;break;case 242:this.instruction+="REPNZ ",r=this.getNextByte(),t=!0}switch(r){case 240:this.instruction+="LOCK ",r=this.getNextByte(),t=!0;break;case 46:this.segOverride="CS:",r=this.getNextByte(),t=!0;break;case 62:this.segOverride="DS:",r=this.getNextByte(),t=!0;break;case 38:this.segOverride="ES:",r=this.getNextByte(),t=!0;break;case 54:this.segOverride="SS:",r=this.getNextByte(),t=!0;break;case 100:this.segOverride="FS:",r=this.getNextByte(),t=!0;break;case 101:this.segOverride="GS:",r=this.getNextByte(),t=!0}102==r&&(this.op32Bit=!this.op32Bit,r=this.getNextByte(),t=!0),103==r&&(this.addr32Bit=!this.addr32Bit,r=this.getNextByte(),t=!0)}while(t);this.processOpcode(r),this.segOverride=""}processOpcode(e){switch(e){case 55:this.instruction="AAA";break;case 213:this.instruction="AAD";break;case 212:this.instruction="AAM";break;case 63:this.instruction="AAS";break;case 16:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`ADC ${e.rmStr}, ${e.regStr}`}break;case 17:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`ADC ${e.rmStr}, ${e.regStr}`}break;case 18:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`ADC ${e.regStr}, ${e.rmStr}`}break;case 19:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`ADC ${e.regStr}, ${e.rmStr}`}break;case 20:this.instruction=`ADC AL, ${this.getNextByteStr()}`;break;case 21:this.op32Bit?this.instruction=`ADC EAX, ${this.getNextDwordStr()}`:this.instruction=`ADC AX, ${this.getNextWordStr()}`;break;case 0:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`ADD ${e.rmStr}, ${e.regStr}`}break;case 1:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`ADD ${e.rmStr}, ${e.regStr}`}break;case 2:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`ADD ${e.regStr}, ${e.rmStr}`}break;case 3:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`ADD ${e.regStr}, ${e.rmStr}`}break;case 4:this.instruction=`ADD AL, ${this.getNextByteStr()}`;break;case 5:this.instruction=`ADD AX, ${this.getNextWordStr()}`;break;case 32:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`AND ${e.rmStr}, ${e.regStr}`}break;case 33:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`AND ${e.rmStr}, ${e.regStr}`}break;case 34:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`AND ${e.regStr}, ${e.rmStr}`}break;case 35:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`AND ${e.regStr}, ${e.rmStr}`}break;case 36:this.instruction=`AND AL, ${this.getNextByteStr()}`;break;case 37:this.op32Bit?this.instruction=`AND EAX, ${this.getNextDwordStr()}`:this.instruction=`AND AX, ${this.getNextWordStr()}`;break;case 99:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`ARPL ${e.rmStr}, ${e.regStr}`}break;case 98:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BOUND ${e.regStr}, ${e.rmStr}`}break;case 232:this.op32Bit?this.instruction=`CALL ${this.getNextSDwordStr()}`:this.instruction=`CALL ${this.getNextSWordStr()}`;break;case 154:{const e=this.getNextWord(),t=this.getNextWord();this.instruction=`CALL FAR ${this.wordToHex(t)}:${this.wordToHex(e)}`}break;case 152:this.op32Bit?this.instruction="CWDE":this.instruction="CBW";break;case 248:this.instruction="CLC";break;case 252:this.instruction="CLD";break;case 250:this.instruction="CLI";break;case 245:this.instruction="CMC";break;case 56:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`CMP ${e.rmStr}, ${e.regStr}`}break;case 57:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`CMP ${e.rmStr}, ${e.regStr}`}break;case 58:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`CMP ${e.regStr}, ${e.rmStr}`}break;case 59:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`CMP ${e.regStr}, ${e.rmStr}`}break;case 60:this.instruction=`CMP AL, ${this.getNextByteStr()}`;break;case 61:this.op32Bit?this.instruction=`CMP EAX, ${this.getNextDwordStr()}`:this.instruction=`CMP AX, ${this.getNextWordStr()}`;break;case 166:{this.instruction+="CMPSB";const e=this.addr32Bit?"E":"",t=""==this.segOverride?"DS:":this.segOverride;this.instruction+=` ES:[${e}DI], ${t}[${e}SI]`}break;case 167:{this.op32Bit?this.instruction+="CMPSD":this.instruction+="CMPSW";const e=this.addr32Bit?"E":"",t=""==this.segOverride?"DS:":this.segOverride;this.instruction+=` ES:[${e}DI], ${t}[${e}SI]`}break;case 153:this.op32Bit?this.instruction="CDQ":this.instruction="CWD";break;case 39:this.instruction="DAA";break;case 47:this.instruction="DAS";break;case 72:this.instruction=`DEC ${this.prefixOp32()}AX`;break;case 73:this.instruction=`DEC ${this.prefixOp32()}CX`;break;case 74:this.instruction=`DEC ${this.prefixOp32()}DX`;break;case 75:this.instruction=`DEC ${this.prefixOp32()}BX`;break;case 76:this.instruction=`DEC ${this.prefixOp32()}SP`;break;case 77:this.instruction=`DEC ${this.prefixOp32()}BP`;break;case 78:this.instruction=`DEC ${this.prefixOp32()}SI`;break;case 79:this.instruction=`DEC ${this.prefixOp32()}DI`;break;case 200:this.instruction=`ENTER ${this.getNextWordStr()}, ${this.getNextByteStr()}`;break;case 244:this.instruction="HLT";break;case 107:{const e=this.readAndDecodeAddressByte(!1);e.regStr==e.rmStr?this.instruction=`IMUL ${e.regStr}, ${this.getNextByteStr()}`:this.instruction=`IMUL ${e.regStr}, ${e.rmStr}, ${this.getNextByteStr()}`}break;case 105:{const e=this.readAndDecodeAddressByte(!1),t=this.op32Bit?this.getNextDwordStr():this.getNextWordStr();e.regStr==e.rmStr?this.instruction=`IMUL ${e.regStr}, ${t}`:this.instruction=`IMUL ${e.regStr}, ${e.rmStr}, ${t}`}break;case 228:this.instruction=`IN AL, ${this.getNextByteStr()}`;break;case 229:this.instruction=`IN ${this.prefixOp32()}AX, ${this.getNextByteStr()}`;break;case 236:this.instruction="IN AL, DX";break;case 237:this.instruction=`IN ${this.prefixOp32()}AX, DX`;break;case 64:this.instruction=`INC ${this.prefixOp32()}AX`;break;case 65:this.instruction=`INC ${this.prefixOp32()}CX`;break;case 66:this.instruction=`INC ${this.prefixOp32()}DX`;break;case 67:this.instruction=`INC ${this.prefixOp32()}BX`;break;case 68:this.instruction=`INC ${this.prefixOp32()}SP`;break;case 69:this.instruction=`INC ${this.prefixOp32()}BP`;break;case 70:this.instruction=`INC ${this.prefixOp32()}SI`;break;case 71:this.instruction=`INC ${this.prefixOp32()}DI`;break;case 108:this.instruction+="INSB";break;case 109:this.op32Bit?this.instruction+="INSD":this.instruction+="INSW";break;case 204:this.instruction="INT3";break;case 205:this.instruction=`INT ${this.getNextByteStr()}`;break;case 206:this.instruction="INTO";break;case 207:this.op32Bit?this.instruction="IRETD":this.instruction="IRET";break;case 119:this.instruction=`JA ${this.getNextSByteStr()}`;break;case 115:this.instruction=`JAE/JNC ${this.getNextSByteStr()}`;break;case 114:this.instruction=`JB/JC ${this.getNextSByteStr()}`;break;case 118:this.instruction=`JBE ${this.getNextSByteStr()}`;break;case 227:this.instruction=`JCXZ ${this.getNextSByteStr()}`;break;case 116:this.instruction=`JE ${this.getNextSByteStr()}`;break;case 127:this.instruction=`JG ${this.getNextSByteStr()}`;break;case 125:this.instruction=`JGE ${this.getNextSByteStr()}`;break;case 124:this.instruction=`JL ${this.getNextSByteStr()}`;break;case 126:this.instruction=`JLE ${this.getNextSByteStr()}`;break;case 235:this.instruction=`JMP ${this.getNextSByteStr()}`;break;case 233:this.op32Bit?this.instruction=`JMP ${this.getNextSDwordStr()}`:this.instruction=`JMP ${this.getNextSWordStr()}`;break;case 234:if(this.op32Bit){const e=this.getNextDword(),t=this.getNextWord();this.instruction=`JMP FAR ${this.wordToHex(t)}:${this.dwordToHex(e)}`}else{const e=this.getNextWord(),t=this.getNextWord();this.instruction=`JMP FAR ${this.wordToHex(t)}:${this.wordToHex(e)}`}break;case 117:this.instruction=`JNE ${this.getNextSByteStr()}`;break;case 113:this.instruction=`JNO ${this.getNextSByteStr()}`;break;case 121:this.instruction=`JNS ${this.getNextSByteStr()}`;break;case 123:this.instruction=`JNP ${this.getNextSByteStr()}`;break;case 112:this.instruction=`JO ${this.getNextSByteStr()}`;break;case 122:this.instruction=`JP ${this.getNextSByteStr()}`;break;case 120:this.instruction=`JS ${this.getNextSByteStr()}`;break;case 159:this.instruction="LAHF";break;case 197:this.loadSeg("DS");break;case 141:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`LEA ${e.regStr}, ${e.rmStr}`}break;case 201:this.instruction="LEAVE";break;case 196:this.loadSeg("ES");break;case 240:this.instruction="LOCK";break;case 172:this.instruction+="LODSB";{let e="SI";this.addr32Bit&&(e=`E${e}`),""!=this.segOverride?this.instruction+=` ${this.segOverride}[${e}]`:this.addr32Bit&&(this.instruction+=` [${e}]`)}break;case 173:{let e="SI";this.addr32Bit&&(e=`E${e}`),this.op32Bit?this.instruction+="LODSD":this.instruction+="LODSW",""!=this.segOverride?this.instruction+=` ${this.segOverride}[${e}]`:this.addr32Bit&&(this.instruction+=` [${e}]`)}break;case 226:this.instruction=`LOOP ${this.getNextSByteStr()}`;break;case 225:this.instruction=`LOOPZ ${this.getNextSByteStr()}`;break;case 224:this.instruction=`LOOPNZ ${this.getNextSByteStr()}`;break;case 160:this.instruction=`MOV AL, ${this.segOverride}[${this.getNextWordStr()}]`;break;case 161:{const e=this.addr32Bit?this.getNextDwordStr():this.getNextWordStr(),t=this.op32Bit?"EAX":"AX";this.instruction=`MOV ${t}, ${this.segOverride}[${e}]`}break;case 162:this.instruction=`MOV ${this.segOverride}[${this.getNextWordStr()}], AL`;break;case 163:{const e=this.addr32Bit?this.getNextDwordStr():this.getNextWordStr(),t=this.op32Bit?"EAX":"AX";this.instruction=`MOV ${this.segOverride}[${e}], ${t}`}break;case 176:this.instruction=`MOV AL, ${this.getNextByteStr()}`;break;case 177:this.instruction=`MOV CL, ${this.getNextByteStr()}`;break;case 178:this.instruction=`MOV DL, ${this.getNextByteStr()}`;break;case 179:this.instruction=`MOV BL, ${this.getNextByteStr()}`;break;case 180:this.instruction=`MOV AH, ${this.getNextByteStr()}`;break;case 181:this.instruction=`MOV CH, ${this.getNextByteStr()}`;break;case 182:this.instruction=`MOV DH, ${this.getNextByteStr()}`;break;case 183:this.instruction=`MOV BH, ${this.getNextByteStr()}`;break;case 184:this.op32Bit?this.instruction=`MOV EAX, ${this.getNextDwordStr()}`:this.instruction=`MOV AX, ${this.getNextWordStr()}`;break;case 185:this.op32Bit?this.instruction=`MOV ECX, ${this.getNextDwordStr()}`:this.instruction=`MOV CX, ${this.getNextWordStr()}`;break;case 186:this.op32Bit?this.instruction=`MOV EDX, ${this.getNextDwordStr()}`:this.instruction=`MOV DX, ${this.getNextWordStr()}`;break;case 187:this.op32Bit?this.instruction=`MOV EBX, ${this.getNextDwordStr()}`:this.instruction=`MOV BX, ${this.getNextWordStr()}`;break;case 188:this.op32Bit?this.instruction=`MOV ESP, ${this.getNextDwordStr()}`:this.instruction=`MOV SP, ${this.getNextWordStr()}`;break;case 189:this.op32Bit?this.instruction=`MOV EBP, ${this.getNextDwordStr()}`:this.instruction=`MOV BP, ${this.getNextWordStr()}`;break;case 190:this.op32Bit?this.instruction=`MOV ESI, ${this.getNextDwordStr()}`:this.instruction=`MOV SI, ${this.getNextWordStr()}`;break;case 191:this.op32Bit?this.instruction=`MOV EDI, ${this.getNextDwordStr()}`:this.instruction=`MOV DI, ${this.getNextWordStr()}`;break;case 198:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`MOV ${e.rmStr}, ${this.getNextByteStr()}`}break;case 199:{const e=this.readAndDecodeAddressByte(!1);this.op32Bit?this.instruction=`MOV ${e.rmStr}, ${this.getNextDwordStr()}`:this.instruction=`MOV ${e.rmStr}, ${this.getNextWordStr()}`}break;case 136:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`MOV ${e.rmStr}, ${e.regStr}`}break;case 137:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV ${e.rmStr}, ${e.regStr}`}break;case 138:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`MOV ${e.regStr}, ${e.rmStr}`}break;case 139:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV ${e.regStr}, ${e.rmStr}`}break;case 140:{this.op32Bit=!1;const e=this.readAndDecodeAddressByte(!1,!0);this.instruction=`MOV ${e.rmStr}, ${e.regStr}`}break;case 142:{this.op32Bit=!1;const e=this.readAndDecodeAddressByte(!1,!0);this.instruction=`MOV ${e.regStr}, ${e.rmStr}`}break;case 164:this.instruction+="MOVSB";{const e=this.addr32Bit?"E":"",t=""==this.segOverride?"DS:":this.segOverride;this.instruction+=` ES:[${e}DI], ${t}[${e}SI]`}break;case 165:{this.op32Bit?this.instruction+="MOVSD":this.instruction+="MOVSW";const e=this.addr32Bit?"E":"",t=""==this.segOverride?"DS:":this.segOverride;this.instruction+=` ES:[${e}DI], ${t}[${e}SI]`}break;case 144:this.instruction="NOP";break;case 8:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`OR ${e.rmStr}, ${e.regStr}`}break;case 9:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`OR ${e.rmStr}, ${e.regStr}`}break;case 10:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`OR ${e.regStr}, ${e.rmStr}`}break;case 11:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`OR ${e.regStr}, ${e.rmStr}`}break;case 12:this.instruction=`OR AL, ${this.getNextByteStr()}`;break;case 13:this.op32Bit?this.instruction=`OR EAX, ${this.getNextDwordStr()}`:this.instruction=`OR AX, ${this.getNextWordStr()}`;break;case 230:this.instruction=`OUT ${this.getNextByteStr()}, AL`;break;case 231:this.instruction=`OUT ${this.getNextByteStr()}, AX`;break;case 238:this.instruction="OUT DX, AL";break;case 239:this.op32Bit?this.instruction="OUT DX, EAX":this.instruction="OUT DX, AX";break;case 110:this.instruction+="OUTSB",this.addr32Bit&&(this.instruction+=" DX, [ESI]");break;case 111:this.op32Bit?this.instruction+="OUTSD":this.instruction+="OUTSW",this.addr32Bit&&(this.instruction+=" DX, [ESI]");break;case 88:this.instruction=`POP ${this.prefixOp32()}AX`;break;case 89:this.instruction=`POP ${this.prefixOp32()}CX`;break;case 90:this.instruction=`POP ${this.prefixOp32()}DX`;break;case 91:this.instruction=`POP ${this.prefixOp32()}BX`;break;case 92:this.instruction=`POP ${this.prefixOp32()}SP`;break;case 93:this.instruction=`POP ${this.prefixOp32()}BP`;break;case 94:this.instruction=`POP ${this.prefixOp32()}SI`;break;case 95:this.instruction=`POP ${this.prefixOp32()}DI`;break;case 7:this.instruction="POP ES";break;case 23:this.instruction="POP SS";break;case 31:this.instruction="POP DS";break;case 143:{const e=this.readAndDecodeAddressByte(!0);this.op32Bit?this.instruction=`POP DWORD ${e.rmStr}`:this.instruction=`POP ${e.rmStr}`}break;case 97:this.op32Bit?this.instruction="POPAD":this.instruction="POPA";break;case 157:this.op32Bit?this.instruction="POPFD":this.instruction="POPF";break;case 80:this.instruction=`PUSH ${this.prefixOp32()}AX`;break;case 81:this.instruction=`PUSH ${this.prefixOp32()}CX`;break;case 82:this.instruction=`PUSH ${this.prefixOp32()}DX`;break;case 83:this.instruction=`PUSH ${this.prefixOp32()}BX`;break;case 84:this.instruction=`PUSH ${this.prefixOp32()}SP`;break;case 85:this.instruction=`PUSH ${this.prefixOp32()}BP`;break;case 86:this.instruction=`PUSH ${this.prefixOp32()}SI`;break;case 87:this.instruction=`PUSH ${this.prefixOp32()}DI`;break;case 6:this.instruction="PUSH ES";break;case 14:this.instruction="PUSH CS";break;case 22:this.instruction="PUSH SS";break;case 30:this.instruction="PUSH DS";break;case 106:this.instruction=`PUSH ${this.getNextByteStr()}`;break;case 104:this.op32Bit?this.instruction=`PUSH ${this.getNextDwordStr()}`:this.instruction=`PUSH ${this.getNextWordStr()}`;break;case 96:this.op32Bit?this.instruction="PUSHAD":this.instruction="PUSHA";break;case 156:this.op32Bit?this.instruction="PUSHFD":this.instruction="PUSHF";break;case 195:this.instruction="RET";break;case 194:this.instruction=`RET ${this.getNextWordStr()}`;break;case 203:this.instruction="RETF";break;case 202:this.instruction=`RETF ${this.getNextWordStr()}`;break;case 158:this.instruction="SAHF";break;case 24:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`SBB ${e.rmStr}, ${e.regStr}`}break;case 25:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SBB ${e.rmStr}, ${e.regStr}`}break;case 26:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`SBB ${e.regStr}, ${e.rmStr}`}break;case 27:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SBB ${e.regStr}, ${e.rmStr}`}break;case 28:this.instruction=`SBB AL, ${this.getNextByteStr()}`;break;case 29:this.op32Bit?this.instruction=`SBB EAX, ${this.getNextDwordStr()}`:this.instruction=`SBB AX, ${this.getNextWordStr()}`;break;case 174:this.instruction+="SCASB",this.addr32Bit&&(this.instruction+=" [EDI]");break;case 175:this.op32Bit?this.instruction+="SCASD":this.instruction+="SCASW",this.addr32Bit&&(this.instruction+=" [EDI]");break;case 249:this.instruction="STC";break;case 253:this.instruction="STD";break;case 251:this.instruction="STI";break;case 170:this.instruction+="STOSB",this.addr32Bit&&(this.instruction+=" [EDI]");break;case 171:this.op32Bit?this.instruction+="STOSD":this.instruction+="STOSW",this.addr32Bit&&(this.instruction+=" [EDI]");break;case 40:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`SUB ${e.rmStr}, ${e.regStr}`}break;case 41:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SUB ${e.rmStr}, ${e.regStr}`}break;case 42:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`SUB ${e.regStr}, ${e.rmStr}`}break;case 43:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SUB ${e.regStr}, ${e.rmStr}`}break;case 44:this.instruction=`SUB AL, ${this.getNextByteStr()}`;break;case 45:this.op32Bit?this.instruction=`SUB EAX, ${this.getNextDwordStr()}`:this.instruction=`SUB AX, ${this.getNextWordStr()}`;break;case 132:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`TEST ${e.rmStr}, ${e.regStr}`}break;case 133:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`TEST ${e.rmStr}, ${e.regStr}`}break;case 168:this.instruction=`TEST AL, ${this.getNextByteStr()}`;break;case 169:this.op32Bit?this.instruction=`TEST EAX, ${this.getNextDwordStr()}`:this.instruction=`TEST AX, ${this.getNextWordStr()}`;break;case 155:this.instruction="WAIT";break;case 145:this.instruction="XCHG AX, CX";break;case 146:this.instruction="XCHG AX, DX";break;case 147:this.instruction="XCHG AX, BX";break;case 148:this.instruction="XCHG AX, SP";break;case 149:this.instruction="XCHG AX, BP";break;case 150:this.instruction="XCHG AX, SI";break;case 151:this.instruction="XCHG AX, DI";break;case 134:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`XCHG ${e.regStr}, ${e.rmStr}`}break;case 135:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`XCHG ${e.regStr}, ${e.rmStr}`}break;case 215:this.instruction=`XLAT ${this.segOverride}[BX]`;break;case 48:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`XOR ${e.rmStr}, ${e.regStr}`}break;case 49:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`XOR ${e.rmStr}, ${e.regStr}`}break;case 50:{const e=this.readAndDecodeAddressByte(!0);this.instruction=`XOR ${e.regStr}, ${e.rmStr}`}break;case 51:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`XOR ${e.regStr}, ${e.rmStr}`}break;case 52:this.instruction=`XOR AL, ${this.getNextByteStr()}`;break;case 53:this.op32Bit?this.instruction=`XOR EAX, ${this.getNextDwordStr()}`:this.instruction=`XOR AX, ${this.getNextWordStr()}`;break;case 254:this.handleOpcodeFeFf(!1);break;case 255:this.handleOpcodeFeFf(!0);break;case 128:this.handleOpcode80();break;case 129:this.handleOpcode81();break;case 131:this.handleOpcode83();break;case 246:this.handleOpcodeF6();break;case 247:this.handleOpcodeF7();break;case 15:this.handleOpcode0F();break;case 208:this.handleOpcodeD0();break;case 209:this.handleOpcodeD1();break;case 210:this.handleOpcodeD2();break;case 211:this.handleOpcodeD3();break;case 192:this.handleOpcodeC0();break;case 193:this.handleOpcodeC1()}}handleOpcodeFeFf(e){const t=this.readAndDecodeAddressByte(!e);switch(t.reg){case 0:this.op32Bit?this.instruction=`INC DWORD ${t.rmStr}`:this.instruction=`INC ${t.rmStr}`;break;case 1:this.op32Bit?this.instruction=`DEC DWORD ${t.rmStr}`:this.instruction=`DEC ${t.rmStr}`;break;case 4:this.instruction=`JMP ${t.rmStr}`;break;case 2:this.instruction=`CALL ${t.rmStr}`;break;case 3:this.instruction=`CALL FAR ${t.rmStr}`;break;case 5:this.instruction=`JMP FAR ${t.rmStr}`;break;case 6:e&&(this.op32Bit?this.instruction=`PUSH DWORD ${t.rmStr}`:this.instruction=`PUSH ${t.rmStr}`)}}handleOpcode80(){const e=this.readAndDecodeAddressByte(!0),t=this.getNextByteStr();switch(e.reg){case 0:this.instruction=`ADD ${e.rmStr}, ${t}`;break;case 1:this.instruction=`OR ${e.rmStr}, ${t}`;break;case 2:this.instruction=`ADC ${e.rmStr}, ${t}`;break;case 3:this.instruction=`SBC ${e.rmStr}, ${t}`;break;case 4:this.instruction=`AND ${e.rmStr}, ${t}`;break;case 5:this.instruction=`SUB ${e.rmStr}, ${t}`;break;case 6:this.instruction=`XOR ${e.rmStr}, ${t}`;break;case 7:this.instruction=`CMP ${e.rmStr}, ${t}`}}handleOpcode81(){const e=this.readAndDecodeAddressByte(!1),t=this.op32Bit?this.getNextDwordStr():this.getNextWordStr();switch(e.reg){case 0:this.instruction=`ADD ${e.rmStr}, ${t}`;break;case 1:this.instruction=`OR ${e.rmStr}, ${t}`;break;case 2:this.instruction=`ADC ${e.rmStr}, ${t}`;break;case 3:this.instruction=`SBC ${e.rmStr}, ${t}`;break;case 4:this.instruction=`AND ${e.rmStr}, ${t}`;break;case 5:this.instruction=`SUB ${e.rmStr}, ${t}`;break;case 6:this.instruction=`XOR ${e.rmStr}, ${t}`;break;case 7:this.instruction=`CMP ${e.rmStr}, ${t}`}}handleOpcode83(){const e=this.readAndDecodeAddressByte(!1),t=this.getNextByteStr();switch(e.reg){case 0:this.instruction=`ADD ${e.rmStr}, ${t}`;break;case 1:this.instruction=`OR ${e.rmStr}, ${t}`;break;case 2:this.instruction=`ADC ${e.rmStr}, ${t}`;break;case 3:this.instruction=`SBC ${e.rmStr}, ${t}`;break;case 4:this.instruction=`AND ${e.rmStr}, ${t}`;break;case 5:this.instruction=`SUB ${e.rmStr}, ${t}`;break;case 6:this.instruction=`XOR ${e.rmStr}, ${t}`;break;case 7:this.instruction=`CMP ${e.rmStr}, ${t}`}}handleOpcodeF6(){const e=this.readAndDecodeAddressByte(!0);switch(e.reg){case 0:this.instruction=`TEST ${e.rmStr}, ${this.getNextByteStr()}`;break;case 2:this.instruction=`NOT ${e.rmStr}`;break;case 3:this.instruction=`NEG ${e.rmStr}`;break;case 4:this.instruction=`MUL ${e.rmStr}`;break;case 5:this.instruction=`IMUL ${e.rmStr}`;break;case 6:this.instruction=`DIV ${e.rmStr}`;break;case 7:this.instruction=`IDIV ${e.rmStr}`}}handleOpcodeF7(){const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`TEST ${e.rmStr}, ${this.getNextWordStr()}`;break;case 2:this.instruction=`NOT ${e.rmStr}`;break;case 3:this.instruction=`NEG ${e.rmStr}`;break;case 4:this.instruction=`MUL ${e.rmStr}`;break;case 5:this.instruction=`IMUL ${e.rmStr}`;break;case 6:this.instruction=`DIV ${e.rmStr}`;break;case 7:this.instruction=`IDIV ${e.rmStr}`}}handleOpcode0F(){switch(this.getNextByte()){case 0:{const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`SLDT ${e.rmStr}`;break;case 1:this.instruction=`STR ${e.rmStr}`;break;case 2:this.instruction=`LLDT ${e.rmStr}`;break;case 3:this.instruction=`LTR ${e.rmStr}`}}break;case 1:{const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`SGDT ${e.rmStr}`;break;case 1:this.instruction=`SIDT ${e.rmStr}`;break;case 2:this.instruction=`LGDT ${e.rmStr}`;break;case 3:this.instruction=`LIDT ${e.rmStr}`;break;case 4:this.instruction=`SMSW ${e.rmStr}`;break;case 6:this.instruction=`LMSW ${e.rmStr}`}}break;case 2:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`LAR ${e.regStr}, ${e.rmStr}`}break;case 6:this.instruction="CLTS";break;case 9:this.instruction="WBINVD";break;case 32:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`MOV ${e.rmStr}, CR0`;break;case 1:this.instruction=`MOV ${e.rmStr}, CR1`;break;case 2:this.instruction=`MOV ${e.rmStr}, CR2`;break;case 3:this.instruction=`MOV ${e.rmStr}, CR3`}}break;case 33:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV ${e.rmStr}, DR${e.reg}`}break;case 34:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`MOV CR0, ${e.rmStr}`;break;case 1:this.instruction=`MOV CR1, ${e.rmStr}`;break;case 2:this.instruction=`MOV CR2, ${e.rmStr}`;break;case 3:this.instruction=`MOV CR3, ${e.rmStr}`}}break;case 35:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV DR${e.reg}, ${e.rmStr}`}break;case 36:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV ${e.rmStr}, TR${e.reg}`}break;case 38:{this.op32Bit=!0;const e=this.readAndDecodeAddressByte(!1);this.instruction=`MOV TR${e.reg}, ${e.rmStr}`}break;case 128:this.instruction=`JO ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 129:this.instruction=`JNO ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 130:this.instruction=`JB/JC ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 131:this.instruction=`JNB/JNC ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 132:this.instruction=`JE/JZ ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 133:this.instruction=`JNE/JZ ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 134:this.instruction=`JBE ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 135:this.instruction=`JA ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 136:this.instruction=`JS ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 137:this.instruction=`JNS ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 138:this.instruction=`JP ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 139:this.instruction=`JNP ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 140:this.instruction=`JL ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 141:this.instruction=`JGE ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 142:this.instruction=`JLE ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 143:this.instruction=`JG ${this.op32Bit?this.getNextSDwordStr():this.getNextSWordStr()}`;break;case 144:this.instruction=`SETO ${this.getRm8Str()}`;break;case 145:this.instruction=`SETNO ${this.getRm8Str()}`;break;case 146:this.instruction=`SETB/SETC ${this.getRm8Str()}`;break;case 147:this.instruction=`SETNB/SETNC ${this.getRm8Str()}`;break;case 148:this.instruction=`SETE/SETZ ${this.getRm8Str()}`;break;case 149:this.instruction=`SETNE/SETZ ${this.getRm8Str()}`;break;case 150:this.instruction=`SETBE ${this.getRm8Str()}`;break;case 151:this.instruction=`SETA ${this.getRm8Str()}`;break;case 152:this.instruction=`SETS ${this.getRm8Str()}`;break;case 153:this.instruction=`SETNS ${this.getRm8Str()}`;break;case 154:this.instruction=`SETP ${this.getRm8Str()}`;break;case 155:this.instruction=`SETNP ${this.getRm8Str()}`;break;case 156:this.instruction=`SETL ${this.getRm8Str()}`;break;case 157:this.instruction=`SETGE ${this.getRm8Str()}`;break;case 158:this.instruction=`SETLE ${this.getRm8Str()}`;break;case 159:this.instruction=`SETG ${this.getRm8Str()}`;break;case 160:this.instruction="PUSH FS";break;case 161:this.instruction="POP FS";break;case 163:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BT ${e.rmStr}, ${e.regStr}`}break;case 164:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SHLD ${e.rmStr}, ${e.regStr}, ${this.getNextByteStr()}`}break;case 165:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SHLD ${e.rmStr}, ${e.regStr}, CL`}break;case 168:this.instruction="PUSH GS";break;case 169:this.instruction="POP GS";break;case 171:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BTS ${e.rmStr}, ${e.regStr}`}break;case 172:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SHRD ${e.rmStr}, ${e.regStr}, ${this.getNextByteStr()}`}break;case 173:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`SHRD ${e.rmStr}, ${e.regStr}, CL`}break;case 178:this.loadSeg("SS");break;case 179:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BTR ${e.rmStr}, ${e.regStr}`}break;case 180:this.loadSeg("FS");break;case 181:this.loadSeg("GS");break;case 182:{const e=this.getNextByte(),t=this.decodeAddressByte(e,!1),r=this.decodeAddressByte(e,!0,!1,!0);this.instruction=`MOVZX ${t.regStr}, ${r.rmStr}`}break;case 183:{const e=this.getNextByte(),t=this.decodeAddressByte(e,!1);this.op32Bit=!1;const r=this.decodeAddressByte(e,!1,!1,!0);this.instruction=`MOVZX ${t.regStr}, ${r.rmStr}`}break;case 186:{const e=this.readAndDecodeAddressByte(!1),t=this.getNextByteStr();switch(e.reg){case 4:this.instruction=`BT ${e.rmStr}, ${t}`;break;case 5:this.instruction=`BTS ${e.rmStr}, ${t}`;break;case 6:this.instruction=`BTR ${e.rmStr}, ${t}`;break;case 7:this.instruction=`BTC ${e.rmStr}, ${t}`}}break;case 187:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BTC ${e.rmStr}, ${e.regStr}`}break;case 188:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BSF ${e.regStr}, ${e.rmStr}`}break;case 189:{const e=this.readAndDecodeAddressByte(!1);this.instruction=`BSR ${e.regStr}, ${e.rmStr}`}}}handleOpcodeD0(){const e=this.readAndDecodeAddressByte(!0);switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, 1`;break;case 1:this.instruction=`ROR ${e.rmStr}, 1`;break;case 2:this.instruction=`RCL ${e.rmStr}, 1`;break;case 3:this.instruction=`RCR ${e.rmStr}, 1`;break;case 4:this.instruction=`SHL ${e.rmStr}, 1`;break;case 5:this.instruction=`SHR ${e.rmStr}, 1`;break;case 6:this.instruction=`SAL ${e.rmStr}, 1`;break;case 7:this.instruction=`SAR ${e.rmStr}, 1`}}handleOpcodeD1(){const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, 1`;break;case 1:this.instruction=`ROR ${e.rmStr}, 1`;break;case 2:this.instruction=`RCL ${e.rmStr}, 1`;break;case 3:this.instruction=`RCR ${e.rmStr}, 1`;break;case 4:this.instruction=`SHL ${e.rmStr}, 1`;break;case 5:this.instruction=`SHR ${e.rmStr}, 1`;break;case 6:this.instruction=`SAL ${e.rmStr}, 1`;break;case 7:this.instruction=`SAR ${e.rmStr}, 1`}}handleOpcodeD2(){const e=this.readAndDecodeAddressByte(!0);switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, CL`;break;case 1:this.instruction=`ROR ${e.rmStr}, CL`;break;case 2:this.instruction=`RCL ${e.rmStr}, CL`;break;case 3:this.instruction=`RCR ${e.rmStr}, CL`;break;case 4:this.instruction=`SHL ${e.rmStr}, CL`;break;case 5:this.instruction=`SHR ${e.rmStr}, CL`;break;case 6:this.instruction=`SAL ${e.rmStr}, CL`;break;case 7:this.instruction=`SAR ${e.rmStr}, CL`}}handleOpcodeD3(){const e=this.readAndDecodeAddressByte(!1);switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, CL`;break;case 1:this.instruction=`ROR ${e.rmStr}, CL`;break;case 2:this.instruction=`RCL ${e.rmStr}, CL`;break;case 3:this.instruction=`RCR ${e.rmStr}, CL`;break;case 4:this.instruction=`SHL ${e.rmStr}, CL`;break;case 5:this.instruction=`SHR ${e.rmStr}, CL`;break;case 6:this.instruction=`SAL ${e.rmStr}, CL`;break;case 7:this.instruction=`SAR ${e.rmStr}, CL`}}handleOpcodeC0(){const e=this.readAndDecodeAddressByte(!0),t=this.getNextByteStr();switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, ${t}`;break;case 1:this.instruction=`ROR ${e.rmStr}, ${t}`;break;case 2:this.instruction=`RCL ${e.rmStr}, ${t}`;break;case 3:this.instruction=`RCR ${e.rmStr}, ${t}`;break;case 4:this.instruction=`SHL ${e.rmStr}, ${t}`;break;case 5:this.instruction=`SHR ${e.rmStr}, ${t}`;break;case 6:this.instruction=`SAL ${e.rmStr}, ${t}`;break;case 7:this.instruction=`SAR ${e.rmStr}, ${t}`}}handleOpcodeC1(){const e=this.readAndDecodeAddressByte(!1),t=this.getNextByteStr();switch(e.reg){case 0:this.instruction=`ROL ${e.rmStr}, ${t}`;break;case 1:this.instruction=`ROR ${e.rmStr}, ${t}`;break;case 2:this.instruction=`RCL ${e.rmStr}, ${t}`;break;case 3:this.instruction=`RCR ${e.rmStr}, ${t}`;break;case 4:this.instruction=`SHL ${e.rmStr}, ${t}`;break;case 5:this.instruction=`SHR ${e.rmStr}, ${t}`;break;case 6:this.instruction=`SAL ${e.rmStr}, ${t}`;break;case 7:this.instruction=`SAR ${e.rmStr}, ${t}`}}readAndDecodeAddressByte(e,t=!1,r=!1){const i=this.getNextByte();return this.decodeAddressByte(i,e,t,r)}decodeAddressByte(e,t,r=!1,i=!1){const s=(192&e)>>6,a=(56&e)>>3,n=7&e,o=new wi;o.reg=a,o.regStr=t?this.getRegByte(a):this.getRegWord(a,r),o.rmStr="";let h="";switch(i&&(h=t?"BYTE ":this.op32Bit?"DWORD ":"WORD "),s){case 0:if(this.addr32Bit)switch(n){case 0:o.rmStr=this.segOverride+"[EAX]";break;case 1:o.rmStr=this.segOverride+"[ECX]";break;case 2:o.rmStr=this.segOverride+"[EDX]";break;case 3:o.rmStr=this.segOverride+"[EBX]";break;case 4:{const e=this.readSib(s);o.rmStr=this.segOverride+e}break;case 5:{const e=this.getNextDword();o.rmStr=`${this.segOverride}[${this.dwordToHex(e)}]`}break;case 6:o.rmStr=this.segOverride+"[ESI]";break;case 7:o.rmStr=this.segOverride+"[EDI]"}else switch(n){case 0:o.rmStr=this.segOverride+"[BX + SI]";break;case 1:o.rmStr=this.segOverride+"[BX + DI]";break;case 2:o.rmStr=this.segOverride+"[BP + SI]";break;case 3:o.rmStr=this.segOverride+"[BP + DI]";break;case 4:o.rmStr=this.segOverride+"[SI]";break;case 5:o.rmStr=this.segOverride+"[DI]";break;case 6:{const e=this.getNextWord();o.rmStr=`${this.segOverride}[${this.wordToHex(e)}]`}break;case 7:o.rmStr=this.segOverride+"[BX]"}o.rmStr=h+o.rmStr;break;case 1:if(this.addr32Bit)switch(n){case 0:o.rmStr=`${this.segOverride}[EAX ${this.getNextSByteStr()}]`;break;case 1:o.rmStr=`${this.segOverride}[ECX ${this.getNextSByteStr()}]`;break;case 2:o.rmStr=`${this.segOverride}[EDX ${this.getNextSByteStr()}]`;break;case 3:o.rmStr=`${this.segOverride}[EBX ${this.getNextSByteStr()}]`;break;case 4:{const e=this.readSib(s);o.rmStr=this.segOverride+e+" "+this.getNextSByteStr()}break;case 5:o.rmStr=`${this.segOverride}[EBP ${this.getNextSByteStr()}]`;break;case 6:o.rmStr=`${this.segOverride}[BSI ${this.getNextSByteStr()}]`;break;case 7:o.rmStr=`${this.segOverride}[BDI ${this.getNextSByteStr()}]`}else{const e=this.getNextByte();switch(n){case 0:o.rmStr=`${this.segOverride}[BX + SI ${this.sByteToHex(e)}]`;break;case 1:o.rmStr=`${this.segOverride}[BX + DI ${this.sByteToHex(e)}]`;break;case 2:o.rmStr=`${this.segOverride}[BP + SI ${this.sByteToHex(e)}]`;break;case 3:o.rmStr=`${this.segOverride}[BP + DI ${this.sByteToHex(e)}]`;break;case 4:o.rmStr=`${this.segOverride}[SI ${this.sByteToHex(e)}]`;break;case 5:o.rmStr=`${this.segOverride}[DI ${this.sByteToHex(e)}]`;break;case 6:o.rmStr=`${this.segOverride}[BP ${this.sByteToHex(e)}]`;break;case 7:o.rmStr=`${this.segOverride}[BX ${this.sByteToHex(e)}]`}}o.rmStr=h+o.rmStr;break;case 2:if(this.addr32Bit)switch(n){case 0:o.rmStr=`${this.segOverride}[EAX ${this.getNextSDwordStr()}]`;break;case 1:o.rmStr=`${this.segOverride}[ECX ${this.getNextSDwordStr()}]`;break;case 2:o.rmStr=`${this.segOverride}[EDX ${this.getNextSDwordStr()}]`;break;case 3:o.rmStr=`${this.segOverride}[EBX ${this.getNextSDwordStr()}]`;break;case 4:{const e=this.readSib(s);o.rmStr=this.segOverride+this.getNextDwordStr()+e}break;case 5:o.rmStr=`${this.segOverride}[EBP ${this.getNextSDwordStr()}]`;break;case 6:o.rmStr=`${this.segOverride}[ESI ${this.getNextSDwordStr()}]`;break;case 7:o.rmStr=`${this.segOverride}[EDI ${this.getNextSDwordStr()}]`}else{const e=this.getNextWord();switch(n){case 0:o.rmStr=`${this.segOverride}[BX + SI ${this.sWordToHex(e)}]`;break;case 1:o.rmStr=`${this.segOverride}[BX + DI ${this.sWordToHex(e)}]`;break;case 2:o.rmStr=`${this.segOverride}[BP + SI ${this.sWordToHex(e)}]`;break;case 3:o.rmStr=`${this.segOverride}[BP + DI ${this.sWordToHex(e)}]`;break;case 4:o.rmStr=`${this.segOverride}[SI ${this.sWordToHex(e)}]`;break;case 5:o.rmStr=`${this.segOverride}[DI ${this.sWordToHex(e)}]`;break;case 6:o.rmStr=`${this.segOverride}[BP ${this.sWordToHex(e)}]`;break;case 7:o.rmStr=`${this.segOverride}[BX ${this.sWordToHex(e)}]`}}o.rmStr=h+o.rmStr;break;case 3:o.rmStr=t?this.getRegByte(n):this.getRegWord(n)}return o}readSib(e){const t=this.getNextByte(),r=t>>3&7,i=t>>6&3;let s="";switch(7&t){case 0:s+="[EAX]";break;case 1:s+="[ECX]";break;case 2:s+="[EDX]";break;case 3:s+="[EBX]";break;case 4:s+="[ESP]";break;case 5:s+=0==e?this.getNextDwordStr():"[EBP]";break;case 6:s+="[ESI]";break;case 7:s+="[EDI]"}switch(s+="[",r){case 0:s+="EAX";break;case 1:s+="ECX";break;case 2:s+="EDX";break;case 3:s+="EBX";break;case 5:s+="EBP";break;case 6:s+="ESI";break;case 7:s+="EDI"}switch(i){case 0:s+="*1";break;case 1:s+="*2";break;case 2:s+="*4";break;case 3:s+="*8"}return s+="]",s}getRegByte(e){switch(e){case 0:return"AL";case 1:return"CL";case 2:return"DL";case 3:return"BL";case 4:return"AH";case 5:return"CH";case 6:return"DH";case 7:return"BH"}return""}getRegWord(e,t=!1){if(!t){let t="";switch(e){case 0:t="AX";break;case 1:t="CX";break;case 2:t="DX";break;case 3:t="BX";break;case 4:t="SP";break;case 5:t="BP";break;case 6:t="SI";break;case 7:t="DI"}return this.op32Bit&&(t=`E${t}`),t}switch(e){case 0:return"ES";case 1:return"CS";case 2:return"SS";case 3:return"DS";case 4:return"FS";case 5:return"GS"}return""}loadSeg(e){{const t=this.readAndDecodeAddressByte(!1);this.instruction=`L${e} ${t.regStr}, ${t.rmStr}`}}getRm8Str(){return this.readAndDecodeAddressByte(!0).rmStr}byteToHex(e){return`${(255&e).toString(16).toUpperCase().padStart(2,"0")}h`}wordToHex(e){return`${(65535&e).toString(16).toUpperCase().padStart(4,"0")}h`}dwordToHex(e){return`${(4294967295&e).toString(16).toUpperCase().padStart(8,"0")}h`}sByteToHex(e){return e>127?`- ${(256-e).toString(16).toUpperCase().padStart(2,"0")}h`:`+ ${e.toString(16).toUpperCase().padStart(2,"0")}h`}sWordToHex(e){return e>32767?`- ${(65536-e).toString(16).toUpperCase().padStart(4,"0")}h`:`+ ${e.toString(16).toUpperCase().padStart(4,"0")}h`}sDwordToHex(e){return(e|=0)<0?`- ${(-e).toString(16).toUpperCase().padStart(8,"0")}h`:`+ ${e.toString(16).toUpperCase().padStart(8,"0")}h`}getNextByte(){const e=this.memory.peek(this.localAddress++);return this.hexValues.push(e),255&e}getNextSByteStr(){return this.sByteToHex(this.getNextByte())}getNextByteStr(){return this.byteToHex(this.getNextByte())}getNextWord(){const e=this.memory.peek(this.localAddress++);this.hexValues.push(e);const t=this.memory.peek(this.localAddress++);return this.hexValues.push(t),e+(t<<8)&65535}getNextSWordStr(){return this.sWordToHex(this.getNextWord())}getNextWordStr(){return this.wordToHex(this.getNextWord())}getNextDword(){return this.getNextWord()+(this.getNextWord()<<16)&4294967295}getNextSDwordStr(){return this.sDwordToHex(this.getNextDword())}getNextDwordStr(){return this.dwordToHex(this.getNextDword())}prefixOp32(){return this.op32Bit?"E":""}}class Ri{constructor(){Object.defineProperty(this,"r",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"g",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"b",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:0})}static fromRgb(e,t,r){const i=new Ri;return i.r=255&e,i.g=255&t,i.b=255&r,i.value=i.r+(i.g<<8)+(i.b<<16)+4278190080&4294967295,i}}class Oi{constructor(e,t,r,i){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.x=e,this.y=t,this.width=r,this.height=i}}class Ci extends p{constructor(){super(),Object.defineProperty(this,"cursorBlinkDelay",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"ignoredFields",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"ignoredFieldsUpdate",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"ram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cursorOn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cursorSwitchCountdown",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cursorSwitchStartValue",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"charCache",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"crtIndexReg",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"crtRegisters",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(25)}),Object.defineProperty(this,"startAddr",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"ramSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"screenWidth",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"screenHeight",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"charWidth",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"charHeight",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"supportWrite",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"supportRead",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.cursorOn=!0,this.fillIgnoredFields(),this.ignoredFields.forEach((e=>this.ignoredFieldsUpdate.add(e)))}fillIgnoredFields(){this.ignoredFields.add("ignoredFields"),this.ignoredFields.add("ignoredFieldsUpdate"),this.ignoredFields.add("ram"),this.ignoredFields.add("charCache"),this.ignoredFieldsUpdate.add("cursorOn"),this.ignoredFieldsUpdate.add("cursorSwitchStartValue"),this.ignoredFieldsUpdate.add("cursorSwitchCountdown")}setRamSize(e){this.ramSize=e,this.ram=new Uint8Array(this.ramSize)}getCursorStart(){return this.crtRegisters[10]}getCursorEnd(){return this.crtRegisters[11]}getCursorPos(){return(this.crtRegisters[14]<<8)+this.crtRegisters[15]}setScreenUpdateRate(e){this.cursorSwitchStartValue=Math.trunc(this.cursorBlinkDelay*e/1e3)}loadCharSet(){}peek(e){return e>=this.startAddr&&e<this.startAddr+this.ramSize?this.ram[e-this.startAddr]:0}poke(e,t){e>=this.startAddr&&e<this.startAddr+this.ramSize&&(this.ram[e-this.startAddr]=t)}loadCharSetInternal(e,t,r,i){return new Promise(((r,i)=>{const s=new XMLHttpRequest;s.responseType="text",s.open("GET",k.baseDir+t,!0),s.onload=()=>{if(200!=s.status)return void i();const t=s.response.split(/\r?\n/);if(t.length>=256)for(let r=0;r<256;r++){const i=t[r].split(","),s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]="1"==i[e];e[r]=s}r()},s.onerror=()=>{i()},s.send()}))}drawChar(e,t,r,i,s=!1,a=!1){const n=this.calcTextCharHash(r,i,e);if(!s&&!a){const e=this.charCache.get(n);if(e)return e}const o=new Uint32Array(this.charWidth*this.charHeight);let h=0,c=0,l=!1;const d=this.getCursorStart(),u=this.getCursorEnd();for(let e=0;e<this.charHeight;e++){a&&d<this.charHeight&&u<this.charHeight&&(l=d<=u?e>=d&&e<=u:e<=u||e>=d);const n=s&&e==this.charHeight-1||l;for(let e=0;e<this.charWidth;e++){const e=n||t[h]?r:i;h++,o[c++]=e.value}}return s||a||this.charCache.set(n,o),o}writePixels(e,t,r,i){const s=new Uint8Array(r.buffer);let a=4*(i.x+i.y*t),n=0;for(let r=0;r<i.height;r++)e.set(s.subarray(n,n+4*i.width),a),n+=4*i.width,a+=4*t}setIndexRegister(e){this.crtIndexReg=31&e}setDataRegister(e){this.crtIndexReg<this.crtRegisters.length&&(this.crtRegisters[this.crtIndexReg]=e)}getDataRegister(){return this.crtIndexReg>=12&&this.crtIndexReg<=15?this.crtRegisters[this.crtIndexReg]:0}updateDimensions(){}getJsonInitial(){return JSON.stringify(this,((e,t)=>{if(!this.ignoredFields.has(e))return"eventTimer"==e?{clockCount:this.eventTimer.clockCount}:t}))}getJsonUpdate(){return JSON.stringify(this,((e,t)=>{if(!this.ignoredFieldsUpdate.has(e))return"eventTimer"==e?{clockCount:this.eventTimer.clockCount}:t}))}applyJson(e){const t=JSON.parse(e);Object.assign(this,t)}getMemoryData(){return[this.ram.buffer]}updateMemory(e){this.ram=new Uint8Array(e[0])}updateScreen(e,t){this.cursorSwitchStartValue>0&&(0==this.cursorSwitchCountdown&&(this.cursorOn=!this.cursorOn,this.cursorSwitchCountdown=this.cursorSwitchStartValue),this.cursorSwitchCountdown--)}calcTextCharHash(e,t,r){return e.r+256*e.g+65536*e.b+t.r*2**24+t.g*2**32+t.b*2**40+r*2**48}}class Pi extends Ci{constructor(){super(),Object.defineProperty(this,"charsetFile",{enumerable:!0,configurable:!0,writable:!0,value:"Fonts/mda.dat"}),Object.defineProperty(this,"charsetWidth",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"charsetHeight",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"charset",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256)}),Object.defineProperty(this,"horRetrace",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"textHiColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"textColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"backgroundColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.startAddr=720896,this.setRamSize(4096),this.charWidth=9,this.charHeight=14,this.screenWidth=80*this.charWidth,this.screenHeight=25*this.charHeight,this.textColor=Ri.fromRgb(50,205,50),this.textHiColor=Ri.fromRgb(0,255,0),this.backgroundColor=Ri.fromRgb(0,0,0)}fillIgnoredFields(){super.fillIgnoredFields(),this.ignoredFields.add("charsetFile"),this.ignoredFieldsUpdate.add("charset")}async loadCharSet(){await this.loadCharSetInternal(this.charset,this.charsetFile,this.charsetWidth,this.charsetHeight)}updateScreen(e,t){super.updateScreen(e,t);const r=this.screenWidth/this.charWidth,i=this.screenHeight/this.charHeight,s=new Oi(0,0,this.charWidth,this.charHeight),a=2*this.getCursorPos();let n=0;for(let o=0;o<i;o++)for(let i=0;i<r;i++){const r=this.ram[n+1],h=7&r,c=r>>4&7;let l=(8&r)>0?this.textHiColor:this.textColor,d=this.backgroundColor;if(0==h&&7==c){const e=l;l=d,d=e}const u=this.ram[n],b=this.charset[u],m=this.drawChar(u,b,l,d,1==h&&0==c,n==a&&this.cursorOn);s.x=i*this.charWidth,s.y=o*this.charHeight,this.writePixels(e,t,m,s),n+=2}}in(e){return 954===e?(this.horRetrace=1-this.horRetrace,255&(this.horRetrace|this.horRetrace<<3)):0}out(e,t,r){switch(e){case 948:this.setIndexRegister(255&t);break;case 949:this.setDataRegister(255&t)}}}class Ai extends p{constructor(e){super(),Object.defineProperty(this,"basePort",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.basePort=e}in(e){const t=new Date;switch(e-this.basePort){case 0:return this.calcBcd(t.getMilliseconds()%100);case 1:return this.calcBcd(Math.trunc(t.getMilliseconds()/10));case 2:return this.calcBcd(t.getSeconds());case 3:return this.calcBcd(t.getMinutes());case 4:return this.calcBcd(t.getHours());case 5:return this.calcBcd((t.getDay()+6)%7+1);case 6:return this.calcBcd(t.getDate());case 7:return this.calcBcd(t.getMonth());case 9:return this.calcBcd(t.getFullYear()%100);case 16:case 20:return 0}return 0}calcBcd(e){return e%10+(Math.trunc(e/10)<<4)&255}out(e,t,r){}}class Bi extends Ci{constructor(){super(),Object.defineProperty(this,"screenFrequency",{enumerable:!0,configurable:!0,writable:!0,value:60}),Object.defineProperty(this,"screenUpdateClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"lineClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"vertRetraceClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"vertBlankClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"horRetraceClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"horAreaStartClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"horAreaEndClocks",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"blink",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"colCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"lineCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cgaColors",{enumerable:!0,configurable:!0,writable:!0,value:new Array(16)}),this.initCgaColors()}modeChanged(){}calcRetraceValues(){0!=this.lineCount&&(this.screenUpdateClocks=Math.trunc(1e3*k.cpuFrequency/this.screenFrequency),this.vertRetraceClocks=Math.trunc(this.screenUpdateClocks/50),this.vertBlankClocks=Math.trunc(this.screenUpdateClocks/100),this.lineClocks=Math.trunc((this.screenUpdateClocks-this.vertRetraceClocks-this.vertBlankClocks)/this.lineCount),this.horRetraceClocks=Math.trunc(this.lineClocks/5),this.horAreaStartClocks=this.vertRetraceClocks+Math.trunc(this.vertBlankClocks/2),this.horAreaEndClocks=this.horAreaStartClocks+this.lineClocks*this.lineCount)}calcVertRetrace(){return 0!=this.screenUpdateClocks&&this.eventTimer.clockCount%this.screenUpdateClocks<this.vertRetraceClocks}initCgaColors(){this.cgaColors[0]=Ri.fromRgb(0,0,0),this.cgaColors[1]=Ri.fromRgb(0,0,170),this.cgaColors[2]=Ri.fromRgb(0,170,0),this.cgaColors[3]=Ri.fromRgb(0,170,170),this.cgaColors[4]=Ri.fromRgb(170,0,0),this.cgaColors[5]=Ri.fromRgb(170,0,170),this.cgaColors[6]=Ri.fromRgb(170,85,0),this.cgaColors[7]=Ri.fromRgb(170,170,170),this.cgaColors[8]=Ri.fromRgb(85,85,85),this.cgaColors[9]=Ri.fromRgb(85,85,255),this.cgaColors[10]=Ri.fromRgb(85,255,85),this.cgaColors[11]=Ri.fromRgb(85,255,255),this.cgaColors[12]=Ri.fromRgb(255,85,85),this.cgaColors[13]=Ri.fromRgb(255,85,255),this.cgaColors[14]=Ri.fromRgb(255,255,85),this.cgaColors[15]=Ri.fromRgb(255,255,255)}getCgaGraphicsColors(e){const t=(16&e)>0?8:0,r=e>>5&1,i=new Array(4);return i[0]=this.cgaColors[15&e],0==r?(i[1]=this.cgaColors[2+t],i[2]=this.cgaColors[4+t],i[3]=this.cgaColors[6+t]):(i[1]=this.cgaColors[3+t],i[2]=this.cgaColors[5+t],i[3]=this.cgaColors[7+t]),i}}Object.defineProperty(Bi,"dataBuffer",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),function(e){e[e.None=0]="None",e[e.Text40x25=1]="Text40x25",e[e.Text80x25=2]="Text80x25",e[e.GraphicsLo=3]="GraphicsLo",e[e.GraphicsHi=4]="GraphicsHi"}(qr||(qr={}));class Ii extends Bi{constructor(){super(),Object.defineProperty(this,"charsetFile1",{enumerable:!0,configurable:!0,writable:!0,value:"Fonts/cga1.dat"}),Object.defineProperty(this,"charsetFile2",{enumerable:!0,configurable:!0,writable:!0,value:"Fonts/cga2.dat"}),Object.defineProperty(this,"charsetWidth",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"charsetHeight",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"horRetrace",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"colorSelectRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"modeControlRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blackWhite",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"charset1",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256)}),Object.defineProperty(this,"charset2",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256)}),Object.defineProperty(this,"activeCharsetNo",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.startAddr=753664,this.setRamSize(16384),this.charWidth=8,this.charHeight=8,this.activeCharsetNo=1,this.lineCount=200}fillIgnoredFields(){super.fillIgnoredFields(),this.ignoredFields.add("charsetFile1"),this.ignoredFields.add("charsetFile2"),this.ignoredFieldsUpdate.add("charset1"),this.ignoredFieldsUpdate.add("charset2")}modeChanged(){super.modeChanged(),this.calcRetraceValues(),this.charCache.clear()}getCharset(){return 0==this.activeCharsetNo?this.charset1:this.charset2}updateScreenGraphicsLo(e){const t=this.getCgaGraphicsColors(this.colorSelectRegister),r=new Uint32Array(e.buffer);let i=0,s=0,a=8192;for(let e=0;e<200;e++){let n=0==(1&e)?s:a;for(let e=0;e<320;e+=4){const e=this.ram[n];let s;s=t[e>>6],r[i++]=s.value,s=t[e>>4&3],r[i++]=s.value,s=t[e>>2&3],r[i++]=s.value,s=t[3&e],r[i++]=s.value,n++}e%2==0?s=n:a=n}}updateScreenGraphicsHi(e){const t=this.cgaColors[15&this.colorSelectRegister],r=new Uint32Array(e.buffer);let i=0,s=0,a=8192;for(let e=0;e<200;e++){let n=0==(1&e)?s:a;for(let e=0;e<640;e+=8){let e=this.ram[n];for(let s=0;s<8;s++)(128&e)>0&&(r[i]=t.value),i++,e<<=1;n++}e%2==0?s=n:a=n}}updateTextScreen(e,t,r,i,s,a){const n=new Oi(0,0,this.charWidth,this.charHeight),o=2*this.getCursorPos();let h=0;for(let c=0;c<s;c++,n.y+=this.charHeight){n.x=0;for(let s=0;s<i;s++,n.x+=this.charWidth){const i=this.ram[h+1],s=this.blink&&(128&i)>0,c=this.blink?a[i>>4&7]:a[i>>4];let l=a[15&i];s&&!this.cursorOn&&(l=c);const d=this.ram[h],u=r[d],b=this.drawChar(d,u,l,c,!1,h==o&&this.cursorOn);this.writePixels(e,t,b,n),h+=2}}}async loadCharSet(){await this.loadCharSetInternal(this.charset1,this.charsetFile1,this.charsetWidth,this.charsetHeight),await this.loadCharSetInternal(this.charset2,this.charsetFile2,this.charsetWidth,this.charsetHeight)}updateScreen(e,t){switch(super.updateScreen(e,t),this.mode){case qr.Text40x25:this.updateTextScreen(e,t,this.getCharset(),40,25,this.cgaColors);break;case qr.Text80x25:this.updateTextScreen(e,t,this.getCharset(),80,25,this.cgaColors);break;case qr.GraphicsLo:this.updateScreenGraphicsLo(e);break;case qr.GraphicsHi:this.updateScreenGraphicsHi(e)}}in(e){switch(e){case 977:case 979:case 981:case 983:return this.getDataRegister();case 984:return this.modeControlRegister;case 985:return this.colorSelectRegister;case 986:{0==this.horRetrace&&(this.horRetrace=2),this.horRetrace--;let e=this.calcVertRetrace()?8:0;return e+=0==this.horRetrace?0:1,255&e}}return 0}out(e,t,r){switch(e){case 976:case 978:case 980:case 982:this.setIndexRegister(t);break;case 977:case 979:case 981:case 983:this.setDataRegister(t);break;case 984:{this.modeControlRegister=255&t,this.blink=(32&t)>0,this.blackWhite=(4&t)>0;const e=this.mode;switch(27&t){case 8:this.mode=qr.Text40x25,this.screenWidth=320,this.screenHeight=200;break;case 9:this.mode=qr.Text80x25,this.screenWidth=640,this.screenHeight=200;break;case 10:this.mode=qr.GraphicsLo,this.screenWidth=320,this.screenHeight=200;break;case 26:this.mode=qr.GraphicsHi,this.screenWidth=640,this.screenHeight=200}this.mode!=e&&this.modeChanged()}break;case 985:this.colorSelectRegister=255&t}}}!function(e){e[e.Unmodified=0]="Unmodified",e[e.And=1]="And",e[e.Or=2]="Or",e[e.Xor=3]="Xor"}(Kr||(Kr={}));class Di extends Bi{getAllowSwitchCharSets(){return this.characterMapA!=this.characterMapB}getCrtStartAddr(){return(this.crtRegisters[12]<<8)+this.crtRegisters[13]}getUnderlineLocation(){return 31&this.crtRegisters[20]}getMaximumCharScanLine(){return 31&this.crtRegisters[9]}getCrtOffset(){return this.crtRegisters[19]}getPresetRowScan(){return this.crtRegisters[8]}getHorizontalPixelPanning(){return 15&this.attributeRegisters[19]}getEnableLineGraphicsCharacterCode(){return(4&this.attributeRegisters[16])>0}constructor(){super(),Object.defineProperty(this,"planeCount",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"planes",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.planeCount)}),Object.defineProperty(this,"latches",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.planeCount)}),Object.defineProperty(this,"mapMask",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.planeCount)}),Object.defineProperty(this,"enableSetReset",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.planeCount)}),Object.defineProperty(this,"setReset",{enumerable:!0,configurable:!0,writable:!0,value:new Array(this.planeCount)}),Object.defineProperty(this,"modeControlRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"colorSelectRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"miscOutputRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sequencerIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sequencerRegisters",{enumerable:!0,configurable:!0,writable:!0,value:new Array(5)}),Object.defineProperty(this,"gdcIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"gdcRegisters",{enumerable:!0,configurable:!0,writable:!0,value:new Array(9)}),Object.defineProperty(this,"attributeFlipFlop",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"attributeIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attributeRegisters",{enumerable:!0,configurable:!0,writable:!0,value:new Array(21)}),Object.defineProperty(this,"graphicsMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"colorPlaneEnabled",{enumerable:!0,configurable:!0,writable:!0,value:new Array(4)}),Object.defineProperty(this,"readMapSelect",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"rotateCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"bitMask",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"oddEven",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"colorDontCare",{enumerable:!0,configurable:!0,writable:!0,value:new Array(4)}),Object.defineProperty(this,"mapMaskRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"colorCompareRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"featureControlRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"gdcGraphicsMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"monochrome",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"overscanColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"memoryModeRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"characterMapSelectRegister",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"characterMapA",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"characterMapB",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"clockMode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"currentDataFunction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writeMode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"readMode",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"chain4",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"egaPalette",{enumerable:!0,configurable:!0,writable:!0,value:new Array(16)}),Object.defineProperty(this,"cgaPalette",{enumerable:!0,configurable:!0,writable:!0,value:new Array(16)}),Object.defineProperty(this,"memStart",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"memSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"crtBasePort",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"charBoxWidth",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.startAddr=655360,this.setRamSize(262144),this.memStart=720896,this.memSize=65536,this.crtBasePort=976,this.miscOutputRegister=3,this.bitMask=255;for(let e=0;e<16;e++)this.egaPalette[e]=this.cgaColors[e],this.cgaPalette[e]=this.cgaColors[e];for(let e=0;e<this.planeCount;e++)this.planes[e]=new Uint8Array(65536),this.mapMask[e]=!0}fillIgnoredFields(){super.fillIgnoredFields(),this.ignoredFields.add("planes")}getMemoryData(){const e=new Array(this.planeCount);for(let t=0;t<this.planeCount;t++)e[t]=this.planes[t].buffer;return e}updateMemory(e){for(let t=0;t<this.planeCount;t++)this.planes[t]=new Uint8Array(e[t])}in(e){if(e==this.crtBasePort+5)return this.getDataRegister();switch(e){case 984:return this.modeControlRegister;case 985:return this.colorSelectRegister}return 65535}out(e,t,r){if(e==this.crtBasePort+4)return this.setIndexRegister(255&t),void(r&&this.out(981,t>>8,!1));if(e!=this.crtBasePort+5)if(e!=this.crtBasePort+10)switch(e){case 962:this.miscOutputRegister=255&t,this.crtBasePort=0==(1&t)?944:976;break;case 964:this.sequencerIndex=7&t,r&&this.out(965,t>>8&255,!1);break;case 974:this.gdcIndex=15&t,r&&this.out(975,t>>8,!1);break;case 975:switch(this.gdcIndex){case 0:this.setReset[0]=(1&t)>0,this.setReset[1]=(2&t)>0,this.setReset[2]=(4&t)>0,this.setReset[3]=(8&t)>0;break;case 1:this.enableSetReset[0]=(1&t)>0,this.enableSetReset[1]=(2&t)>0,this.enableSetReset[2]=(4&t)>0,this.enableSetReset[3]=(8&t)>0;break;case 2:this.colorCompareRegister=255&t;break;case 3:switch(this.rotateCount=7&t,t>>3&3){case 0:this.currentDataFunction=Kr.Unmodified;break;case 1:this.currentDataFunction=Kr.And;break;case 2:this.currentDataFunction=Kr.Or;break;case 3:this.currentDataFunction=Kr.Xor}break;case 4:this.readMapSelect=3&t;break;case 5:this.writeMode=3&t,this.readMode=t>>3&1;break;case 6:switch(this.gdcGraphicsMode=(1&t)>0,t>>2&3){case 0:this.memStart=655360,this.memSize=131072;break;case 1:this.memStart=655360,this.memSize=65536;break;case 2:this.memStart=720896,this.memSize=32768;break;case 3:this.memStart=753664,this.memSize=32768}break;case 7:for(let e=0;e<this.planeCount;e++)this.colorDontCare[e]=(t&1<<e)>0;break;case 8:this.bitMask=t}this.gdcIndex<this.gdcRegisters.length&&(this.gdcRegisters[this.gdcIndex]=255&t);break;case 984:this.modeControlRegister=255&t;break;case 985:this.colorSelectRegister=255&t}else this.featureControlRegister=255&t;else this.setDataRegister(255&t)}peek(e){if(e<this.memStart||e>=this.memStart+this.memSize)return 0;let t=e-this.memStart;if(this.chain4)return this.planes[3&t][t>>2];const r=0==(1&t);this.oddEven&&(t>>=1);for(let e=0;e<this.planeCount;e++)this.latches[e]=this.planes[e][t];if(0==this.readMode)return this.oddEven?r?this.planes[0][t]:this.planes[1][t]:this.planes[this.readMapSelect][t];{const e=15&this.colorCompareRegister;let r=255;for(let i=0;i<this.planeCount;i++){if(!this.colorDontCare[i])continue;const s=this.planes[i][t],a=(e&1<<i)>0;let n=1;for(let e=0;e<8;e++)(s&n)>0!=a&&(r&=~n),n<<=1}return 255&r}}poke(e,t){if(e<this.memStart||e>=this.memStart+this.memSize)return;let r=e-this.memStart;if(this.chain4)return void(this.planes[3&r][r>>2]=t);const i=0==(1&r);this.oddEven&&(r>>=1),this.internalPoke(t,i,r)}internalPoke(e,t,r){if(0==this.writeMode){let i=e;this.rotateCount>0&&(i=255&(i>>this.rotateCount|i<<8-this.rotateCount));for(let e=0;e<this.planeCount;e++){if(!this.mapMask[e])continue;if(this.oddEven&&(t&&0!=e&&2!=e||!t&&1!=e&&3!=e))continue;const s=this.latches[e];let a=this.enableSetReset[e]?this.setReset[e]?255:0:i;switch(this.currentDataFunction){case Kr.And:a&=s;break;case Kr.Or:a|=s;break;case Kr.Xor:a^=s}this.planes[e][r]=255&(a&this.bitMask|s&~this.bitMask)}}else if(1==this.writeMode)for(let e=0;e<this.planeCount;e++)this.planes[e][r]=this.latches[e];else if(2==this.writeMode)for(let i=0;i<this.planeCount;i++){if(!this.mapMask[i])continue;if(this.oddEven&&(t&&0!=i&&2!=i||!t&&1!=i&&3!=i))continue;const s=this.latches[i];let a=(e&1<<i)>0?255:0;switch(this.currentDataFunction){case Kr.And:a&=s;break;case Kr.Or:a|=s;break;case Kr.Xor:a^=s}this.planes[i][r]=255&(a&this.bitMask|s&~this.bitMask)}}waitForScreenDraw(){if(0==this.screenUpdateClocks)return;const e=this.horAreaEndClocks-this.horAreaStartClocks;this.eventTimer.clockCount%this.screenUpdateClocks>=this.horAreaStartClocks&&Math.trunc(this.horAreaStartClocks+e/2)}calcRetraceEnable(){if(0==this.screenUpdateClocks)return{vertRetrace:!1,enable:!1};const e=this.eventTimer.clockCount%this.screenUpdateClocks,t=e<this.vertRetraceClocks;let r=!1;return e>=this.horAreaStartClocks&&e<this.horAreaEndClocks&&(r=(e-this.horAreaStartClocks)%this.lineClocks<this.horRetraceClocks),{vertRetrace:t,enable:r||t&&e>this.horRetraceClocks}}genColor(e){const t=((4&e)>0?170:0)+((32&e)>0?85:0),r=((2&e)>0?170:0)+((16&e)>0?85:0),i=((1&e)>0?170:0)+((8&e)>0?85:0);return Ri.fromRgb(t,r,i)}genCgaColor(e){return this.cgaColors[(7&e)+((16&e)>0?8:0)]}updateTextScreen(e,t,r){this.charHeight=this.getMaximumCharScanLine()+1;const i=Math.trunc(this.colCount/this.charBoxWidth),s=Math.trunc(this.lineCount/this.charHeight),a=new Array(s*i);this.internalUpdateTextScreen(a,0,s,i,r);let n=0;for(let r=0;r<s;r++)for(let s=0;s<i;s++){const i=a[n],o=new Oi(s*this.charBoxWidth,r*this.charHeight,this.charBoxWidth,this.charHeight);this.writePixels(e,t,i,o),n++}}internalUpdateTextScreen(e,t,r,i,s){let a=this.getCrtStartAddr()+t*i,n=t*i;const o=this.getAllowSwitchCharSets(),h=this.charBoxWidth>this.charWidth,c=8192*this.characterMapA,l=8192*this.characterMapB;let d=0;for(let u=t;u<t+r;u++)for(let t=0;t<i;t++){const t=this.planes[1][a];let r;o?(d=(8&t)>0?c:l,r=s[7&t]):r=s[15&t];const i=this.blink&&(128&t)>0,u=this.blink?s[t>>4&7]:s[t>>4];i&&!this.cursorOn&&(r=u),e[n]=this.drawEgaVgaChar(this.planes[0][a],r,u,d,!1,a==this.getCursorPos()&&this.cursorOn,h),a++,n++}}drawEgaVgaChar(e,t,r,i,s,a,n){const o=new Uint32Array(this.charBoxWidth*this.charHeight);let h=0,c=!1;const l=this.planes[2],d=i+(e<<5),u=e>=192&&e<=223&&this.getEnableLineGraphicsCharacterCode();let b=Ri.fromRgb(0,0,0);for(let e=0;e<this.charHeight;e++){const i=l[d+e];let m=128;const g=this.getCursorStart(),f=this.getCursorEnd();if(a&&g<this.charHeight&&f<this.charHeight){const t=0==f?this.charHeight-1:f;c=e>=g&&e<=t}const p=s&&e==this.getUnderlineLocation()||c;for(let e=0;e<this.charWidth;e++)b=p||(i&m)>0?t:r,m>>=1,o[h++]=b.value;n&&(o[h++]=u?b.value:r.value)}return o}updateScreenCgaLo(e){const t=this.getCgaGraphicsColors(this.colorSelectRegister),r=new Uint32Array(e.buffer);let i=0,s=0,a=8192;for(let e=0;e<200;e++){let n=0==(1&e)?s:a;for(let e=0;e<320;e+=4){const e=0==(1&n)?this.planes[0][n>>1]:this.planes[1][n>>1];let s;s=t[e>>6],r[i++]=s.value,s=t[e>>4&3],r[i++]=s.value,s=t[e>>2&3],r[i++]=s.value,s=t[3&e],r[i++]=s.value,n++}e%2==0?s=n:a=n}}updateScreenCgaMono(e,t,r){const i=Ri.fromRgb(255,255,255),s=this.overscanColor,a=new Uint32Array(e.buffer);let n=0,o=0,h=8192;for(let e=0;e<r;e++){let r=0==(1&e)?o:h;for(let e=0;e<t;e+=8){let e=this.planes[0][r];for(let t=0;t<8;t++)a[n++]=(128&e)>0?i.value:s.value,e<<=1;r++}e%2==0?o=r:h=r}}updateScreen16Col(e,t,r,i){const s=new Uint32Array(e.buffer),a=0==this.getCrtOffset()?t/8:this.getCrtOffset()<<1;let n=this.getCrtStartAddr(),o=0;const h=this.getHorizontalPixelPanning(),c=0==h?t:t+8;for(let e=0;e<r;e++){let e=n;for(let t=0;t<c;t+=8,e++){const r=65535&e;let a=this.planes[0][r],n=this.planes[1][r],l=this.planes[2][r],d=this.planes[3][r];for(let e=0;e<8;e++){const r=i[((128&a)>>7)+((128&n)>>6)+((128&l)>>5)+((128&d)>>4)];(0==h||t+e>=h&&t+e<c-8+h)&&(s[o++]=r.value),a<<=1,n<<=1,l<<=1,d<<=1}}n+=a}}}!function(e){e[e.None=0]="None",e[e.M00_CGA=1]="M00_CGA",e[e.M00_EGA=2]="M00_EGA",e[e.M02_CGA=3]="M02_CGA",e[e.M02_EGA=4]="M02_EGA",e[e.M04=5]="M04",e[e.M06=6]="M06",e[e.M07=7]="M07",e[e.M0D=8]="M0D",e[e.M0E=9]="M0E",e[e.M0F=10]="M0F",e[e.M10=11]="M10"}(Qr||(Qr={}));class ji extends Di{constructor(){super(),Object.defineProperty(this,"diagnosticCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"egaSwitches",{enumerable:!0,configurable:!0,writable:!0,value:[!1,!0,!0,!1]}),Object.defineProperty(this,"charWidth9Bits",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:Qr.None}),this.screenWidth=640,this.screenHeight=350,this.charBoxWidth=this.charWidth=8}fillIgnoredFields(){super.fillIgnoredFields(),this.ignoredFields.add("egaSwitches")}in(e){switch(e){case 962:{let e=this.calcVertRetrace()?0:128;const t=this.miscOutputRegister>>2&3;return e+=this.egaSwitches[t]?0:16,e+=0,255&e}case 968:return 0;case 986:{this.attributeFlipFlop=!1;const e=this.calcRetraceEnable();let t=(e.vertRetrace?8:0)+(e.enable?0:1);return 4==++this.diagnosticCount&&(this.diagnosticCount=0),t+=this.diagnosticCount>1?48:0,255&t}default:return super.in(e)}}out(e,t,r){switch(e){case 960:if(this.attributeFlipFlop){if(this.attributeIndex<this.attributeRegisters.length)switch(this.attributeRegisters[this.attributeIndex]=255&t,this.attributeIndex){case 16:this.graphicsMode=(1&t)>0,this.monochrome=(2&t)>0,this.charWidth9Bits=(4&t)>0,this.blink=(8&t)>0;break;case 17:this.overscanColor=this.genColor(255&t);break;case 18:for(let e=0;e<this.colorPlaneEnabled.length;e++)this.colorPlaneEnabled[e]=(t&1<<e)>0;break;default:this.attributeIndex>=0&&this.attributeIndex<=15&&(this.egaPalette[this.attributeIndex]=this.genColor(255&t),this.cgaPalette[this.attributeIndex]=this.genCgaColor(255&t))}this.attributeFlipFlop=!this.attributeFlipFlop}else this.attributeIndex=31&t,this.attributeFlipFlop=!this.attributeFlipFlop,r&&this.out(e,t>>8,!1);break;case 965:switch(this.sequencerIndex){case 0:break;case 1:this.clockMode=255&t;break;case 2:this.mapMaskRegister=255&t,this.mapMask[0]=(1&t)>0,this.mapMask[1]=(2&t)>0,this.mapMask[2]=(4&t)>0,this.mapMask[3]=(8&t)>0;break;case 3:this.characterMapSelectRegister=255&t,this.characterMapA=t>>2&3,this.characterMapB=3&t;break;case 4:this.memoryModeRegister=255&t,this.oddEven=0==(4&t)}this.sequencerIndex<this.sequencerRegisters.length&&(this.sequencerRegisters[this.sequencerIndex]=255&t);break;case 970:case 972:break;default:super.out(e,t,r)}}calcMode(){const e=this.mode,t=this.sequencerRegisters[1],r=this.sequencerRegisters[2],i=this.sequencerRegisters[4];11==t&&3==i?(35==this.miscOutputRegister&&(this.mode=Qr.M00_CGA),167==this.miscOutputRegister&&(this.mode=Qr.M00_EGA)):1==t&&3==i?(35==this.miscOutputRegister&&(this.mode=Qr.M02_CGA),167==this.miscOutputRegister&&(this.mode=Qr.M02_EGA)):11==t&&2==i?this.mode=Qr.M04:1==t&&6==i?35==this.miscOutputRegister?1==r?this.mode=Qr.M06:15==r&&(this.mode=Qr.M0E):162==this.miscOutputRegister?this.mode=Qr.M0F:167==this.miscOutputRegister&&(this.mode=Qr.M10):0==t&&3==i?this.mode=Qr.M07:1==t&&6==i?this.mode=Qr.M04:11==t&&6==i&&(this.mode=Qr.M0D),this.mode!=e&&this.modeChanged()}getCgaGraphicsColors(e){return this.cgaPalette}modeChanged(){super.modeChanged(),0==(this.miscOutputRegister>>2&3)?this.lineCount=200:this.lineCount=350,(8&this.clockMode)>0?this.colCount=320:this.colCount=640,this.calcRetraceValues()}updateDimensions(){switch(this.calcMode(),this.mode){case Qr.M00_CGA:this.screenWidth=320,this.screenHeight=200;break;case Qr.M00_EGA:this.screenWidth=320,this.screenHeight=350;break;case Qr.M02_CGA:this.screenWidth=640,this.screenHeight=200;break;case Qr.M02_EGA:this.screenWidth=640,this.screenHeight=350;break;case Qr.M04:this.screenWidth=320,this.screenHeight=200;break;case Qr.M06:this.screenWidth=640,this.screenHeight=200;break;case Qr.M07:this.screenWidth=720,this.screenHeight=350;break;case Qr.M0D:this.screenWidth=320,this.screenHeight=200;break;case Qr.M0E:this.screenWidth=640,this.screenHeight=200;break;case Qr.M0F:case Qr.M10:this.screenWidth=640,this.screenHeight=350}}updateScreen(e,t){switch(super.updateScreen(e,t),k.noScreenUpdateWhileRetrace&&this.waitForScreenDraw(),this.mode){case Qr.M00_CGA:case Qr.M00_EGA:case Qr.M02_CGA:case Qr.M02_EGA:this.updateTextScreen(e,t,this.egaPalette);break;case Qr.M04:this.updateScreenCgaLo(e);break;case Qr.M06:this.updateScreenCgaMono(e,640,200);break;case Qr.M07:break;case Qr.M0D:this.updateScreen16Col(e,320,200,this.cgaPalette);break;case Qr.M0E:this.updateScreen16Col(e,640,200,this.cgaPalette);break;case Qr.M0F:break;case Qr.M10:this.updateScreen16Col(e,640,350,this.egaPalette)}}}!function(e){e[e.None=0]="None",e[e.M01_CGA=1]="M01_CGA",e[e.M01_EGA=2]="M01_EGA",e[e.M01_VGA=3]="M01_VGA",e[e.M03_CGA=4]="M03_CGA",e[e.M03_EGA=5]="M03_EGA",e[e.M03_VGA=6]="M03_VGA",e[e.M04=7]="M04",e[e.M06=8]="M06",e[e.M07_EGA=9]="M07_EGA",e[e.M07_VGA=10]="M07_VGA",e[e.M0D=11]="M0D",e[e.M0E=12]="M0E",e[e.M0F=13]="M0F",e[e.M10=14]="M10",e[e.M11=15]="M11",e[e.M12=16]="M12",e[e.M13=17]="M13",e[e.MX_320x240=18]="MX_320x240"}(Yr||(Yr={})),function(e){e[e.Read=0]="Read",e[e.Write=1]="Write"}(ei||(ei={}));class Mi extends Di{getModeC256(){return(64&this.gdcRegisters[5])>0}getNineDotMode(){return 0==(1&this.sequencerRegisters[1])}getAllowSwitchCharSets(){return this.characterMapA!=this.characterMapB&&(2&this.sequencerRegisters[4])>0}constructor(){super(),Object.defineProperty(this,"vgaSwitches",{enumerable:!0,configurable:!0,writable:!0,value:[!1,!0,!0,!1]}),Object.defineProperty(this,"paletteRam",{enumerable:!0,configurable:!0,writable:!0,value:new Array(16)}),Object.defineProperty(this,"dacMask",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"videoSubsystemEnableRegister1",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"videoSubsystemEnableRegister2",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dacEntries",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256)}),Object.defineProperty(this,"dacWriteColIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dacReadColIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dacMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dacMemR",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dacMemG",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"charWidth9Bits",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:Yr.None}),this.charBoxWidth=this.charWidth=8,this.colCount=this.screenWidth=640,this.lineCount=this.screenHeight=480,this.dacMask=255,this.sequencerRegisters[4]=2,this.calcRetraceValues()}fillIgnoredFields(){super.fillIgnoredFields(),this.ignoredFields.add("vgaSwitches"),this.ignoredFields.add("egaPalette"),this.ignoredFields.add("cgaPalette")}in(e){if(e==this.crtBasePort+10){this.attributeFlipFlop=!1;const e=this.calcRetraceEnable();return 255&(e.vertRetrace?8:0)+(e.enable?0:1)}switch(e){case 962:{let e=this.calcVertRetrace()?0:128;const t=this.miscOutputRegister>>2&3;return e+=this.vgaSwitches[t]?0:16,255&e}case 963:return this.videoSubsystemEnableRegister1;case 964:return 65535&this.sequencerIndex;case 965:return this.sequencerIndex<this.sequencerRegisters.length?this.sequencerRegisters[this.sequencerIndex]:0;case 966:return this.dacMask;case 967:return 65535&(this.dacMode==ei.Read?0:3);case 969:{if(this.dacMode!=ei.Read)return 0;const e=Math.trunc(this.dacReadColIndex/3);let t=0;switch(this.dacReadColIndex%3){case 0:t=this.dacEntries[e].r;break;case 1:t=this.dacEntries[e].g;break;case 2:t=this.dacEntries[e].b}return 768==++this.dacReadColIndex&&(this.dacReadColIndex=0),t>>2&65535}case 970:return this.featureControlRegister;case 972:return 207&this.miscOutputRegister;case 974:return 65535&this.gdcIndex;case 975:return 65535&(this.gdcIndex<this.gdcRegisters.length?this.gdcRegisters[this.gdcIndex]:0);case 18152:return this.videoSubsystemEnableRegister2}return super.in(e)}out(e,t,r){switch(e){case 960:if(this.attributeFlipFlop){if(this.attributeIndex<this.attributeRegisters.length)switch(this.attributeRegisters[this.attributeIndex]=255&t,this.attributeIndex){case 16:this.graphicsMode=(1&t)>0,this.monochrome=(2&t)>0,this.charWidth9Bits=(4&t)>0,this.blink=(8&t)>0;break;case 17:this.overscanColor=this.genColor(255&t);break;case 18:for(let e=0;e<this.colorPlaneEnabled.length;e++)this.colorPlaneEnabled[e]=(t&1<<e)>0;break;default:this.attributeIndex<=15&&(this.paletteRam[this.attributeIndex]=63&t)}this.attributeFlipFlop=!this.attributeFlipFlop}else this.attributeIndex=31&t,this.attributeFlipFlop=!this.attributeFlipFlop,r&&this.out(e,t>>8&65535,!1);break;case 963:this.videoSubsystemEnableRegister1=255&t;break;case 965:switch(this.sequencerIndex){case 0:break;case 1:this.clockMode=255&t;break;case 2:this.mapMaskRegister=255&t,this.mapMask[0]=(1&t)>0,this.mapMask[1]=(2&t)>0,this.mapMask[2]=(4&t)>0,this.mapMask[3]=(8&t)>0;break;case 3:this.characterMapSelectRegister=255&t,this.characterMapA=((32&t)>>5)+(t>>1&6),this.characterMapB=((16&t)>>4)+(t<<1&6);break;case 4:t|=2,this.memoryModeRegister=255&t,this.oddEven=0==(4&t),this.chain4=(8&t)>0}this.sequencerIndex<this.sequencerRegisters.length&&(this.sequencerRegisters[this.sequencerIndex]=255&t);break;case 966:this.dacMask=255&t;break;case 967:this.dacReadColIndex=3*(255&t),this.dacMode=ei.Read;break;case 968:this.dacWriteColIndex=3*(255&t),this.dacMode=ei.Write;break;case 969:{if(this.dacMode!=ei.Write)return;const e=Math.trunc(this.dacWriteColIndex/3),r=t<<2&255;switch(this.dacWriteColIndex%3){case 0:this.dacMemR=r;break;case 1:this.dacMemG=r;break;case 2:this.dacEntries[e]=Ri.fromRgb(this.dacMemR,this.dacMemG,r)}768==++this.dacWriteColIndex&&(this.dacWriteColIndex=0);break}case 18152:this.videoSubsystemEnableRegister2=255&t;break;default:super.out(e,t,r)}}internalPoke(e,t,r){3==this.writeMode||super.internalPoke(e,t,r)}setDataRegister(e){(0==(128&this.crtRegisters[17])||this.crtIndexReg>7)&&super.setDataRegister(e)}GetDataRegister(){return this.crtIndexReg<this.crtRegisters.length?this.crtRegisters[this.crtIndexReg]:0}calcMode(){const e=this.mode,t=254&this.sequencerRegisters[1],r=this.sequencerRegisters[2],i=this.sequencerRegisters[4],s=204&this.miscOutputRegister,a=this.crtRegisters[23];this.getModeC256()?this.mode=Yr.M13:8==t&&3==i?64==s?this.mode=Yr.M01_CGA:128==s?this.mode=Yr.M01_EGA:68==s&&(this.mode=Yr.M01_VGA):0==t&&3==i?64==s?this.mode=Yr.M03_CGA:128==s?this.mode=Yr.M03_EGA:68==s&&(this.mode=Yr.M03_VGA):8==t&&2==i?this.mode=Yr.M04:0==t&&6==i?64==s?1==r?this.mode=Yr.M06:15==r&&(this.mode=Yr.M0E):128==s?this.mode=Yr.M10:192==s&&(195==a?this.mode=Yr.M11:227==a&&(this.mode=Yr.M12)):0==t&&3==i?this.mode=this.getNineDotMode()?Yr.M07_VGA:Yr.M07_EGA:8==t&&6==i&&(this.mode=Yr.M0D),this.mode!=e&&this.modeChanged()}getCgaGraphicsColors(e){let t=new Array(4);for(var r=0;r<4;r++)t[r]=this.dacEntries[r];return t}modeChanged(){switch(super.modeChanged(),this.miscOutputRegister>>6&3){case 1:this.lineCount=400;break;case 2:this.lineCount=350;break;case 3:this.lineCount=480}const e=0==(this.miscOutputRegister>>2&3)?640:720;(8&this.clockMode)>0?this.colCount=e>>1:this.colCount=e,this.calcRetraceValues()}gen16ColPalette(){const e=(128&this.attributeRegisters[16])>0,t=this.attributeRegisters[20],r=new Array(16);for(let i=0;i<16;i++){const s=63&this.paletteRam[i],a=e?15&s|(15&t)<<4:s|(12&t)<<4;r[i]=this.dacEntries[a&this.dacMask]}return r}updateDimensions(){switch(this.calcMode(),this.mode){case Yr.M01_CGA:this.screenWidth=320,this.screenHeight=200;break;case Yr.M01_EGA:this.screenWidth=320,this.screenHeight=350;break;case Yr.M01_VGA:this.screenWidth=360,this.screenHeight=400;break;case Yr.M03_CGA:this.screenWidth=640,this.screenHeight=200;break;case Yr.M03_EGA:this.screenWidth=640,this.screenHeight=350;break;case Yr.M03_VGA:this.screenWidth=720,this.screenHeight=400;break;case Yr.M04:this.screenWidth=320,this.screenHeight=200;break;case Yr.M06:this.screenWidth=640,this.screenHeight=200;break;case Yr.M07_EGA:this.screenWidth=720,this.screenHeight=350;break;case Yr.M07_VGA:this.screenWidth=720,this.screenHeight=400;break;case Yr.M0D:this.screenWidth=320,this.screenHeight=200;break;case Yr.M0E:this.screenWidth=640,this.screenHeight=200;break;case Yr.M0F:case Yr.M10:this.screenWidth=640,this.screenHeight=350;break;case Yr.M11:case Yr.M12:this.screenWidth=640,this.screenHeight=480;break;case Yr.M13:this.screenWidth=320,this.screenHeight=200;break;case Yr.MX_320x240:this.screenWidth=320,this.screenHeight=240}}updateScreen(e,t){switch(super.updateScreen(e,t),k.noScreenUpdateWhileRetrace&&this.waitForScreenDraw(),this.charBoxWidth=this.getNineDotMode()?9:8,this.mode){case Yr.M01_CGA:case Yr.M01_EGA:case Yr.M01_VGA:case Yr.M03_CGA:case Yr.M03_EGA:case Yr.M03_VGA:this.updateTextScreen(e,t,this.egaPalette);break;case Yr.M04:this.updateScreenCgaLo(e);break;case Yr.M06:this.screenWidth=640,this.screenHeight=200,this.updateScreenCgaMono(e,640,200);break;case Yr.M07_EGA:this.screenWidth=720,this.screenHeight=350;break;case Yr.M07_VGA:this.screenWidth=720,this.screenHeight=400;break;case Yr.M0D:this.screenWidth=320,this.screenHeight=200,this.updateScreen16Col(e,320,200,this.cgaPalette);break;case Yr.M0E:this.screenWidth=640,this.screenHeight=200,this.updateScreen16Col(e,640,200,this.cgaPalette);break;case Yr.M0F:this.screenWidth=640,this.screenHeight=350;break;case Yr.M10:this.screenWidth=640,this.screenHeight=350,this.updateScreen16Col(e,640,350,this.gen16ColPalette());break;case Yr.M11:this.screenWidth=640,this.screenHeight=480,this.updateScreenVgaMono(e,640,480);break;case Yr.M12:this.screenWidth=640,this.screenHeight=480,this.updateScreen16Col(e,640,480,this.gen16ColPalette());break;case Yr.M13:this.screenWidth=320,this.screenHeight=200,this.updateScreen256ColChain4(e,320,200);break;case Yr.MX_320x240:this.screenWidth=640,this.screenHeight=480}}updateScreen256ColChain4(e,t,r){const i=new Uint32Array(e.buffer),s=this.dacEntries,a=0==this.getCrtOffset()?Math.trunc(t/4):this.getCrtOffset()<<1;let n=this.getCrtStartAddr(),o=0;const h=this.getHorizontalPixelPanning(),c=0==h?t:t+4;for(let e=0;e<r;e++){let e=65535&n;for(let t=0;t<c;t+=4,e++)for(let r=0;r<4;r++)(0==h||t+r>=h&&t+r<c-8+h)&&(i[o++]=s[this.planes[r][e]].value);n+=a}}updateScreenVgaMono(e,t,r){const i=new Uint32Array(e.buffer),s=Ri.fromRgb(255,255,255),a=this.overscanColor;let n=0,o=0;for(let e=0;e<r;e++)for(let e=0;e<t;e+=8){let e=this.planes[0][n];for(let t=0;t<8;t++)i[o++]=(128&e)>0?s.value:a.value,e<<=1;n++}}}class xi{}Object.defineProperty(xi,"screenUpdateFreq",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(xi,"runFreq",{enumerable:!0,configurable:!0,writable:!0,value:25});class _i{getWorkLoad(){return this.cpu.workLoad}getInstCount(){return this.cpu.instCount}getCpuName(){return this.cpu.getName()}getAX(){return this.cpu.AX}getBX(){return this.cpu.BX}getCX(){return this.cpu.CX}getDX(){return this.cpu.DX}getSP(){return this.cpu.SP}getBP(){return this.cpu.BP}getSI(){return this.cpu.SI}getDI(){return this.cpu.DI}getCS(){return this.cpu.CS}getDS(){return this.cpu.DS}getES(){return this.cpu.ES}getSS(){return this.cpu.SS}getIP(){return this.cpu.IP}getFLAGS(){return this.cpu.FLAGS}getHalt(){return this.cpu.halt}getInstructionByte(){return this.cpu.getInstructionByte()}getAddressByte(){return this.cpu.getAddressByte()}getScreenWidth(){return this.graphicsCard.screenWidth}getScreenHeight(){return this.graphicsCard.screenHeight}constructor(){switch(Object.defineProperty(this,"memMapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"portMapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"components",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"cpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dmaController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyboard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"speakerController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ppi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hardDisk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"floppyDisk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"uartPort1",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"uartPort2",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mouse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"roms",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"graphicsCard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"disassembler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"soundGenerator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isRunning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.memMapper=new e(k.ramAmount),this.portMapper=new t,k.cpuType){case r.Cpu186:this.cpu=new vi(this.memMapper,this.portMapper);break;case r.Cpu386:this.cpu=new ki(this.memMapper,this.portMapper)}this.disassembler=new Si(this.cpu,this.memMapper)}updateGraphicDimensions(){this.graphicsCard?.updateDimensions()}updateScreen(e,t){this.graphicsCard?.updateScreen(e,t)}dumpMemory(e){throw new Error("Method not implemented.")}getMemByte(e){return this.memMapper.peek(e)}async prepare(){for(const e of this.roms)this.memMapper.register(e.startAddr,e.getEndAddr(),e),this.registerComponent(e);if(k.enableUma){const e=new bi(128,851968);this.memMapper.register(e.addrLo,e.addrHi,e),this.registerComponent(e)}switch(this.dmaController=new y(this.memMapper,(()=>this.timer.memRefreshActive)),this.portMapper.register(0,15,this.dmaController),this.portMapper.register(128,143,this.dmaController),this.portMapper.register(192,223,this.dmaController),this.registerComponent(this.dmaController),this.interruptController=new v,this.portMapper.register(32,33,this.interruptController),this.registerComponent(this.interruptController),k.graphicsAdapterType){case u.MDA:this.graphicsCard=new Pi,this.portMapper.register(944,959,this.graphicsCard),this.memMapper.register(720896,737279,this.graphicsCard);break;case u.CGA:this.graphicsCard=new Ii,this.portMapper.register(976,991,this.graphicsCard),this.memMapper.register(753664,770047,this.graphicsCard);break;case u.EGA:this.graphicsCard=new ji,this.portMapper.register(960,991,this.graphicsCard),this.memMapper.register(655360,786431,this.graphicsCard);break;case u.VGA:this.graphicsCard=new Mi,this.portMapper.register(944,991,this.graphicsCard),this.portMapper.register(18152,18152,this.graphicsCard),this.memMapper.register(655360,786431,this.graphicsCard)}if(this.graphicsCard.setScreenUpdateRate(xi.screenUpdateFreq),await this.graphicsCard.loadCharSet(),this.registerComponent(this.graphicsCard),this.ppi=new w(this.interruptController,(()=>this.onSpeaker())),this.portMapper.register(96,99,this.ppi),this.registerComponent(this.ppi),this.speakerController=this.ppi,this.keyboard=this.ppi,this.timer=new R(this.interruptController,(()=>this.onSpeaker())),this.portMapper.register(64,95,this.timer),this.registerComponent(this.timer),k.enableHdController&&(this.hardDisk=new ai(this.interruptController,this.dmaController),await this.hardDisk.loadImages(),this.portMapper.register(800,803,this.hardDisk),this.registerComponent(this.hardDisk)),this.floppyDisk=new ci(this.interruptController,this.dmaController),this.portMapper.register(1008,1015,this.floppyDisk),this.registerComponent(this.floppyDisk),this.mouse=new di(this.cpu),k.com1Device!=b.None&&(this.uartPort1=new li(1016,d.Serial4,this.interruptController),this.portMapper.register(1016,1023,this.uartPort1),this.registerComponent(this.uartPort1),this.connectSerialDevice(this.uartPort1,k.com1Device)),k.com2Device!=b.None&&(this.uartPort2=new li(760,d.Serial3,this.interruptController),this.portMapper.register(760,767,this.uartPort2),this.registerComponent(this.uartPort2),this.connectSerialDevice(this.uartPort2,k.com2Device)),k.enableRtc){const e=new Ai(832);this.portMapper.register(832,855,e),this.registerComponent(e)}this.memMapper.FinishRegistration()}connectSerialDevice(e,t){t==b.EmulatedMouse&&e.connect(this.mouse)}registerComponent(e){this.components.push(e),e.eventTimer=this.cpu,e.doCpuInterrupt=e=>this.cpu.doInterrupt(e)}onSpeaker(){this.soundGenerator?.setFrequency(this.speakerController.speakerEnabled?this.timer.speakerFrequency:0)}step(){this.cpu.execNextInstruction()}runClocks(e){this.cpu.execInstructions(e)}get eventTimer(){return this.cpu}async reset(){await(this.hardDisk?.saveImages()),await(this.floppyDisk?.saveImages()),this.cpu.reset();for(const e of this.components)e.reset()}async loadRom(e,t){const r=new ui(t);await r.load(e),this.roms.push(r)}async loadDiskImageFromFile(e,t){return await this.floppyDisk.loadImageFromFile(e,t)}loadDiskImageFromBuffer(e,t){this.floppyDisk.loadImageFromBuffer(e,t)}async newDiskImage(e){await this.floppyDisk.newImage(e)}getDiskImage(e){return this.floppyDisk.getDiskImage(e)}async ejectDiskImage(e){await this.floppyDisk.ejectImage(e)}runDebug(e){for(this.cpu.reset();!this.cpu.halt;)this.disassembler.doDisassemble(),e(this.disassembler.disassembledLine),this.cpu.execNextInstruction();e(""),e("finished.")}sendKey(e){this.keyboard.addScanCode(e)}screenMouseEvent(e,t,r){this.mouse?.mouseEventRel(e,t,r)}screenMouseReset(){this.mouse.resetMove()}mouseMoveDelta(e,t){this.mouse.mouseMoveDelta(e,t)}async loadIntoRam(e,t){}async loadBios(e){const t=new ui(0);await t.load(e),t.startAddr=1048576-t.size,this.roms.push(t)}async saveImages(){await this.hardDisk.saveImages(),await this.floppyDisk.saveImages()}}!function(e){e[e.Press=0]="Press",e[e.Release=1]="Release"}(ti||(ti={}));class Fi{static delay(e){return new Promise((t=>setTimeout(t,e)))}static download(e,t){const r=document.createElement("a");r.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),r.setAttribute("download",e),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}static downloadBinary(e,t){const r=new Blob([e]),i=document.createElement("a"),s=URL.createObjectURL(r);i.setAttribute("href",s),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}static getScanCode(e,t){let r=0;switch(e){case"Escape":r=1;break;case"Digit1":r=2;break;case"Digit2":r=3;break;case"Digit3":r=4;break;case"Digit4":r=5;break;case"Digit5":r=6;break;case"Digit6":r=7;break;case"Digit7":r=8;break;case"Digit8":r=9;break;case"Digit9":r=10;break;case"Digit0":r=11;break;case"Minus":r=12;break;case"Equal":r=13;break;case"Backspace":r=14;break;case"Tab":r=15;break;case"KeyQ":r=16;break;case"KeyW":r=17;break;case"KeyE":r=18;break;case"KeyR":r=19;break;case"KeyT":r=20;break;case"KeyY":r=21;break;case"KeyU":r=22;break;case"KeyI":r=23;break;case"KeyO":r=24;break;case"KeyP":r=25;break;case"BracketLeft":r=26;break;case"BracketRight":r=27;break;case"Enter":r=28;break;case"ControlRight":case"ControlLeft":r=29;break;case"KeyA":r=30;break;case"KeyS":r=31;break;case"KeyD":r=32;break;case"KeyF":r=33;break;case"KeyG":r=34;break;case"KeyH":r=35;break;case"KeyJ":r=36;break;case"KeyK":r=37;break;case"KeyL":r=38;break;case"Semicolon":r=39;break;case"Quote":r=40;break;case"Backslash":r=41;break;case"ShiftLeft":r=42;break;case"IntlBackslash":r=43;break;case"KeyZ":r=44;break;case"KeyX":r=45;break;case"KeyC":r=46;break;case"KeyV":r=47;break;case"KeyB":r=48;break;case"KeyN":r=49;break;case"KeyM":r=50;break;case"Comma":r=51;break;case"Period":r=52;break;case"Slash":r=53;break;case"ShiftRight":r=54;break;case"AltRight":case"AltLeft":r=56;break;case"Space":r=57;break;case"CapsLock":r=58;break;case"F1":r=59;break;case"F2":r=60;break;case"F3":r=61;break;case"F4":r=62;break;case"F5":r=63;break;case"F6":r=64;break;case"F7":r=65;break;case"F8":r=66;break;case"F9":r=67;break;case"F10":r=68;break;case"NumLock":r=69;break;case"PageUp":r=73;break;case"PageDown":r=81;break;case"ArrowLeft":r=75;break;case"ArrowRight":r=77;break;case"ArrowUp":r=72;break;case"ArrowDown":r=80;break;case"Home":r=71;break;case"End":r=79;break;case"Delete":r=83;break;case"Insert":r=82}return t==ti.Release&&0!=r&&(r+=128),r}static async loadFileHttp(e){return new Promise(((t,r)=>{try{const i=new XMLHttpRequest;i.responseType="text",i.open("GET",e,!0),i.onload=()=>{200==i.status&&t(i.responseText),r()},i.send()}catch(e){console.log(e),r()}}))}}class Ni{constructor(){Object.defineProperty(this,"regAx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regBx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regCx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regDx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regSp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regBp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regSi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regDi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regCs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regDs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regEs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regSs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regIp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"regFlags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instructionHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxLines",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instructionLines",{enumerable:!0,configurable:!0,writable:!0,value:new Array}),Object.defineProperty(this,"lastAddr",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.regAx=document.getElementById("AX"),this.regBx=document.getElementById("BX"),this.regCx=document.getElementById("CX"),this.regDx=document.getElementById("DX"),this.regSp=document.getElementById("SP"),this.regBp=document.getElementById("BP"),this.regSi=document.getElementById("SI"),this.regDi=document.getElementById("DI"),this.regCs=document.getElementById("CS"),this.regDs=document.getElementById("DS"),this.regEs=document.getElementById("ES"),this.regSs=document.getElementById("SS"),this.regIp=document.getElementById("IP"),this.regFlags=document.getElementById("FLAGS"),this.instructionHistory=document.getElementById("instruction-history"),this.maxLines=100}showRegisters(e){this.regAx.innerHTML=e.getAX().toString(16).padStart(4,"0").toUpperCase(),this.regBx.innerHTML=e.getBX().toString(16).padStart(4,"0").toUpperCase(),this.regCx.innerHTML=e.getCX().toString(16).padStart(4,"0").toUpperCase(),this.regDx.innerHTML=e.getDX().toString(16).padStart(4,"0").toUpperCase(),this.regSp.innerHTML=e.getSP().toString(16).padStart(4,"0").toUpperCase(),this.regBp.innerHTML=e.getBP().toString(16).padStart(4,"0").toUpperCase(),this.regSi.innerHTML=e.getSI().toString(16).padStart(4,"0").toUpperCase(),this.regDi.innerHTML=e.getDI().toString(16).padStart(4,"0").toUpperCase(),this.regCs.innerHTML=e.getCS().toString(16).padStart(4,"0").toUpperCase(),this.regDs.innerHTML=e.getDS().toString(16).padStart(4,"0").toUpperCase(),this.regEs.innerHTML=e.getES().toString(16).padStart(4,"0").toUpperCase(),this.regSs.innerHTML=e.getSS().toString(16).padStart(4,"0").toUpperCase(),this.regIp.innerHTML=e.getIP().toString(16).padStart(4,"0").toUpperCase(),this.regFlags.innerHTML=e.getFLAGS().toString(2).padStart(16,"0").toUpperCase()}disassembleSingle(e){e.disassembler.doDisassemble();const t=e.disassembler.disassembledLine,r=document.createElement("pre");r.innerHTML=t,this.instructionHistory.appendChild(r),this.instructionHistory.childNodes.length>=this.maxLines&&this.instructionHistory.removeChild(this.instructionHistory.childNodes[0]),this.instructionHistory.scrollTop=this.instructionHistory.scrollHeight}clearInstructionHistory(){this.instructionHistory.innerHTML=""}clearInstructionBuffer(){this.instructionLines.length=0}showInstructionBuffer(){this.instructionHistory.innerHTML="";for(let e=this.instructionLines.length-this.maxLines;e<this.instructionLines.length;e++){const t=document.createElement("pre");t.innerHTML=this.instructionLines[e],this.instructionHistory.appendChild(t)}this.instructionHistory.scrollTop=this.instructionHistory.scrollHeight}addInstructionLineToBuffer(e){e.disassembler.doDisassemble();const t=(e.getCS()<<4)+e.getIP();this.lastAddr!=t&&(this.lastAddr=t,this.instructionLines.push(e.disassembler.disassembledLine)),this.instructionLines.length>this.maxLines&&this.instructionLines.shift()}downloadHistory(){const e=this.instructionLines.join("\r\n");Fi.download("instructions.txt",e)}}class Wi{constructor(){Object.defineProperty(this,"screenContainer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"screen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"imagedata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"renderingContext",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"updateFrame",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frameCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.updateFrame=60/xi.screenUpdateFreq}maybeGetHtmlComponents(){null!=this.screenContainer&&null!=this.screen||(this.screenContainer=document.getElementById("screen-container"),this.screen=document.getElementById("screen"))}updateCanvasIfNeeded(e){if((!this.canvas||this.canvas.width!=e.width||this.canvas.height!=e.height)&&0!=e.width&&0!=e.height){const t=this.screenContainer.clientWidth/e.width,r=this.screenContainer.clientHeight/e.height;this.screen.style.transform=`scaleX(${t}) scaleY(${r})`,this.screen.innerHTML="",this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.screen.appendChild(this.canvas),this.renderingContext=this.canvas.getContext("2d"),this.imagedata=this.renderingContext.createImageData(e.width,e.height)}}}class $i extends Wi{constructor(e){super(),Object.defineProperty(this,"emulator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.emulator=e}animationFrame(){if(0==this.frameCount){this.emulator.updateGraphicDimensions();const e={width:this.emulator.getScreenWidth(),height:this.emulator.getScreenHeight()};this.maybeGetHtmlComponents(),this.updateCanvasIfNeeded(e),this.renderingContext&&(this.emulator.updateScreen(this.imagedata.data,this.imagedata.width),this.renderingContext.putImageData(this.imagedata,0,0))}++this.frameCount>=this.updateFrame&&(this.frameCount=0),window.requestAnimationFrame((()=>this.animationFrame()))}}navigator.userAgent.indexOf("Firefox")>0&&(document.getElementById("main").style.width="-moz-fit-content"),new class{constructor(){Object.defineProperty(this,"runButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resetButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debugHelper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emulator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"runStep",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.runButton=document.getElementById("run-button"),this.stepButton=document.getElementById("step-button"),this.stopButton=document.getElementById("stop-button"),this.resetButton=document.getElementById("reset-button"),k.cpuType=r.Cpu186,k.ramAmount=1024,k.enableRtc=!0,k.enableUma=!0,k.hdImageDir="HdImages/",k.graphicsAdapterType=u.CGA,this.debugHelper=new Ni,this.emulator=new _i,this.runButton.addEventListener("click",(()=>this.run())),this.stepButton.addEventListener("click",(()=>this.step())),this.stopButton.addEventListener("click",(()=>this.stop())),this.resetButton.addEventListener("click",(()=>this.reset())),document.addEventListener("keydown",(e=>{if(!e.repeat)return this.emulator.sendKey(Fi.getScanCode(e.code,ti.Press)),e.preventDefault(),e.stopPropagation(),!1})),document.addEventListener("keyup",(e=>(this.emulator.sendKey(Fi.getScanCode(e.code,ti.Release)),e.preventDefault(),e.stopPropagation(),!1))),this.startEmulation()}doRun(){for(let e=0;e<2500&&this.running;e++)this.emulator.step(),this.debugHelper.addInstructionLineToBuffer(this.emulator);this.runStep++,20==this.runStep&&(this.runStep=0,this.debugHelper.showRegisters(this.emulator)),this.running?setTimeout((()=>{this.doRun()}),5):this.debugHelper.showInstructionBuffer()}async doReset(){this.debugHelper.clearInstructionHistory(),this.debugHelper.clearInstructionBuffer(),await this.emulator.reset(),this.emulator.step(),this.debugHelper.disassembleSingle(this.emulator),this.debugHelper.showRegisters(this.emulator)}async reset(){this.running=!1,setTimeout(this.doReset,20)}step(){this.running||(this.emulator.step(),this.debugHelper.disassembleSingle(this.emulator),this.debugHelper.showRegisters(this.emulator))}run(){this.running=!0,this.stepButton.disabled=!0,this.resetButton.disabled=!0,this.doRun()}stop(){this.running=!1,this.stepButton.disabled=!1,this.resetButton.disabled=!1}async startEmulation(){await this.emulator.loadRom("Roms/BIOS/PCXTBIOS.BIN",1040384),await this.emulator.loadRom("Roms/Harddisk/IBM_XEBEC_62X0822_1985.BIN",819200),await this.emulator.prepare(),this.debugHelper.disassembleSingle(this.emulator);const e=new $i(this.emulator);window.requestAnimationFrame((()=>e.animationFrame()))}}})();